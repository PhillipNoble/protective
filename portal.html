<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Protective Flooring Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --navy:#020A5B;--navy-dk:#010740;--navy-md:#071480;--navy-lt:rgba(2,10,91,.07);
  --gold:#C8952A;--gold-lt:#E8B84B;--gold-bg:rgba(200,149,42,.09);
  --cream:#F8F5EF;--white:#fff;--off:#FAFAF7;
  --border:#DDD9D0;--lg:#EDEBE5;--gray:#64748b;--text:#1C1C2E;
  --red:#B91C1C;--green:#15803d;
  --sw:260px;--r:3px;
  --sh:0 4px 24px rgba(2,10,91,.08);--shl:0 8px 48px rgba(2,10,91,.14);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;font-family:'Outfit',sans-serif;color:var(--text);background:var(--off);}
img{display:block;max-width:100%;}
button,input,select,textarea{font-family:'Outfit',sans-serif;cursor:pointer;}
.scr{display:none;width:100%;min-height:100vh;}
.scr.on{display:flex;}

/* LOGIN */
#sl{background:var(--navy-dk);align-items:center;justify-content:center;position:relative;overflow:hidden;}
#sl::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.02) 1px,transparent 1px);background-size:52px 52px;}
.lglow{position:absolute;width:600px;height:600px;border-radius:50%;background:radial-gradient(ellipse,rgba(200,149,42,.18),transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;}
.lbox{background:var(--white);width:440px;padding:52px 48px;position:relative;z-index:2;box-shadow:0 24px 80px rgba(0,0,0,.35);animation:ld .5s ease;}
@keyframes ld{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:none;}}
.lbox h1{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--navy);font-weight:700;margin-bottom:6px;}
.lerr{background:#fef2f2;border:1px solid #fecaca;color:var(--red);padding:12px 14px;border-radius:var(--r);font-size:13px;margin-bottom:16px;display:none;}
.sub{color:var(--gray);font-size:14px;margin-bottom:28px;font-weight:300;}
.gl{width:100%;height:1px;background:linear-gradient(90deg,var(--gold),var(--gold-lt),transparent);margin-bottom:28px;}
.fg{display:flex;flex-direction:column;gap:6px;margin-bottom:16px;}
.fg label{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--navy);}
.fg input,.fg select,.fg textarea{border:1px solid var(--border);padding:12px 14px;font-size:14px;color:var(--text);background:var(--white);border-radius:var(--r);outline:none;transition:border-color .2s,box-shadow .2s;width:100%;}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--navy);box-shadow:0 0 0 3px rgba(2,10,91,.07);}
.fg textarea{resize:vertical;min-height:88px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.btn-pri{width:100%;background:var(--navy);color:var(--white);padding:14px;border:none;border-radius:var(--r);font-size:13px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;transition:background .2s;}
.btn-pri:hover{background:var(--navy-md);}
.demo-row{display:flex;gap:10px;margin-top:12px;}
.dbtn{flex:1;padding:10px;border-radius:var(--r);font-size:12px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;border:1px solid;transition:all .2s;}
.dbtn.cl{border-color:var(--gold);color:var(--gold);background:var(--gold-bg);}
.dbtn.cl:hover{background:var(--gold);color:var(--navy);}
.dbtn.ad{border-color:var(--navy);color:var(--navy);background:var(--navy-lt);}
.dbtn.ad:hover{background:var(--navy);color:var(--white);}

/* SIDEBAR */
.sidebar{width:var(--sw);min-height:100vh;background:var(--navy-dk);display:flex;flex-direction:column;flex-shrink:0;position:fixed;top:0;left:0;bottom:0;z-index:100;}
.sidebar.adm{background:linear-gradient(180deg,#010535,#020A5B);}
.slogo{padding:28px 24px 20px;border-bottom:1px solid rgba(255,255,255,.06);}
.slogo img{height:44px;width:auto;}
.srole{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--gold);margin-top:8px;opacity:.8;}
.suser{padding:16px 24px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:12px;}
.avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold-lt));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:var(--navy);flex-shrink:0;}
.uname{color:var(--white);font-size:13px;font-weight:600;}
.uprop{color:rgba(255,255,255,.38);font-size:11px;}
.snav{flex:1;padding:16px 0;overflow-y:auto;}
.nlabel{font-size:9px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,.25);padding:12px 24px 6px;}
.ni{display:flex;align-items:center;gap:12px;padding:11px 24px;color:rgba(255,255,255,.5);font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;border-left:3px solid transparent;}
.ni:hover{color:var(--white);background:rgba(255,255,255,.05);}
.ni.on{color:var(--white);background:rgba(200,149,42,.1);border-left-color:var(--gold);}
.ni .ic{width:18px;text-align:center;font-size:15px;flex-shrink:0;}
.nb{margin-left:auto;background:var(--red);color:var(--white);font-size:10px;font-weight:700;padding:2px 7px;border-radius:99px;}
.sbot{padding:16px 24px;border-top:1px solid rgba(255,255,255,.06);}
.lo{width:100%;padding:10px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.5);border-radius:var(--r);font-size:12px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;transition:all .2s;}
.lo:hover{background:rgba(255,255,255,.1);color:var(--white);}

/* MAIN */
.main{margin-left:var(--sw);flex:1;min-height:100vh;display:flex;flex-direction:column;}
.topbar{background:var(--white);border-bottom:1px solid var(--border);padding:0 36px;height:64px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;position:sticky;top:0;z-index:50;box-shadow:0 1px 12px rgba(2,10,91,.05);}
.tbtitle{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--navy);}
.tbr{display:flex;align-items:center;gap:16px;}
.tprop{background:var(--navy-lt);border:1px solid rgba(2,10,91,.12);padding:7px 14px;border-radius:var(--r);font-size:12px;font-weight:600;color:var(--navy);}
.abadge{background:rgba(200,149,42,.15);border:1px solid rgba(200,149,42,.3);color:var(--gold);padding:5px 12px;border-radius:var(--r);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;}
.nbtn{width:36px;height:36px;border-radius:50%;background:var(--lg);border:none;font-size:16px;display:flex;align-items:center;justify-content:center;position:relative;}
.ndot{position:absolute;top:6px;right:6px;width:8px;height:8px;background:var(--red);border-radius:50%;border:2px solid var(--white);}
.content{flex:1;padding:36px;}
.panel{display:none;}
.panel.on{display:block;animation:pi .3s ease;}
@keyframes pi{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:none;}}

/* STATS */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-bottom:28px;}
.sc{background:var(--white);padding:24px;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--sh);display:flex;align-items:center;gap:16px;}
.si{width:48px;height:48px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.si.g{background:rgba(200,149,42,.1);}.si.n{background:rgba(2,10,91,.08);}.si.gr{background:#f0fdf4;}.si.rd{background:#fef2f2;}
.snum{font-family:'Cormorant Garamond',serif;font-size:34px;font-weight:700;color:var(--navy);line-height:1;}
.slbl{font-size:12px;color:var(--gray);margin-top:3px;}

/* SECTION HDR */
.shd{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px;}
.shd h2{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--navy);}

/* BUTTONS */
.bs{padding:9px 18px;border-radius:var(--r);font-size:12px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;border:none;transition:all .2s;white-space:nowrap;}
.bs.gd{background:var(--gold);color:var(--navy);}.bs.gd:hover{background:var(--gold-lt);}
.bs.nv{background:var(--navy);color:var(--white);}.bs.nv:hover{background:var(--navy-md);}
.bs.ol{background:transparent;border:1px solid var(--border);color:var(--gray);}.bs.ol:hover{border-color:var(--navy);color:var(--navy);}
.bs.dn{background:rgba(185,28,28,.06);border:1px solid rgba(185,28,28,.2);color:var(--red);}.bs.dn:hover{background:var(--red);color:var(--white);}
.bs.gn{background:#f0fdf4;border:1px solid #86efac;color:#15803d;}
.bl{padding:14px 32px;border-radius:var(--r);font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;border:none;transition:all .2s;}
.bl.gd{background:var(--gold);color:var(--navy);}.bl.gd:hover{background:var(--gold-lt);}
.bl.nv{background:var(--navy);color:var(--white);}.bl.nv:hover{background:var(--navy-md);}
.bl.ol{background:transparent;border:1px solid var(--border);color:var(--gray);}.bl.ol:hover{border-color:var(--navy);color:var(--navy);}

/* TABLE */
.tw{background:var(--white);border-radius:var(--r);border:1px solid var(--border);overflow:hidden;box-shadow:var(--sh);}
table{width:100%;border-collapse:collapse;}
thead{background:var(--cream);}
th{padding:12px 18px;text-align:left;font-size:10px;font-weight:700;letter-spacing:1.8px;text-transform:uppercase;color:var(--gray);border-bottom:1px solid var(--border);}
td{padding:14px 18px;font-size:13px;color:var(--text);border-bottom:1px solid var(--lg);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:var(--navy-lt);cursor:pointer;}

/* BADGES */
.b{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:99px;font-size:11px;font-weight:600;}
.b::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.7;}
.b.rq{background:#fffbeb;color:#b45309;border:1px solid #fde68a;}
.b.vd{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;}
.b.sc{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;}
.b.ip{background:#f0fdf4;color:#15803d;border:1px solid #86efac;}
.b.cp{background:#f0fdf4;color:#15803d;border:1px solid #86efac;}
.b.ac{background:#f0fdf4;color:#15803d;border:1px solid #86efac;}
.b.in{background:var(--lg);color:var(--gray);border:1px solid var(--border);}
.b.mp{background:rgba(2,10,91,.08);color:var(--navy);border:1px solid rgba(2,10,91,.15);}
.b.nv{background:rgba(200,149,42,.1);color:#7a5c1a;border:1px solid rgba(200,149,42,.3);}

/* CHIPS */
.chip{display:inline-block;padding:3px 10px;border-radius:99px;font-size:11px;font-weight:600;background:var(--navy-lt);color:var(--navy);border:1px solid rgba(2,10,91,.12);margin:2px;}
.chip.gd{background:var(--gold-bg);color:#7a5c1a;border-color:rgba(200,149,42,.3);}

/* FORM CARD */
.fc{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:32px;box-shadow:var(--sh);margin-bottom:24px;}
.fc h3{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:700;color:var(--navy);margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--lg);}
.fa{display:flex;gap:12px;justify-content:flex-end;margin-top:24px;padding-top:20px;border-top:1px solid var(--lg);}

/* RADIO / SCOPE */
.rg{display:flex;gap:12px;}
.ro{flex:1;border:2px solid var(--border);border-radius:var(--r);padding:14px;cursor:pointer;transition:all .2s;text-align:center;}
.ro:hover{border-color:var(--gold);}
.ro.on{border-color:var(--navy);background:var(--navy-lt);}
.ro .ri{font-size:24px;}
.ro .rl{font-size:13px;font-weight:600;color:var(--navy);margin-top:6px;}
.sg{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.so{border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;cursor:pointer;transition:all .2s;font-size:13px;color:var(--gray);display:flex;align-items:center;gap:8px;}
.so:hover{border-color:var(--gold);color:var(--navy);}
.so.on{border-color:var(--navy);background:var(--navy-lt);color:var(--navy);font-weight:600;}
.so .ck{width:16px;height:16px;border-radius:3px;border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;}
.so.on .ck{background:var(--navy);border-color:var(--navy);color:var(--white);}

/* PRESET */
.psec{background:var(--off);border:1px solid var(--border);border-radius:var(--r);padding:16px 18px;margin-bottom:16px;}
.pstitle{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--gold);margin-bottom:10px;}
.pqb{padding:9px 16px;border-radius:var(--r);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;border:2px solid var(--border);background:var(--white);color:var(--gray);}
.pqb:hover{border-color:var(--gold);color:var(--navy);}
.pqb.ap{border-color:var(--navy);background:var(--navy);color:var(--white);}
.prow{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:10px;}
.prt{display:inline-flex;align-items:center;padding:5px 12px;border-radius:99px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--lg);color:var(--gray);transition:all .2s;margin:3px;}
.prt.on{background:var(--navy);border-color:var(--navy);color:var(--white);}
.prt:hover{border-color:var(--gold);}

/* UPLOAD */
.uz{border:2px dashed var(--border);border-radius:var(--r);padding:36px;text-align:center;cursor:pointer;transition:all .2s;background:var(--off);}
.uz:hover{border-color:var(--gold);background:var(--gold-bg);}

/* FILTER */
.fb{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap;}
.sw{position:relative;flex:1;min-width:220px;}
.sw input{padding:11px 14px 11px 38px;border:1px solid var(--border);border-radius:var(--r);font-size:13px;width:100%;outline:none;background:var(--white);}
.sw input:focus{border-color:var(--navy);}
.si2{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--gray);font-size:15px;pointer-events:none;}
.fs{padding:10px 14px;border:1px solid var(--border);border-radius:var(--r);font-size:13px;color:var(--text);background:var(--white);outline:none;}

/* TABS */
.tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:24px;}
.tab{padding:10px 22px;font-size:13px;font-weight:500;color:var(--gray);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s;display:flex;align-items:center;gap:8px;}
.tab:hover{color:var(--navy);}
.tab.on{color:var(--navy);border-bottom-color:var(--gold);font-weight:700;}
.tc{background:var(--lg);color:var(--gray);font-size:10px;font-weight:700;padding:2px 7px;border-radius:99px;}
.tab.on .tc{background:var(--navy);color:var(--white);}

/* PROPERTY ROWS */
.pr{background:var(--white);border:1px solid var(--border);border-radius:var(--r);margin-bottom:10px;overflow:hidden;box-shadow:var(--sh);transition:box-shadow .2s;}
.pr:hover{box-shadow:var(--shl);}
.prh{padding:18px 22px;display:flex;align-items:center;gap:16px;cursor:pointer;transition:background .2s;}
.prh:hover{background:var(--navy-lt);}
.pre{padding:0 22px;max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s;}
.pr.op .pre{max-height:900px;padding:0 22px 22px;}
.pra{margin-left:auto;transition:transform .3s;font-size:12px;color:var(--gray);flex-shrink:0;}
.pr.op .pra{transform:rotate(180deg);}
.pname{font-family:'Cormorant Garamond',serif;font-size:17px;font-weight:700;color:var(--navy);}
.paddr{font-size:12px;color:var(--gray);margin-top:2px;}
.pmeta{display:flex;align-items:center;gap:10px;margin-left:auto;flex-shrink:0;flex-wrap:wrap;}
.pp{background:var(--lg);border:1px solid var(--border);padding:4px 12px;border-radius:99px;font-size:11px;font-weight:600;color:var(--gray);}
.fplbl{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--gold);margin:16px 0 8px;}
.fpt{width:100%;border-collapse:collapse;margin-top:4px;}
.fpt th{background:var(--cream);padding:9px 14px;text-align:left;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--gray);border-bottom:1px solid var(--border);}
.fpt td{padding:12px 14px;font-size:13px;border-bottom:1px solid var(--lg);vertical-align:middle;}
.fpt tr:last-child td{border-bottom:none;}
.fpt tr:hover td{background:var(--navy-lt);}
.fit{display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border-radius:var(--r);background:var(--lg);border:1px solid var(--border);cursor:pointer;font-size:12px;color:var(--gray);font-weight:600;transition:all .2s;white-space:nowrap;}
.fit:hover{background:var(--navy);color:var(--white);border-color:var(--navy);}
.fit.hi{background:var(--gold-bg);border-color:rgba(200,149,42,.3);color:#7a5c1a;}
.fit.hi:hover{background:var(--gold);color:var(--navy);}

/* MODAL */
.mb{display:none;position:fixed;inset:0;background:rgba(1,7,64,.6);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
.mb.op{display:flex;}
.modal{background:var(--white);width:680px;max-height:92vh;overflow-y:auto;border-radius:var(--r);box-shadow:0 24px 80px rgba(0,0,0,.3);animation:mi .25s ease;}
.modal.w{width:880px;}
@keyframes mi{from{opacity:0;transform:scale(.96);}to{opacity:1;transform:none;}}
.mh{padding:24px 28px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--white);z-index:2;}
.mh h3{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--navy);}
.mx{background:none;border:none;font-size:22px;color:var(--gray);cursor:pointer;line-height:1;}
.mx:hover{color:var(--navy);}
.mbody{padding:28px;}
.mf{padding:20px 28px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end;position:sticky;bottom:0;background:var(--white);}
.ms{background:var(--cream);border:1px solid var(--border);border-radius:var(--r);padding:20px 22px;margin-bottom:20px;}
.mst{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--gold);margin-bottom:14px;}
.di{background:var(--off);border:1px solid var(--border);padding:14px 16px;border-radius:var(--r);}
.dl{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--gold);margin-bottom:5px;}
.dv{font-size:14px;color:var(--text);font-weight:500;}

/* FP CARD IN ORDER FORM */
.fp-card{background:var(--off);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;display:flex;align-items:center;gap:14px;margin-top:10px;}
.fp-card-img{width:80px;height:60px;background:var(--lg);border-radius:2px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;overflow:hidden;}
.fp-card-img img{width:100%;height:100%;object-fit:cover;}

/* TIMELINE */
.tl{display:flex;flex-direction:column;}
.tli{display:flex;gap:16px;position:relative;}
.tli:not(:last-child)::before{content:'';position:absolute;left:15px;top:32px;bottom:-4px;width:2px;background:var(--border);}
.tld{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;border:2px solid var(--border);}
.tld.dn{background:var(--navy);border-color:var(--navy);color:var(--white);}
.tld.ac{background:var(--gold);border-color:var(--gold);color:var(--navy);}
.tld.pd{background:var(--white);color:var(--gray);}
.tlc{flex:1;padding-bottom:20px;}
.tlt{font-size:14px;font-weight:600;color:var(--navy);margin-bottom:2px;}
.tls{font-size:12px;color:var(--gray);}

/* WORK ORDER PRINT */
.wopp{background:var(--white);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shl);max-width:860px;margin:0 auto;}
.ppbar{background:var(--off);border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;border-radius:var(--r) var(--r) 0 0;}
.ppbar span{font-size:12px;color:var(--gray);}
.wod{padding:48px 56px;}
.woh{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:36px;padding-bottom:28px;border-bottom:3px solid var(--navy);}
.woh p{font-size:12px;color:var(--gray);line-height:1.7;}
.wor{text-align:right;}
.won{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:700;color:var(--navy);}
.wosec{margin-bottom:28px;}
.wosect{font-size:10px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--gold);margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--lg);}
.wog{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.wog3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
.wof{background:var(--off);border:1px solid var(--border);padding:12px 14px;border-radius:2px;}
.wofl{font-size:9px;font-weight:700;letter-spacing:1.8px;text-transform:uppercase;color:var(--gray);margin-bottom:4px;}
.wofv{font-size:14px;font-weight:600;color:var(--text);}
.woscl{display:flex;flex-wrap:wrap;gap:8px;}
.wost{background:var(--navy);color:var(--white);padding:5px 14px;border-radius:2px;font-size:12px;font-weight:600;}
.wonb{background:var(--off);border:1px solid var(--border);border-left:3px solid var(--gold);padding:16px 18px;border-radius:2px;}
.wopg{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px;}
.wopb{height:150px;background:var(--lg);border:1px solid var(--border);border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--gray);}
.wopn{background:var(--off);border:1px dashed var(--border);padding:22px;text-align:center;border-radius:2px;color:var(--gray);font-size:13px;}
.wofoot{background:var(--navy);color:rgba(255,255,255,.7);padding:16px 56px;display:flex;justify-content:space-between;font-size:11px;border-radius:0 0 var(--r) var(--r);}
.wosr{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:14px;}
.wosb{border-top:1px solid var(--border);padding-top:8px;font-size:11px;color:var(--gray);}

/* USER PROP ITEMS */
.uprop-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--border);border-radius:var(--r);cursor:pointer;transition:all .2s;background:var(--white);}
.uprop-item:hover{border-color:var(--gold);}
.uprop-item input{width:15px;height:15px;accent-color:var(--navy);flex-shrink:0;}

/* TOAST */
.toast{position:fixed;bottom:32px;right:32px;z-index:9999;background:var(--navy);color:var(--white);padding:16px 24px;border-radius:var(--r);display:flex;align-items:center;gap:12px;box-shadow:var(--shl);font-size:14px;font-weight:500;transform:translateY(80px);opacity:0;transition:all .35s ease;border-left:4px solid var(--gold);pointer-events:none;}
.toast.on{transform:none;opacity:1;}

@media print{
  body *{visibility:hidden;}
  .parea,.parea *{visibility:visible;}
  /* Escape modal overflow clipping */
  .mb,.modal,.mbody,.wopp{
    overflow:visible!important;
    max-height:none!important;
    position:static!important;
    background:transparent!important;
    box-shadow:none!important;
    border:none!important;
    padding:0!important;
    margin:0!important;
    width:auto!important;
    animation:none!important;
  }
  .mh{display:none!important;}
  .parea{position:fixed;left:0;top:0;width:100%;background:#fff!important;}
  .ppbar{display:none!important;}
  .wofoot,.wost,.woh{-webkit-print-color-adjust:exact;print-color-adjust:exact;}
  @page{margin:0.5in;}
}

/* ── CHOOSER SCREEN ── */
.sc-choice {
  display:flex;align-items:center;gap:18px;
  width:100%;padding:20px 24px;
  background:var(--cream);border:2px solid var(--border);
  border-radius:var(--r);cursor:pointer;
  font-family:var(--font);transition:all .2s;
  text-align:left;
}
.sc-choice:hover{border-color:var(--gold);background:#fffbf0;transform:translateY(-1px);box-shadow:0 6px 20px rgba(200,149,42,.12);}
.sc-choice.sc-admin{background:var(--navy);border-color:var(--navy);}
.sc-choice.sc-admin:hover{background:#071480;border-color:#071480;}
.sc-icon{font-size:24px;width:48px;height:48px;border-radius:var(--r);background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sc-choice:not(.sc-admin) .sc-icon{background:rgba(2,10,91,.08);}
.sc-title{font-size:15px;font-weight:700;color:var(--navy);letter-spacing:.3px;margin-bottom:3px;}
.sc-choice.sc-admin .sc-title{color:var(--gold);}
.sc-sub{font-size:12px;color:var(--gray);font-weight:400;line-height:1.4;}
.sc-choice.sc-admin .sc-sub{color:rgba(255,255,255,.55);}


/* ── PROPERTY CARD (dynamic) ── */
.pr-card{background:var(--white);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;overflow:hidden;transition:box-shadow .2s;}
.pr-card:hover{box-shadow:0 4px 20px rgba(2,10,91,.07);}
.pr-card.inactive-prop .pr-name{color:var(--gray);}
.pr-header{display:flex;align-items:center;gap:16px;padding:18px 20px;cursor:pointer;user-select:none;}
.pr-avatar{width:44px;height:44px;border-radius:3px;background:var(--navy);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:var(--gold);font-family:'Cormorant Garamond',serif;flex-shrink:0;}
.pr-info{flex:1;min-width:0;}
.pr-name{font-size:15px;font-weight:700;color:var(--navy);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pr-addr{font-size:12px;color:var(--gray);font-weight:300;}
.pr-contact{font-size:11px;color:var(--gray);margin-top:2px;}
.pr-contact a{color:var(--navy);opacity:.6;transition:opacity .15s;}
.pr-contact a:hover{opacity:1;}
.pr-meta{display:flex;align-items:center;gap:8px;flex-shrink:0;margin-left:auto;}
.pr-actions{display:flex;gap:6px;flex-shrink:0;margin-left:8px;}
.pr-chevron{font-size:10px;color:var(--gray);margin-left:8px;transition:transform .25s;flex-shrink:0;}
.pr-card.open .pr-chevron{transform:rotate(180deg);}
.pr-body{display:none;border-top:1px solid var(--border);padding:20px;}
.pr-card.open .pr-body{display:block;}
.pr-section-title{font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--gray);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.pr-detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.pr-detail-item label{font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--gray);display:block;margin-bottom:3px;}
.pr-detail-item span{font-size:13px;color:var(--text);}
.pr-detail-item a{color:var(--navy);font-size:13px;}

/* ── FLOOR PLAN TABLE (inside property card) ── */
.fp-table-wrap{overflow-x:auto;margin-bottom:14px;}
table.fpt{width:100%;border-collapse:collapse;font-size:13px;}
table.fpt th{background:var(--cream);padding:8px 10px;text-align:left;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--gray);border-bottom:2px solid var(--border);white-space:nowrap;}
table.fpt td{padding:9px 10px;border-bottom:1px solid var(--border);vertical-align:middle;}
table.fpt tr:last-child td{border-bottom:none;}
table.fpt tr:hover td{background:var(--cream);}
.fp-img-btn{font-size:10px;padding:3px 7px;border-radius:2px;border:1px solid;cursor:pointer;font-weight:600;letter-spacing:.3px;white-space:nowrap;}
.fp-img-btn.has-img{border-color:var(--navy);color:var(--navy);background:rgba(2,10,91,.05);}
.fp-img-btn.no-img{border-color:var(--border);color:var(--gray);background:transparent;}
.fp-img-btn:hover.has-img{background:var(--navy);color:var(--white);}

/* ── ADD PROPERTY MODAL ── */
.import-strip{display:flex;align-items:center;gap:10px;background:var(--cream);border:1px solid var(--border);border-radius:3px;padding:10px 14px;margin-bottom:16px;}
.import-label{font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--navy);white-space:nowrap;}

/* ── IMAGE SLOTS ── */
.img-slots{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
.img-slot{border:1px solid var(--border);border-radius:4px;overflow:hidden;}
.img-slot-hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--cream);border-bottom:1px solid var(--border);}
.img-slot-label{font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--navy);}
.img-slot-drop{padding:28px 16px;text-align:center;cursor:pointer;transition:background .15s;}
.img-slot-drop:hover{background:rgba(2,10,91,.04);}
.img-slot-icon{font-size:28px;opacity:.25;margin-bottom:8px;}
.img-slot-hint{font-size:12px;color:var(--gray);font-weight:300;}
.img-slot-preview{padding:10px;}
.img-slot-preview img{width:100%;height:140px;object-fit:contain;border-radius:2px;background:#f9f9f9;display:block;}
.img-slot-fname{font-size:10px;color:var(--gray);margin-top:6px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* ── SCOPE CHECKBOXES ── */
.scope-row{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:4px;margin-bottom:6px;background:var(--white);flex-wrap:wrap;}
.scope-row:hover{background:var(--cream);}
.scope-row.dragging{opacity:.4;border-style:dashed;}
.scope-row.drag-over{border-color:var(--navy);background:rgba(2,10,91,.05);}
.drag-handle{cursor:grab;color:var(--gray);font-size:16px;padding:0 4px;user-select:none;flex-shrink:0;}
.drag-handle:active{cursor:grabbing;}
.scope-edit-fields{display:none;flex:1;gap:8px;align-items:center;}
.scope-edit-fields.open{display:flex;}
.scope-edit-fields input,.scope-edit-fields select{font-size:12px;padding:4px 8px;border:1px solid var(--border);border-radius:3px;background:var(--white);}
.scope-edit-fields input{flex:1;min-width:100px;}
.scope-name-display{flex:1;font-size:13px;font-weight:500;}
.scope-name-display.hidden{display:none;}
.scope-row:hover{background:var(--cream);}
.scope-row label{display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;flex:1;}
.scope-row .svc-tag{font-size:10px;color:var(--gray);background:var(--cream);border:1px solid var(--border);padding:1px 6px;border-radius:10px;margin-left:4px;}
.scope-row .del-scope{font-size:11px;color:var(--gray);cursor:pointer;opacity:.5;padding:2px 6px;border-radius:2px;transition:all .15s;}
.scope-row .del-scope:hover{opacity:1;background:#fef2f2;color:#b91c1c;}

/* ── ROOM CHIPS ── */
.room-chip{display:inline-flex;align-items:center;gap:4px;background:var(--cream);border:1px solid var(--border);padding:4px 8px;border-radius:20px;font-size:12px;}
.room-chip button{background:none;border:none;cursor:pointer;color:var(--gray);padding:0;line-height:1;font-size:13px;}
.room-chip button:hover{color:#b91c1c;}
.room-quick{display:inline-block;font-size:11px;color:var(--navy);border:1px solid var(--border);padding:2px 7px;border-radius:10px;cursor:pointer;margin:2px;}
.room-quick:hover{background:var(--navy);color:var(--white);}

/* ── MODAL SIZES ── */
.modal-lg{max-width:860px;}

/* ── PRINT STYLES ── */
@media print{
  .topbar,.sidebar,.snav,.adm,.scr:not(.on),.mb,.toast-wrap{display:none!important;}
  .print-page{display:block!important;}
}
.print-page{display:none;position:fixed;inset:0;background:var(--white);z-index:9999;padding:40px;overflow:auto;}
.print-page-hd{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid var(--navy);}
.print-page-title{font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:700;color:var(--navy);}
.print-page-sub{font-size:13px;color:var(--gray);margin-top:4px;}
.print-page img{max-width:100%;max-height:calc(100vh - 200px);object-fit:contain;display:block;margin:0 auto;}
.print-page-actions{display:flex;gap:10px;margin-top:24px;justify-content:flex-end;}
@media print{.print-page-actions{display:none!important;}}


/* ── PROPERTY EDIT MODAL LAYOUT ── */
.modal-xl{max-width:980px;width:95vw;}
.madd-cols{display:grid;grid-template-columns:1fr 1fr;gap:0 24px;}
.madd-col{}
@media(max-width:680px){.madd-cols{grid-template-columns:1fr;}}

/* ── INLINE FLOOR PLAN CARDS (inside Edit Property modal) ── */
.fp-inline-card{border:1px solid var(--border);border-radius:4px;margin-bottom:10px;overflow:hidden;background:var(--white);}
.fp-inline-hd{display:flex;align-items:center;gap:12px;padding:10px 14px;cursor:pointer;background:var(--cream);user-select:none;}
.fp-inline-hd:hover{background:#eee9e0;}
.fp-inline-name{font-size:13px;font-weight:700;color:var(--navy);flex:1;}
.fp-inline-meta{font-size:11px;color:var(--gray);}
.fp-inline-chevron{font-size:10px;color:var(--gray);transition:transform .2s;margin-left:4px;}
.fp-inline-card.open .fp-inline-chevron{transform:rotate(180deg);}
.fp-inline-body{display:none;padding:16px;border-top:1px solid var(--border);}
.fp-inline-card.open .fp-inline-body{display:block;}
.fp-inline-section{margin-bottom:18px;}
.fp-inline-section-title{font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--gray);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.fp-inline-actions{display:flex;gap:8px;justify-content:flex-end;padding-top:10px;border-top:1px solid var(--border);margin-top:4px;}

/* rooms grid inside fp card */
.room-grid{display:flex;flex-wrap:wrap;gap:6px;}
.room-toggle{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;border:1px solid var(--border);font-size:12px;cursor:pointer;transition:all .15s;background:var(--white);color:var(--text);}
.room-toggle.selected{background:var(--navy);border-color:var(--navy);color:var(--white);}
.room-toggle:hover:not(.selected){background:var(--cream);}

/* scope grid inside fp card */
.scope-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.scope-toggle{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:3px;border:1px solid var(--border);font-size:12px;cursor:pointer;transition:all .15s;background:var(--white);}
.scope-toggle.selected{background:rgba(2,10,91,.06);border-color:var(--navy);}
.scope-toggle:hover:not(.selected){background:var(--cream);}
.scope-toggle input[type=checkbox]{accent-color:var(--navy);cursor:pointer;}
.scope-custom-row{display:flex;gap:8px;margin-top:10px;}


/* ── Selectable scope chips in order form ── */
.scope-chip-sel{
  display:inline-flex;align-items:center;gap:4px;
  padding:5px 12px;border-radius:3px;font-size:12px;font-weight:600;
  cursor:pointer;user-select:none;transition:all .18s;
  background:rgba(2,10,91,.06);color:var(--navy);
  border:1.5px solid rgba(2,10,91,.15);
}
.scope-chip-sel:hover{background:rgba(2,10,91,.12);border-color:rgba(2,10,91,.3);}
.scope-chip-sel.chosen{
  background:var(--navy);color:#fff;border-color:var(--navy);
}
.scope-chip-sel.chosen::before{content:'✓ ';}

.bs.dn{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;}
.bs.dn:hover{background:#fee2e2;}

.tab-toggle{background:var(--white);border:none;padding:6px 14px;font-size:12px;font-weight:600;color:var(--gray);cursor:pointer;font-family:inherit;transition:all .15s;}
.tab-toggle.on{background:var(--navy);color:#fff;}
.tab-toggle:hover:not(.on){background:var(--cream);}

/* ── Work order change log ── */
.wo-log-sec{background:var(--cream);border:1px solid var(--border);}
.wo-log-entry{padding:10px 0;border-bottom:1px solid var(--border);}
.wo-log-entry:last-child{border-bottom:none;}
.wo-log-hd{display:flex;justify-content:space-between;font-size:13px;font-weight:700;color:var(--navy);margin-bottom:3px;}
.wo-log-hd span{font-weight:400;font-size:11px;color:var(--gray);}
.wo-log-meta{font-size:12px;color:var(--gray);margin-bottom:6px;}
.wo-log-change{font-size:12px;padding:3px 0;display:flex;gap:8px;flex-wrap:wrap;}
.wo-log-field{font-weight:600;color:var(--navy);min-width:140px;}
.wo-log-arrow{color:var(--gray);}

/* ── ROLE BADGES ── */
.rl-sa{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:3px;font-size:11px;font-weight:600;letter-spacing:.3px;background:rgba(21,128,61,.12);color:#15803d;border:1px solid #bbf7d0;white-space:nowrap;}
.rl-ad{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:3px;font-size:11px;font-weight:600;letter-spacing:.3px;background:rgba(2,10,91,.1);color:var(--navy);border:1px solid rgba(2,10,91,.2);white-space:nowrap;}
.rl-mg{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:3px;font-size:11px;font-weight:600;letter-spacing:.3px;background:rgba(37,99,235,.1);color:#1d4ed8;border:1px solid #bfdbfe;white-space:nowrap;}
.rl-sl{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:3px;font-size:11px;font-weight:600;letter-spacing:.3px;background:rgba(124,58,237,.1);color:#7c3aed;border:1px solid #ddd6fe;white-space:nowrap;}
.rl-ed{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:3px;font-size:11px;font-weight:600;letter-spacing:.3px;background:#fefce8;color:#854d0e;border:1px solid #fde68a;white-space:nowrap;}
.perm-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:16px;}
.perm-card{background:var(--cream);border:1px solid var(--border);border-radius:4px;padding:16px 18px;}
.perm-card-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.perm-item{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text);padding:3px 0;}
.perm-yes{color:#15803d;font-size:14px;}
.perm-no{color:#dc2626;font-size:14px;}
.perm-part{color:#d97706;font-size:14px;}
/* ── PERMISSION CHECKBOXES ── */
.perm-section{margin-top:20px;border:1px solid var(--border);border-radius:4px;overflow:hidden;}
.perm-section-hd{background:var(--navy);color:#fff;padding:8px 14px;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;display:flex;align-items:center;gap:8px;}
.perm-rows{padding:6px 0;}
.perm-row{display:flex;align-items:center;gap:10px;padding:7px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;}
.perm-row:last-child{border-bottom:none;}
.perm-row:hover{background:var(--cream);}
.perm-row input[type=checkbox]{width:15px;height:15px;accent-color:var(--navy);cursor:pointer;flex-shrink:0;}
.perm-row-label{flex:1;font-size:12px;font-weight:500;color:var(--text);}
.perm-row-desc{font-size:11px;color:var(--gray);margin-left:auto;text-align:right;max-width:200px;}
.perm-row.locked{opacity:.45;pointer-events:none;}
.perm-note{font-size:11px;color:var(--gray);font-style:italic;padding:6px 14px 8px;}
.role-defaults-hint{font-size:11px;background:#e0f2fe;color:#0369a1;border:1px solid #bae6fd;border-radius:3px;padding:7px 12px;margin-top:12px;display:flex;align-items:flex-start;gap:6px;}

/* ── SORTABLE TABLE HEADERS ── */
th.sortable{cursor:pointer;user-select:none;white-space:nowrap;}
th.sortable:hover{background:rgba(2,10,91,.06);}
th.sortable::after{content:' ⇅';opacity:.35;font-size:10px;}
th.sort-asc::after{content:' ↑';opacity:1;color:var(--gold);}
th.sort-desc::after{content:' ↓';opacity:1;color:var(--gold);}

/* ── SORTABLE TABLE HEADERS ── */
th.sortable{cursor:pointer;user-select:none;white-space:nowrap;}
th.sortable:hover{background:rgba(2,10,91,.08);}
th.sortable::after{content:' \2B83';opacity:.3;font-size:9px;margin-left:3px;}
th.sort-asc::after{content:' \2191';opacity:1;color:var(--gold);}
th.sort-desc::after{content:' \2193';opacity:1;color:var(--gold);}

/* ── EXPORT DROPDOWN ── */
.exp-wrap{position:relative;display:inline-block;flex-shrink:0;}
.exp-btn{display:inline-flex;align-items:center;gap:6px;background:var(--navy);color:#fff;border:none;padding:0 14px;height:34px;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;border-radius:var(--r);white-space:nowrap;font-family:inherit;}
.exp-btn:hover{background:#010840;}
.exp-btn .caret{font-size:8px;opacity:.75;margin-left:2px;}
.exp-menu{display:none;position:absolute;right:0;top:calc(100% + 5px);background:#fff;border:1px solid var(--border);border-radius:var(--r);box-shadow:0 6px 20px rgba(2,10,91,.13);min-width:190px;z-index:999;overflow:hidden;}
.exp-menu.open{display:block;}
.exp-item{display:flex;align-items:center;gap:10px;padding:10px 14px;font-size:12px;font-weight:500;color:var(--text,#1c1c2e);cursor:pointer;border-bottom:1px solid var(--border);transition:background .12s;}
.exp-item:last-child{border-bottom:none;}
.exp-item:hover{background:var(--cream,#F8F5EF);}
.exp-item-icon{font-size:14px;width:18px;text-align:center;flex-shrink:0;}
.exp-item-label{flex:1;}
.exp-item-ext{font-size:10px;font-weight:700;color:var(--gray);letter-spacing:.5px;opacity:.7;}
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<!-- LOGIN -->
<div class="scr on" id="sl">
  <div class="lglow"></div>
  <div class="lbox">
    <img src="data:image/png;base64,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" style="height:52px;width:auto;margin-bottom:28px;" alt="Protective Flooring">
    <div class="gl"></div>
    <h1>Welcome Back</h1>
    <p class="sub">Sign in to your Protective Flooring portal</p>
    <div id="lerr" class="lerr">Incorrect email or password. Please try again.</div>
    <div class="fg"><label>Email Address</label><input type="email" id="lemail" value="manager@cherrycreek.com"></div>
    <div class="fg"><label>Password</label><input type="password" id="lpw" value="Cherry2025!"></div>
    <button class="btn-pri" onclick="doLogin()" style="margin-top:6px;">Sign In</button>
    <div style="text-align:center;margin-top:20px;font-size:13px;color:var(--gray);">Need access? <a href="#" style="color:var(--gold);font-weight:600;" onclick="toast('Contact info@protectiveflooring.com to request an account.')">Contact us</a></div>
  </div>
</div>

<!-- CHOOSER SCREEN: shown to admin/staff users after login -->
<div class="scr" id="sc">
  <div class="lglow"></div>
  <div class="lbox" style="max-width:460px;">
    <div class="gl"></div>
    <h1 style="margin-bottom:6px;">Welcome Back</h1>
    <p class="sub" id="sc_greeting">Where would you like to go?</p>
    <div style="display:flex;flex-direction:column;gap:14px;margin-top:28px;">
      <button class="sc-choice" onclick="goClientPortalFromChooser()">
        <div class="sc-icon">&#128101;</div>
        <div style="text-align:left;">
          <div class="sc-title">Client Portal</div>
          <div class="sc-sub">View and submit flooring orders for your properties</div>
        </div>
      </button>
      <button class="sc-choice sc-admin" onclick="go('ad');applyRoleRestrictions(window.currentTeamUser?window.currentTeamUser.role:'admin');">
        <div class="sc-icon">&#128274;</div>
        <div style="text-align:left;">
          <div class="sc-title">Admin Panel</div>
          <div class="sc-sub">Manage orders, properties, users, and floor plans</div>
        </div>
      </button>
    </div>
    <div style="text-align:center;margin-top:28px;">
      <button onclick="doLogout()" style="background:none;border:none;font-size:12px;color:var(--gray);cursor:pointer;font-family:inherit;text-decoration:underline;">&#8592; Sign out</button>
    </div>
  </div>
</div>

<!-- CLIENT PORTAL -->
<div class="scr" id="cl">
  <aside class="sidebar">
    <div class="slogo"><a href="index.html" target="_blank" title="Back to homepage"><img src="data:image/png;base64,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" alt="Protective Flooring"></a><div class="srole">Client Portal</div></div>
    <div class="suser">
      <div class="avatar" id="cavatar">JL</div>
      <div><div class="uname" id="cname">Jessica Lane</div><div class="uprop" id="cprop">Cherry Creek Apartments</div></div>
    </div>
    <nav class="snav">
      <div class="nlabel">Menu</div>
      <div class="ni on" onclick="cnav('cd',this)"><span class="ic">&#9735;</span> Dashboard</div>
      <div class="ni" onclick="cnav('co',this)"><span class="ic">&#43;</span> Place Order Request</div>
      <div class="ni" onclick="cnav('ch',this)"><span class="ic">&#9783;</span> Order History</div>
      <div class="nlabel">Property</div>
      <div class="ni" onclick="cnav('cf',this)"><span class="ic">&#127760;</span> Floor Plans</div>
      <div class="ni" onclick="cnav('cx',this)"><span class="ic">&#128196;</span> Documents</div>
    </nav>
    <div class="sbot">
    <button class="lo" id="adminBackBtnSidebar" onclick="goBackToAdmin()" style="display:none;background:rgba(200,149,42,.15);color:var(--gold);border-color:rgba(200,149,42,.3);margin-bottom:8px;width:100%;justify-content:center;">&#9756; View Admin Panel</button>
    <button class="lo" onclick="doLogout()">&#8594; Sign Out</button>
  </div>
  </aside>
  <div class="main">
    <div class="topbar">
      <div class="tbtitle" id="ctitle">Dashboard</div>
      <div class="tbr">
        <div class="tprop" id="ctopprop">&#128205; Cherry Creek Apartments</div>
        <button class="nbtn">&#128276;<div class="ndot"></div></button>
      </div>
    </div>
    <div class="content">

      <!-- DASHBOARD -->
      <div class="panel on" id="cd">
        <div class="stats">
          <div class="sc"><div class="si g">&#9783;</div><div><div class="snum">8</div><div class="slbl">Total Orders</div></div></div>
          <div class="sc"><div class="si n">&#9200;</div><div><div class="snum">2</div><div class="slbl">Pending Scheduling</div></div></div>
          <div class="sc"><div class="si gr">&#10003;</div><div><div class="snum">5</div><div class="slbl">Completed</div></div></div>
          <div class="sc"><div class="si rd">&#9888;</div><div><div class="snum">1</div><div class="slbl">Needs Attention</div></div></div>
        </div>
        <div class="shd"><h2>Recent Orders</h2><button class="bs gd" onclick="cnav('co',document.querySelectorAll('#cl .ni')[1])">+ New Order</button></div>
        <div class="tw"><table>
          <thead><tr><th>Work Order</th><th>Unit</th><th>Service</th><th>Requested</th><th>Status</th><th></th></tr></thead>
          <tbody id="cd_tbody"></tbody>
        </table></div>
      </div>

      <!-- NEW ORDER -->
      <div class="panel" id="co">
        <div class="fc">
          <h3>&#127968; Property &amp; Unit</h3>
          <div class="form-row" style="margin-bottom:16px;">
            <div class="fg"><label>Property *</label>
              <select id="cpropsel" onchange="updatePropFloorPlans(this.value)">
                <option value="">-- Select Property --</option>
              </select>
            </div>
            <div class="fg"><label>Unit Number *</label><input type="text" id="cunitinput" placeholder="e.g. 214"></div>
          </div>
          <div class="form-row">
            <div class="fg"><label>Floor Plan *</label>
              <select id="cplan" onchange="onPlanChange(this.value)">
                <option value="">-- Select Floor Plan --</option>
              </select>
            </div>
            <div class="fg"><label>Occupancy *</label>
              <div class="rg" style="margin-top:4px;">
                <div class="ro on" onclick="selRadio(this,'occ')"><div class="ri">&#128275;</div><div class="rl">Vacant</div></div>
                <div class="ro" onclick="selRadio(this,'occ')"><div class="ri">&#128101;</div><div class="rl">Occupied</div></div>
              </div>
            </div>
          </div>
          <div id="fppreview" style="display:none;margin-top:16px;">
            <div style="background:var(--cream);border:1px solid var(--border);border-radius:6px;padding:16px;margin-bottom:12px;">
              <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
                <div class="fp-card-img" id="fpcardimg" style="flex-shrink:0;cursor:pointer;" onclick="openFpImgById(document.getElementById('cplan').value)">&#127760;</div>
                <div style="flex:1;min-width:180px;">
                  <div style="font-size:15px;font-weight:700;color:var(--navy);" id="fpcardname"></div>
                  <div style="font-size:12px;color:var(--gray);margin-top:2px;" id="fpcardsqft"></div>
                  <div style="margin-top:4px;" id="fpcardimg-btn"></div>
                </div>
              </div>
              <div id="fpscopes-section" style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border);display:none;">
                <div style="font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--gray);margin-bottom:8px;">Installation Scopes for This Plan</div>
                <div id="fpscopes-chips" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
              </div>
            </div>
          </div>
          <div id="occnotice" style="display:none;background:#fffbeb;border:1px solid #fde68a;padding:14px 16px;border-radius:3px;margin-top:12px;">
            <strong style="color:#b45309;">&#9888; Occupied Unit</strong>
            <p style="font-size:13px;color:#92400e;margin-top:4px;">Please download the Occupied Unit Form before scheduling. <a href="#" style="color:#b45309;font-weight:700;">&#8681; Download PDF</a></p>
          </div>
        </div>
        <div class="fc">
          <h3>&#129520; Service &amp; Scope</h3>
          <!-- presetzone merged into fppreview above -->
          <div class="fg" style="margin-bottom:20px;"><label>Flooring Service <span style="font-size:11px;font-weight:400;color:var(--gray);">(required if no scope selected)</span></label>
            <select id="csvc"><option value="">-- Select Service --</option><option>Carpet Installation</option><option>Luxury Vinyl Plank (LVP)</option><option>Sheet Vinyl</option><option>Tile Installation</option><option>Pet Seal Treatment</option><option>Subfloor Repair</option><option>Repair</option><option>Call Back</option></select>
          </div>
          <div class="fg"><label>Scope of Work <span style="font-size:11px;font-weight:400;color:var(--gray);">(required if no service selected — or select presets above)</span></label>
            <div class="sg" style="margin-top:8px;" id="scopegrid">
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Living Room</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Master Bedroom</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Bedroom 2</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Bedroom 3</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Bedroom 4</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Kitchen</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Bathroom 1</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Bathroom 2</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Hallway</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Dining Area</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Laundry Room</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Entry</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Entryway</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Stairs</div>
              <div class="so" onclick="togScope(this)"><div class="ck"></div>Entire Unit</div>
            </div>
          </div>
          <div class="fg" style="margin-top:18px;"><label>Notes / Special Instructions</label><textarea id="cnotes" placeholder="Describe damage, access instructions, or anything the crew should know..."></textarea></div>
        </div>
        <div class="fc">
          <h3>&#128197; Scheduling</h3>
          <div class="form-row">
            <div class="fg"><label>Requested Install Date *</label><input type="date" id="cinstdate"></div>
            <div class="fg"><label>Preferred Time Window</label><select><option>No Preference</option><option>Morning (7 AM - 12 PM)</option><option>Afternoon (12 PM - 5 PM)</option></select></div>
          </div>
        </div>
        <div class="fc">
          <h3>&#128247; Photos <span style="font-size:13px;font-weight:400;color:var(--gray);">-- Optional</span></h3>
          <div class="uz" onclick="toast('Photo upload ready in live version.')"><div style="font-size:36px;margin-bottom:10px;">&#128247;</div><div style="font-size:14px;color:var(--gray);font-weight:300;"><strong style="color:var(--navy);font-weight:600;">Click to upload photos</strong></div><div style="font-size:11px;color:var(--gray);margin-top:6px;">JPG, PNG up to 20MB each. Max 10 photos.</div></div>
        </div>
        <div class="fa">
          <button class="bl ol" onclick="cnav('cd',document.querySelectorAll('#cl .ni')[0])">Cancel</button>
          <button class="bl gd" onclick="submitOrder()">&#10003; Submit Order Request</button>
        </div>
      </div>

      <!-- ORDER HISTORY -->
      <div class="panel" id="ch">
        <div class="shd" style="margin-bottom:16px;">
          <h2>Order History</h2>
          <span id="ch_count" style="font-size:13px;color:var(--gray);font-weight:400;margin-left:8px;"></span>
        </div>
        <div class="fb" style="flex-wrap:wrap;gap:8px;margin-bottom:12px;">
          <div class="sw" style="min-width:200px;flex:1;">
            <span class="si2">&#128269;</span>
            <input type="text" id="ch_search" placeholder="Search orders, units, services..." oninput="renderClientHistory()">
          </div>
          <select class="fs" id="ch_status_filter" onchange="renderClientHistory()">
            <option value="">All Statuses</option>
            <option value="requested">Requested</option>
            <option value="scheduled">Scheduled</option>
            <option value="completed">Completed</option>
          </select>
          <select class="fs" id="ch_prop_filter" onchange="renderClientHistory()">
            <option value="">All Properties</option>
          </select>
          <select class="fs" id="ch_hub_filter" onchange="renderClientHistory()">
            <option value="">All Hubs</option>
          </select>
          <select class="fs" id="ch_sort" onchange="renderClientHistory()">
            <option value="newest">Newest First</option>
            <option value="date">By Install Date</option>
            <option value="property">By Property</option>
            <option value="status">By Status</option>
            <option value="service">By Service</option>
          </select>
        </div>
        <div class="tw"><table>
          <thead><tr>
            <th>Work Order</th>
            <th>Property</th>
            <th>Unit</th>
            <th>Service</th>
            <th>Requested</th>
            <th>Hub</th>
            <th>Status</th>
            <th></th>
          </tr></thead>
          <tbody id="ch_tbody"></tbody>
        </table></div>
      </div>

      <!-- FLOOR PLANS -->
      <div class="panel" id="cf">
        <div class="shd"><h2>Floor Plans</h2><div id="cfproptitle" style="font-size:14px;color:var(--gray);font-weight:400;"></div></div>
        <div id="cfgrid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:18px;"></div>
      </div>

      <!-- DOCUMENTS -->
      <div class="panel" id="cx">
        <div class="shd"><h2>Documents &amp; Forms</h2></div>
        <div class="tw"><table><thead><tr><th>Document</th><th>Description</th><th>Updated</th><th></th></tr></thead><tbody>
          <tr><td><strong>Occupied Unit Form</strong></td><td>Required for flooring in occupied units</td><td>Jan 2025</td><td><button class="bs gd" onclick="toast('Download ready in live version.')">&#8681; Download</button></td></tr>
          <tr><td><strong>Flooring Care Guide</strong></td><td>Maintenance instructions for residents</td><td>Dec 2024</td><td><button class="bs ol" onclick="toast('Download ready.')">&#8681; Download</button></td></tr>
          <tr><td><strong>Pet Damage Checklist</strong></td><td>Pre-order assessment guide</td><td>Nov 2024</td><td><button class="bs ol" onclick="toast('Download ready.')">&#8681; Download</button></td></tr>
        </tbody></table></div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /client -->

<!-- ADMIN PANEL -->
<div class="scr" id="ad">
  <aside class="sidebar adm">
    <div class="slogo"><img src="data:image/png;base64,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" alt="Protective Flooring"><div class="srole">Admin Panel</div></div>
    <div class="suser"><div class="avatar" id="aavatar" style="background:linear-gradient(135deg,#C8952A,#E8B84B);">PF</div><div><div class="uname" id="aname">Admin User</div><div class="uprop" id="arole">Protective Flooring Staff</div></div></div>
    <nav class="snav">
      <div class="nlabel">Operations</div>
      <div class="ni on" onclick="anav('adash',this)"><span class="ic">&#9735;</span> Dashboard</div>
      <div class="ni" onclick="anav('aord',this)"><span class="ic">&#9783;</span> All Orders <span class="nb">4</span></div>
      <div class="nlabel">Management</div>
      <div class="ni" onclick="anav('aprops',this)"><span class="ic">&#127968;</span> Properties</div>
      <div class="ni" onclick="anav('ausers',this)"><span class="ic">&#128101;</span> Client Logins</div>
      <div class="ni" onclick="anav('ateam',this)"><span class="ic">&#128274;</span> Portal Users</div>
      <div class="nlabel">Settings</div>
      <div class="ni" onclick="anav('aset',this)"><span class="ic">&#9881;</span> Portal Settings</div>
    </nav>
    <div class="sbot">
    <button class="lo" style="background:rgba(200,149,42,.15);color:var(--gold);border-color:rgba(200,149,42,.3);margin-bottom:8px;width:100%;justify-content:center;" onclick="goClientPortalFromChooser();setTimeout(function(){go('cl');},100);">&#128101; View Client Portal</button>
    <button class="lo" onclick="doLogout()">&#8594; Sign Out</button>
  </div>
  </aside>
  <div class="main">
    <div class="topbar">
      <div class="tbtitle" id="atitle">Admin Dashboard</div>
      <div class="tbr"><span class="abadge">&#128274; Admin Access</span><button class="nbtn">&#128276;<div class="ndot"></div></button></div>
    </div>
    <div class="content">

      <!-- ADMIN DASHBOARD -->
      <div class="panel on" id="adash">
        <div class="stats">
          <div class="sc"><div class="si g">&#9783;</div><div><div class="snum">47</div><div class="slbl">Orders This Month</div></div></div>
          <div class="sc"><div class="si rd">&#9888;</div><div><div class="snum">4</div><div class="slbl">Awaiting Confirmation</div></div></div>
          <div class="sc"><div class="si n">&#127968;</div><div><div class="snum">8</div><div class="slbl">Active Properties</div></div></div>
          <div class="sc"><div class="si gr">&#128101;</div><div><div class="snum">36</div><div class="slbl">Client Logins</div></div></div>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:16px;">
          <h2 style="margin:0;" id="adash_table_title">New Orders — Action Required</h2>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <select class="fs" id="adash_hub" onchange="switchDashTab(_dashTab)" style="min-width:130px;">
              <option value="">All Hubs</option>
            </select>
            <div style="display:flex;border:1px solid var(--border);border-radius:3px;overflow:hidden;">
              <button id="tab_recent" class="tab-toggle on" onclick="switchDashTab('recent')">Recent Orders</button>
              <button id="tab_today"  class="tab-toggle"    onclick="switchDashTab('today')">Today's Installs</button>
            </div>
            <button class="bs gd" onclick="goClientPortalFromChooser();setTimeout(function(){go('cl');cnav('co',document.querySelector('#cl .ni[onclick*=&quot;co&quot;]'));},150);">&#128221; Place New Order</button>
          </div>
        </div>
        <div class="tw" style="margin-bottom:28px;" id="adash_recent_wrap"><table id="adash_recent_tbl">
          <thead><tr><th class="sortable" onclick="sortTable('adash_recent_tbl',0,'str')">Work Order</th><th class="sortable" onclick="sortTable('adash_recent_tbl',1,'str')">Property</th><th class="sortable" onclick="sortTable('adash_recent_tbl',2,'str')">Hub</th><th class="sortable" onclick="sortTable('adash_recent_tbl',3,'str')">Unit</th><th class="sortable" onclick="sortTable('adash_recent_tbl',4,'str')">Service</th><th class="sortable" onclick="sortTable('adash_recent_tbl',5,'date')">Requested</th><th class="sortable" onclick="sortTable('adash_recent_tbl',6,'date')">Install Date</th><th class="sortable" onclick="sortTable('adash_recent_tbl',7,'str')">Status</th><th>Action</th></tr></thead>
          <tbody id="adash_recent_tbody"></tbody>
        </table></div>
        <div class="tw" style="margin-bottom:28px;display:none;" id="adash_today_wrap"><table id="adash_today_tbl">
          <thead><tr><th class="sortable" onclick="sortTable('adash_today_tbl',0,'str')">Work Order</th><th class="sortable" onclick="sortTable('adash_today_tbl',1,'str')">Property</th><th class="sortable" onclick="sortTable('adash_today_tbl',2,'str')">Hub</th><th class="sortable" onclick="sortTable('adash_today_tbl',3,'str')">Unit</th><th class="sortable" onclick="sortTable('adash_today_tbl',4,'str')">Service</th><th class="sortable" onclick="sortTable('adash_today_tbl',5,'date')">Requested</th><th class="sortable" onclick="sortTable('adash_today_tbl',6,'date')">Install Date</th><th class="sortable" onclick="sortTable('adash_today_tbl',7,'str')">Status</th><th>Action</th></tr></thead>
          <tbody id="adash_today_tbody"></tbody>
        </table></div>
      </div>

      <!-- ADMIN ALL ORDERS -->
      <div class="panel" id="aord">
        <div class="shd" style="margin-bottom:16px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <h2 style="margin:0;">All Orders</h2>
            <span id="aord_count" style="font-size:13px;color:var(--gray);font-weight:400;"></span>
          </div>
          <div class="exp-wrap" id="expWrap">
            <button class="exp-btn" onclick="toggleExpMenu(event)">&#8681; Export <span class="exp-arrow">&#9660;</span></button>
            <div class="exp-menu" id="expMenu">
              <div class="exp-item" onclick="exportAordCsv()"><span class="exp-item-icon">&#128196;</span><span class="exp-item-label">CSV</span><span class="exp-item-ext">.csv</span></div>
              <div class="exp-item" onclick="exportAordXlsx()"><span class="exp-item-icon">&#128202;</span><span class="exp-item-label">Excel</span><span class="exp-item-ext">.xlsx</span></div>
              <div class="exp-item" onclick="exportAordJson()"><span class="exp-item-icon">&#128196;</span><span class="exp-item-label">JSON</span><span class="exp-item-ext">.json</span></div>
              <div class="exp-item" onclick="exportAordPrint()"><span class="exp-item-icon">&#128424;</span><span class="exp-item-label">Print / PDF</span><span class="exp-item-ext">.pdf</span></div>
              <div class="exp-item" onclick="exportAordTsv()"><span class="exp-item-icon">&#128196;</span><span class="exp-item-label">Tab-Separated</span><span class="exp-item-ext">.tsv</span></div>
            </div>
          </div>
        </div>
        <div class="fb" style="flex-wrap:wrap;gap:8px;margin-bottom:12px;">
          <div class="sw" style="min-width:200px;flex:1;">
            <span class="si2">&#128269;</span>
            <input type="text" id="aord_search" placeholder="Search by WO#, property, unit, service..." oninput="renderAdminOrders()">
          </div>
          <select class="fs" id="aord_prop" onchange="renderAdminOrders()">
            <option value="">All Properties</option>
          </select>
          <select class="fs" id="aord_status" onchange="renderAdminOrders()">
            <option value="">All Statuses</option>
            <option value="requested">Requested</option>
            <option value="scheduled">Scheduled</option>
            <option value="completed">Completed</option>
            <option value="vd">Voided</option>
          </select>
          <select class="fs" id="aord_hub" onchange="renderAdminOrders()">
            <option value="">All Hubs</option>
          </select>
          <select class="fs" id="aord_date_range" onchange="onDateRangeChange()" title="Filter by date">
            <option value="">All Dates</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="tomorrow">Tomorrow</option>
            <option value="last_week">Last Week</option>
            <option value="last_month">Last Month</option>
            <option value="last_quarter">Last Quarter</option>
            <option value="qtd">Quarter to Date</option>
            <option value="last_year">Last Year</option>
            <option value="ytd">Year to Date</option>
            <option value="custom">Custom Date Range...</option>
          </select>
          <div id="aord_custom_dates" style="display:none;align-items:center;gap:6px;">
            <input type="date" id="aord_date_from" class="fs" style="width:130px;" onchange="renderAdminOrders()" title="From date">
            <span style="font-size:12px;color:var(--gray);">to</span>
            <input type="date" id="aord_date_to" class="fs" style="width:130px;" onchange="renderAdminOrders()" title="To date">
          </div>
          <select class="fs" id="aord_sort" onchange="renderAdminOrders()">
            <option value="newest">Newest First</option>
            <option value="date">By Date</option>
            <option value="property">By Property</option>
            <option value="status">By Status</option>
            <option value="service">By Service</option>
          </select>
        </div>
        <div class="tw"><table id="aord_tbl">
          <thead><tr>
            <th class="sortable" onclick="sortTable('aord_tbl',0,'str')">Work Order</th><th class="sortable" onclick="sortTable('aord_tbl',1,'str')">Property</th><th class="sortable" onclick="sortTable('aord_tbl',2,'str')">Hub</th><th class="sortable" onclick="sortTable('aord_tbl',3,'str')">Unit</th>
            <th class="sortable" onclick="sortTable('aord_tbl',4,'str')">Service</th><th class="sortable" id="aord_date_th" onclick="sortTable('aord_tbl',5,'date')">Requested</th><th class="sortable" onclick="sortTable('aord_tbl',6,'str')">Status</th><th>Actions</th>
          </tr></thead>
          <tbody id="aord_tbody"></tbody>
        </table></div>
      </div>

      <!-- ADMIN PROPERTIES -->
      <div class="panel" id="aprops">
        <div class="shd"><h2>Properties</h2>
          <div style="display:flex;gap:8px;">
            <button class="bs ol" onclick="goClientPortalFromChooser();setTimeout(function(){go('cl');cnav('co',document.querySelector('#cl .ni[onclick*="co"]'));},150);">&#128221; Place Order</button>
            <button class="bs gd" onclick="openAddPropModal()">+ Add Property</button>
          </div></div>
        <div class="fb" style="margin-bottom:16px;">
          <div class="sw" style="max-width:400px;"><span class="si2">&#128269;</span><input type="text" id="psearch" placeholder="Search by name, city, or zip..." oninput="filterProps()"></div>
          <select class="fs" id="pstatus" onchange="filterProps()"><option value="">All Statuses</option><option value="active" selected>Active</option><option value="inactive">Inactive</option></select>
        </div>
        <div class="tabs" id="hub_tabs"></div>
        <div id="proplist"></div>
      </div><!-- /aprops -->

      <!-- ADMIN USERS -->
      <div class="panel" id="ausers">
        <div class="shd" style="margin-bottom:14px;">
          <h2>Client Logins</h2>
          <button class="bs gd" onclick="openMuser()">+ Add Login</button>
        </div>
        <div class="fb" style="flex-wrap:wrap;gap:8px;margin-bottom:12px;align-items:center;">
          <div class="sw" style="min-width:220px;flex:1;">
            <span class="si2">&#128269;</span>
            <input type="text" id="ucl_search" placeholder="Search by name, email, or property..." oninput="renderUserTable()">
          </div>
          <select class="fs" id="ucl_hub" onchange="renderUserTable()">
            <option value="">All Hubs</option>
          </select>
          <select class="fs" id="ucl_status" onchange="renderUserTable()">
            <option value="">All Statuses</option>
            <option value="active" selected>Active</option>
            <option value="inactive">Inactive</option>
          </select>
          <select class="fs" id="ucl_sort" onchange="renderUserTable()">
            <option value="recent">Last Login: Most Recent</option>
            <option value="oldest">Last Login: Oldest First</option>
            <option value="never">Never Logged In First</option>
            <option value="name">Name A–Z</option>
          </select>
        </div>
        <div class="tw"><table id="ucl_table">
          <thead><tr>
            <th>Name</th><th>Email</th><th>Properties</th><th>Hub</th>
            <th>Role</th><th>Status</th>
            <th style="white-space:nowrap;">Last Login <span id="ucl_count" style="font-weight:400;font-size:10px;color:rgba(255,255,255,.6);"></span></th>
            <th></th>
          </tr></thead>
          <tbody id="ucl_tbody">
            <!-- rows rendered by renderUserTable() -->
          </tbody>
        </table></div>
      </div>

      <!-- PORTAL USERS PANEL -->
      <div class="panel" id="ateam">
        <div class="shd">
          <h2>Portal Users</h2>
          <button class="bs gd" onclick="openAddTeamUser()">+ Add User</button>
        </div>
        <!-- Role Legend -->
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;padding:16px 20px;background:var(--cream);border:1px solid var(--border);border-radius:4px;">
          <div style="font-size:11px;font-weight:700;color:var(--gray);letter-spacing:.5px;text-transform:uppercase;width:100%;margin-bottom:4px;">Access Level Reference</div>
          <div style="display:flex;align-items:center;gap:6px;font-size:12px;"><span class="b" style="background:rgba(21,128,61,.12);color:#15803d;border:1px solid #bbf7d0;">&#128737; Super Admin</span> Full system access · Users · Settings · All data</div>
          <div style="display:flex;align-items:center;gap:6px;font-size:12px;"><span class="b nv">&#128274; Admin</span> Orders · Properties · Client logins · Reports</div>
          <div style="display:flex;align-items:center;gap:6px;font-size:12px;"><span class="b" style="background:rgba(37,99,235,.1);color:#1d4ed8;border:1px solid #bfdbfe;">&#127970; Management</span> Orders · Properties · View reports</div>
          <div style="display:flex;align-items:center;gap:6px;font-size:12px;"><span class="b" style="background:rgba(124,58,237,.1);color:#7c3aed;border:1px solid #ddd6fe;">&#128200; Sales</span> Leads · Proposals · View orders</div>
          <div style="display:flex;align-items:center;gap=6px;font-size:12px;"><span class="b" style="background:#fefce8;color:#854d0e;border-color:#fde68a;">&#9998; Editor</span> Create &amp; edit orders and floor plans · No admin access</div>
        </div>
        <div class="tw"><table>
          <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Default Hub</th><th>Last Login</th><th>Status</th><th>Created</th><th></th></tr></thead>
          <tbody id="teamTbody"><!-- rendered by renderTeamTable() --></tbody>
        </table></div>
      </div>

      <!-- ADMIN SETTINGS -->
      <!-- PORTAL SETTINGS PANEL -->
      <div class="panel" id="aset">
        <div class="shd">
          <h2>&#9881; Portal Settings</h2>
        </div>

        <!-- ── GLOBAL PRESET SCOPES ── -->
        <div class="ms" style="margin-bottom:28px;">
          <div class="mst" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
            <span>&#9883; Global Preset Installation Scopes</span>
          </div>
          <p style="font-size:13px;color:var(--gray);margin-bottom:16px;line-height:1.6;">
            These scopes appear as checkboxes inside every floor plan editor. Check the ones that apply to each plan.
            Add property-specific scopes directly from the floor plan editor inside a property.
          </p>
          <div id="scope_list_admin"></div>
          <div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;align-items:flex-end;">
            <div class="fg" style="flex:1;min-width:160px;margin-bottom:0;">
              <label>Scope Name</label>
              <input type="text" id="scope_new_name" placeholder="e.g. Carpet Bedrooms Only">
            </div>
            <div class="fg" style="min-width:180px;margin-bottom:0;">
              <label>Service Type</label>
              <select id="scope_new_svc">
                <option value="">No specific service</option>
              </select>
            </div>
            <button class="bs gd" onclick="addGlobalScope()" style="margin-bottom:0;">+ Add Scope</button>
          </div>
        </div>

        <!-- ── SERVICE TYPES ── -->
        <div class="ms" style="margin-bottom:28px;">
          <div class="mst" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
            <span>&#127963; Flooring Service Types</span>
            <span style="font-size:11px;font-weight:400;color:var(--gray);">Used in work orders &amp; scope assignments</span>
          </div>
          <p style="font-size:13px;color:var(--gray);margin-bottom:16px;line-height:1.6;">
            Manage the list of flooring service types available when creating work orders and assigning scopes.
            Changes apply immediately across the portal. Drag rows to reorder.
          </p>
          <div id="svc_type_list"></div>
          <div style="display:flex;gap:8px;margin-top:14px;align-items:flex-end;flex-wrap:wrap;">
            <div class="fg" style="flex:1;min-width:200px;margin-bottom:0;">
              <label>New Service Type Name</label>
              <input type="text" id="svc_new_name" placeholder="e.g. Hardwood Installation" onkeydown="if(event.key==='Enter')addServiceType();">
            </div>
            <button class="bs gd" onclick="addServiceType()" style="margin-bottom:0;">+ Add Service Type</button>
          </div>
        </div>



        <!-- ── MARKETS / LOCATIONS ── -->
        <div class="ms" style="margin-bottom:28px;">
          <div class="mst" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
            <span>&#127759; Markets &amp; Locations</span>
            <span style="font-size:11px;font-weight:400;color:var(--gray);">Add new markets as you expand</span>
          </div>
          <p style="font-size:13px;color:var(--gray);margin-bottom:16px;line-height:1.6;">
            Markets appear as hub options when adding properties, creating work orders, and filtering throughout the portal.
            Each market has its own address and phone number printed on work orders.
          </p>
          <div id="market_list"></div>
          <div style="margin-top:14px;padding:16px;border:1px dashed var(--border);border-radius:var(--r);background:var(--off);">
            <div style="font-size:12px;font-weight:600;color:var(--navy);margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px;">Add New Market</div>
            <div class="form-row" style="margin-bottom:8px;">
              <div class="fg" style="margin-bottom:0;"><label>Market Name *</label><input type="text" id="mkt_new_name" placeholder="e.g. Jackson, MS"></div>
              <div class="fg" style="margin-bottom:0;"><label>Market Key *</label><input type="text" id="mkt_new_key" placeholder="e.g. jackson" style="text-transform:lowercase;"></div>
            </div>
            <div class="form-row" style="margin-bottom:8px;">
              <div class="fg" style="margin-bottom:0;"><label>Office Address</label><input type="text" id="mkt_new_addr" placeholder="123 Main St, Jackson, MS 39201"></div>
              <div class="fg" style="margin-bottom:0;"><label>Phone</label><input type="text" id="mkt_new_phone" placeholder="(601) 555-0100"></div>
            </div>
            <button class="bs gd" onclick="addMarket()" style="margin-top:4px;">+ Add Market</button>
          </div>
        </div>

        <!-- ── EMAIL NOTIFICATIONS ── -->
        <div class="ms" style="margin-bottom:28px;">
          <div class="mst">&#9993; Email Notifications</div>
          <p style="font-size:13px;color:var(--gray);margin-bottom:16px;line-height:1.6;">
            Configure who receives an email notification at each stage of a work order's lifecycle.
            The <strong>Company Email</strong> below receives all internal notifications.
          </p>

          <div class="fg" style="max-width:420px;margin-bottom:20px;">
            <label>Company Notification Email</label>
            <input type="email" id="set_notif_email" value="info@protectiveflooring.com" placeholder="info@protectiveflooring.com">
          </div>

          <div style="border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:8px;">
            <!-- Header row -->
            <div style="display:grid;grid-template-columns:1fr 140px 140px;background:var(--navy);color:#fff;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;">
              <div style="padding:10px 16px;">Work Order Stage</div>
              <div style="padding:10px 12px;text-align:center;border-left:1px solid rgba(255,255,255,.15);">Notify Client</div>
              <div style="padding:10px 12px;text-align:center;border-left:1px solid rgba(255,255,255,.15);">Notify Company</div>
            </div>
            <!-- Requested -->
            <div style="display:grid;grid-template-columns:1fr 140px 140px;border-bottom:1px solid var(--border);background:#fff;">
              <div style="padding:14px 16px;">
                <div style="font-size:13px;font-weight:600;color:var(--navy);">&#128221; Order Requested</div>
                <div style="font-size:11px;color:var(--gray);margin-top:2px;">Client submits a new work order</div>
              </div>
              <div style="display:flex;align-items:center;justify-content:center;border-left:1px solid var(--border);">
                <label class="notif-toggle"><input type="checkbox" id="notif_req_client" checked><span class="nt-track"><span class="nt-thumb"></span></span></label>
              </div>
              <div style="display:flex;align-items:center;justify-content:center;border-left:1px solid var(--border);">
                <label class="notif-toggle"><input type="checkbox" id="notif_req_company" checked><span class="nt-track"><span class="nt-thumb"></span></span></label>
              </div>
            </div>
            <!-- Confirmed / Scheduled -->
            <div style="display:grid;grid-template-columns:1fr 140px 140px;border-bottom:1px solid var(--border);background:var(--cream);">
              <div style="padding:14px 16px;">
                <div style="font-size:13px;font-weight:600;color:var(--navy);">&#9989; Order Confirmed &amp; Scheduled</div>
                <div style="font-size:11px;color:var(--gray);margin-top:2px;">Admin confirms install date</div>
              </div>
              <div style="display:flex;align-items:center;justify-content:center;border-left:1px solid var(--border);">
                <label class="notif-toggle"><input type="checkbox" id="notif_conf_client" checked><span class="nt-track"><span class="nt-thumb"></span></span></label>
              </div>
              <div style="display:flex;align-items:center;justify-content:center;border-left:1px solid var(--border);">
                <label class="notif-toggle"><input type="checkbox" id="notif_conf_company"><span class="nt-track"><span class="nt-thumb"></span></span></label>
              </div>
            </div>
            <!-- Completed -->
            <div style="display:grid;grid-template-columns:1fr 140px 140px;border-bottom:1px solid var(--border);background:#fff;">
              <div style="padding:14px 16px;">
                <div style="font-size:13px;font-weight:600;color:var(--navy);">&#10003; Installation Completed</div>
                <div style="font-size:11px;color:var(--gray);margin-top:2px;">Work order marked complete</div>
              </div>
              <div style="display:flex;align-items:center;justify-content:center;border-left:1px solid var(--border);">
                <label class="notif-toggle"><input type="checkbox" id="notif_comp_client"><span class="nt-track"><span class="nt-thumb"></span></span></label>
              </div>
              <div style="display:flex;align-items:center;justify-content:center;border-left:1px solid var(--border);">
                <label class="notif-toggle"><input type="checkbox" id="notif_comp_company"><span class="nt-track"><span class="nt-thumb"></span></span></label>
              </div>
            </div>
            <!-- Voided -->
            <div style="display:grid;grid-template-columns:1fr 140px 140px;background:var(--cream);">
              <div style="padding:14px 16px;">
                <div style="font-size:13px;font-weight:600;color:var(--navy);">&#128683; Order Voided / Cancelled</div>
                <div style="font-size:11px;color:var(--gray);margin-top:2px;">Work order cancelled with reason</div>
              </div>
              <div style="display:flex;align-items:center;justify-content:center;border-left:1px solid var(--border);">
                <label class="notif-toggle"><input type="checkbox" id="notif_void_client" checked><span class="nt-track"><span class="nt-thumb"></span></span></label>
              </div>
              <div style="display:flex;align-items:center;justify-content:center;border-left:1px solid var(--border);">
                <label class="notif-toggle"><input type="checkbox" id="notif_void_company"><span class="nt-track"><span class="nt-thumb"></span></span></label>
              </div>
            </div>
          </div>
          <div style="font-size:11px;color:var(--gray);margin-top:8px;">&#8505; Notifications are logged per order. Actual email delivery requires backend integration.</div>
        </div>

        <!-- ── COMPANY INFO ── -->
        <div class="ms" style="margin-bottom:28px;">
          <div class="mst">&#127968; Company Information</div>
          <p style="font-size:13px;color:var(--gray);margin-bottom:16px;line-height:1.6;">
            Displayed on printed work orders and client-facing documents.
          </p>
          <div class="form-row">
            <div class="fg">
              <label>Company Name</label>
              <input type="text" id="set_co_name" value="Protective Services Company, Inc." placeholder="Company legal name">
            </div>
            <div class="fg">
              <label>DBA</label>
              <input type="text" id="set_co_dba" value="Protective Flooring" placeholder="Doing business as">
            </div>
          </div>
          <div class="form-row">
            <div class="fg">
              <label>Memphis Address</label>
              <input type="text" id="set_addr_mem" value="3846 Delp Street, Memphis, TN 38118">
            </div>
            <div class="fg">
              <label>Nashville Address</label>
              <input type="text" id="set_addr_nash" value="Nashville, TN">
            </div>
          </div>
          <div class="form-row">
            <div class="fg">
              <label>Memphis Phone</label>
              <input type="tel" id="set_ph_mem" value="(901) 794-4101">
            </div>
            <div class="fg">
              <label>Nashville Phone</label>
              <input type="tel" id="set_ph_nash" value="(615) 988-5188">
            </div>
            <div class="fg">
              <label>General Email</label>
              <input type="email" id="set_email" value="info@protectiveflooring.com">
            </div>
          </div>
        </div>

        <!-- ── PORTAL BRANDING ── -->
        <div class="ms" style="margin-bottom:28px;">
          <div class="mst">&#127775; Portal Branding</div>
          <div class="form-row">
            <div class="fg">
              <label>Portal Title</label>
              <input type="text" id="set_portal_title" value="Protective Flooring Client Portal" placeholder="Shown in browser tab">
            </div>
            <div class="fg">
              <label>Support Email (shown to clients)</label>
              <input type="email" id="set_support_email" value="info@protectiveflooring.com">
            </div>
          </div>
        </div>

        <div class="fa" style="padding-top:8px;">
          <button class="bl gd" onclick="savePortalSettings()">&#10003; Save Settings</button>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /admin -->

<!-- MODALS -->
<div class="mb" id="mwo">
  <div class="modal w">
    <div class="mh">
      <h3 id="wotitle">Work Order</h3>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button class="bs gn" onclick="printWorkOrder()">&#128424; Print / Save PDF</button>
        <button class="bs ol" id="phbtn" onclick="togPhotos()">Include Photos</button>
        <button class="bs gd" id="confirmbtn" onclick="openConfirm(this.dataset.woid)" style="display:none;">&#10003; Confirm</button>
        <button class="bs gn" id="completebtn" onclick="markOrderComplete(this.dataset.woid)" style="display:none;">&#10003; Complete</button>
        <button class="bs nv" id="editwobtn" onclick="openWoEdit(this.dataset.woid)" style="display:none;">&#9998; Edit Order</button>
        <button class="bs ol" id="logbtn" onclick="exportWoLog(this.dataset.woid)" style="display:none;">&#128220; Export Log</button>
        <button class="bs dn" id="voidbtn" onclick="openVoidOrder(this.dataset.woid)" style="display:none;">&#128683; Cancel / Void</button>
        <button class="mx" onclick="closeM('mwo')">&#10005;</button>
      </div>
    </div>
    <div class="mbody" style="padding:0;"><div class="wopp parea" id="woprint"></div></div>
  </div>
</div>

<div class="mb" id="mfp">
  <div class="modal w">
    <div class="mh"><div><h3 id="fptitle">Floor Plan</h3><div id="fpsub" style="font-size:12px;color:var(--gray);margin-top:2px;"></div></div><button class="mx" onclick="closeM('mfp')">&#10005;</button></div>
    <div class="mbody" style="text-align:center;">
      <div style="background:var(--off);border:1px solid var(--border);border-radius:var(--r);padding:40px;min-height:300px;display:flex;align-items:center;justify-content:center;">
        <div id="fpnone" style="text-align:center;"><div style="font-size:64px;opacity:.2;margin-bottom:16px;">&#127760;</div><div style="font-size:15px;color:var(--gray);">No floor plan image uploaded yet.</div><div style="font-size:12px;color:var(--gray);margin-top:8px;font-weight:300;">Upload an image in the admin floor plan editor.</div></div>
        <img id="fpimg" src="" alt="" style="display:none;max-width:100%;max-height:560px;object-fit:contain;">
      </div>
    </div>
    <div class="mf"><button class="bl ol" onclick="closeM('mfp')">Close</button><button class="bl nv" onclick="toast('Print in live version.')">&#128424; Print</button></div>
  </div>
</div>

<div class="mb" id="mconf">
  <div class="modal">
    <div class="mh"><h3>Confirm Installation Date</h3><button class="mx" onclick="closeM('mconf')">&#10005;</button></div>
    <div class="mbody">
      <div class="di" style="margin-bottom:18px;"><div class="dl">Order</div><div class="dv" id="confinfo"></div></div>
      <div class="fg"><label>Confirmed Installation Date *</label><input type="date" id="conf_date_input"></div>
      <div class="fg"><label>Notes to Client (optional)</label><textarea id="conf_notes_input" placeholder="e.g. Crew will arrive 8-10 AM."></textarea></div>
      <div id="conf_err" style="display:none;color:#b91c1c;font-size:13px;margin-top:6px;"></div>
    </div>
    <div class="mf"><button class="bl ol" onclick="closeM('mconf')">Cancel</button><button class="bl gd" onclick="saveConf()">&#10003; Confirm &amp; Schedule</button></div>
  </div>
</div>

<div class="mb" id="madd">
  <div class="modal modal-xl">
    <div class="mh">
      <h3 id="madd_title">Add New Property</h3>
      <button class="mx" onclick="closeM('madd')">&#10005;</button>
    </div>
    <div class="mbody">
      <input type="hidden" id="madd_id">

      <!-- URL IMPORT STRIP -->
      <div class="import-strip">
        <span class="import-label">&#127760; Quick Import</span>
        <input type="url" id="madd_url" placeholder="Paste property website URL to auto-fill..." style="flex:1;">
        <button class="bs nv" onclick="importFromUrl()">Import</button>
      </div>

      <!-- TWO-COLUMN LAYOUT for top sections -->
      <div class="madd-cols">

        <!-- LEFT: Property Info + Address -->
        <div class="madd-col">
          <div class="ms"><div class="mst">Property Information</div>
            <div class="fg"><label>Property Name *</label>
              <input type="text" id="madd_name" placeholder="e.g. Cherry Creek Apartments"></div>
            <div class="fg"><label>Management Company</label>
              <input type="text" id="madd_mgmt" placeholder="e.g. Willow Bridge Property Co."></div>
            <div class="fg"><label>Website</label>
              <input type="url" id="madd_web" placeholder="https://"></div>
          </div>

          <div class="ms"><div class="mst">Address</div>
            <div class="fg"><label>Street Address *</label>
              <input type="text" id="madd_addr" placeholder="e.g. 1100 Crystal Spring Lane"></div>
            <div class="form-row">
              <div class="fg"><label>City *</label>
                <input type="text" id="madd_city" placeholder="e.g. Hermitage"></div>
              <div class="fg" style="max-width:80px;"><label>State</label>
                <select id="madd_state">
                  <option value="TN">TN</option><option value="MS">MS</option>
                  <option value="AR">AR</option><option value="AL">AL</option>
                  <option value="KY">KY</option><option value="GA">GA</option>
                </select></div>
              <div class="fg" style="max-width:100px;"><label>Zip *</label>
                <input type="text" id="madd_zip" placeholder="37076" maxlength="10"></div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Contact + Operations -->
        <div class="madd-col">
          <div class="ms"><div class="mst">Contact Information</div>
            <div class="fg"><label>Property Phone</label>
              <input type="tel" id="madd_phone" placeholder="(615) 229-8238"></div>
            <div class="fg"><label>Property Email</label>
              <input type="email" id="madd_email" placeholder="office@property.com"></div>
          </div>

          <div class="ms"><div class="mst">Operations</div>
            <div class="form-row">
              <div class="fg"><label>Total Units</label>
                <input type="number" id="madd_units" placeholder="e.g. 140" min="1"></div>
              <div class="fg"><label>Hub *</label>
                <select id="madd_hub">
                  <option value="">Select market...</option>
                </select></div>
              <div class="fg"><label>Status</label>
                <select id="madd_status">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select></div>
            </div>
            <div class="fg"><label>Notes (internal only)</label>
              <textarea id="madd_notes" rows="3" placeholder="Internal notes, access codes, special instructions..."></textarea></div>
          </div>
        </div>

      </div><!-- .madd-cols -->

      <!-- FLOOR PLANS SECTION (shown when editing an existing property) -->
      <div id="madd_fp_section" style="display:none;">
        <div class="ms">
          <div class="mst" style="display:flex;align-items:center;justify-content:space-between;">
            <span>Floor Plans</span>
            <button class="bs gd" id="madd_fp_addbtn" onclick="openAddFpInline()">+ Add Floor Plan</button>
          </div>
          <p style="font-size:12px;color:var(--gray);margin-bottom:14px;">
            Click a floor plan to assign rooms and preset installation scopes.
          </p>
          <div id="madd_fp_list"></div>
        </div>
      </div>

      <div id="madd_err" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#b91c1c;padding:10px 14px;border-radius:3px;font-size:13px;margin-top:8px;"></div>
    </div>
    <div class="mf">
      <button class="bl dn" id="madd_delbtn" style="display:none;margin-right:auto;" onclick="deleteProperty()">&#128465; Delete</button>
      <button class="bl ol" onclick="closeM('madd')">Cancel</button>
      <button class="bl gd" onclick="saveProperty()">Save Property</button>
    </div>
  </div>
</div>


<div class="mb" id="mfpe">
  <div class="modal modal-lg">
    <div class="mh">
      <h3 id="fpetitle">Add Floor Plan</h3>
      <button class="mx" onclick="closeM('mfpe')">&#10005;</button>
    </div>
    <div class="mbody">
      <input type="hidden" id="fpe_prop_id">
      <input type="hidden" id="fpe_fp_id">

      <!-- SECTION: Plan Details -->
      <div class="ms"><div class="mst">Plan Details</div>
        <div class="form-row">
          <div class="fg" style="flex:2;"><label>Plan Name *</label>
            <input type="text" id="fpe_name" placeholder="e.g. Ashford — 1 Bed / 1 Bath"></div>
          <div class="fg"><label>Sq Ft</label>
            <input type="text" id="fpe_sqft" placeholder="e.g. 735"></div>
          <div class="fg"><label>Units in Property</label>
            <input type="number" id="fpe_units" placeholder="e.g. 32" min="0"></div>
        </div>
        <div class="form-row">
          <div class="fg"><label>Bedrooms</label>
            <select id="fpe_beds">
              <option value="0">Studio</option><option value="1">1 Bed</option>
              <option value="2">2 Bed</option><option value="3">3 Bed</option>
              <option value="4">4 Bed</option>
            </select></div>
          <div class="fg"><label>Bathrooms</label>
            <select id="fpe_baths">
              <option value="1">1 Bath</option><option value="1.5">1.5 Bath</option>
              <option value="2">2 Bath</option><option value="2.5">2.5 Bath</option>
              <option value="3">3 Bath</option><option value="3.5">3.5 Bath</option>
              <option value="4">4 Bath</option>
            </select></div>
          <div class="fg"><label>Renovated</label>
            <select id="fpe_renov">
              <option value="false">Standard</option>
              <option value="true">Renovated</option>
            </select></div>
        </div>
      </div>

      <!-- SECTION: Rooms -->
      <div class="ms"><div class="mst">Rooms in Plan</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;" id="fpe_room_chips"></div>
        <div style="display:flex;gap:8px;">
          <input type="text" id="fpe_room_input" placeholder="Add room (e.g. Living Room)..." 
            style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();addRoomChip();}">
          <button class="bs nv" onclick="addRoomChip()">+ Add</button>
        </div>
        <div style="margin-top:8px;font-size:11px;color:var(--gray);">
          Quick add: 
          <span class="room-quick" onclick="addRoomChipVal('Living Room')">Living Room</span>
          <span class="room-quick" onclick="addRoomChipVal('Bedroom')">Bedroom</span>
          <span class="room-quick" onclick="addRoomChipVal('Kitchen')">Kitchen</span>
          <span class="room-quick" onclick="addRoomChipVal('Bathroom')">Bathroom</span>
          <span class="room-quick" onclick="addRoomChipVal('Dining Area')">Dining Area</span>
          <span class="room-quick" onclick="addRoomChipVal('Walk-in Closet')">Walk-in Closet</span>
          <span class="room-quick" onclick="addRoomChipVal('Laundry Room')">Laundry Room</span>
          <span class="room-quick" onclick="addRoomChipVal('Patio/Balcony')">Patio/Balcony</span>
        </div>
      </div>

      <!-- SECTION: Installation Images (3 named slots) -->
      <div class="ms"><div class="mst">Installation Documents</div>
        <p style="font-size:12px;color:var(--gray);margin-bottom:16px;">
          Each document can be printed individually for installers. Upload JPG, PNG, or PDF (max 10MB each).
        </p>
        <div class="img-slots">

          <!-- Slot 1: Floor Plan -->
          <div class="img-slot" id="slot_floorPlan">
            <div class="img-slot-hd">
              <div class="img-slot-label">&#127760; Floor Plan</div>
              <div style="display:flex;gap:6px;">
                <button class="bs ol img-slot-print" onclick="printSlot('floorPlan')" style="display:none;">&#128438; Print</button>
                <button class="bs dn img-slot-clear" onclick="clearSlot('floorPlan')" style="display:none;">&#10005; Remove</button>
              </div>
            </div>
            <div class="img-slot-drop" id="drop_floorPlan" onclick="triggerSlotUpload('floorPlan')">
              <div class="img-slot-icon">&#127760;</div>
              <div class="img-slot-hint">Click to upload floor plan image</div>
            </div>
            <div class="img-slot-preview" id="prev_floorPlan" style="display:none;">
              <img id="img_floorPlan" src="" alt="Floor Plan">
              <div class="img-slot-fname" id="fname_floorPlan"></div>
            </div>
            <input type="file" id="file_floorPlan" accept="image/*,.pdf" style="display:none;" onchange="handleSlotUpload('floorPlan',this)">
          </div>

          <!-- Slot 2: Seam Diagram -->
          <div class="img-slot" id="slot_seam">
            <div class="img-slot-hd">
              <div class="img-slot-label">&#9999; Seam Diagram</div>
              <div style="display:flex;gap:6px;">
                <button class="bs ol img-slot-print" onclick="printSlot('seam')" style="display:none;">&#128438; Print</button>
                <button class="bs dn img-slot-clear" onclick="clearSlot('seam')" style="display:none;">&#10005; Remove</button>
              </div>
            </div>
            <div class="img-slot-drop" id="drop_seam" onclick="triggerSlotUpload('seam')">
              <div class="img-slot-icon">&#9999;</div>
              <div class="img-slot-hint">Click to upload seam diagram</div>
            </div>
            <div class="img-slot-preview" id="prev_seam" style="display:none;">
              <img id="img_seam" src="" alt="Seam Diagram">
              <div class="img-slot-fname" id="fname_seam"></div>
            </div>
            <input type="file" id="file_seam" accept="image/*,.pdf" style="display:none;" onchange="handleSlotUpload('seam',this)">
          </div>

          <!-- Slot 3: Cut Sheet -->
          <div class="img-slot" id="slot_cutSheet">
            <div class="img-slot-hd">
              <div class="img-slot-label">&#9986; Cut Sheet</div>
              <div style="display:flex;gap:6px;">
                <button class="bs ol img-slot-print" onclick="printSlot('cutSheet')" style="display:none;">&#128438; Print</button>
                <button class="bs dn img-slot-clear" onclick="clearSlot('cutSheet')" style="display:none;">&#10005; Remove</button>
              </div>
            </div>
            <div class="img-slot-drop" id="drop_cutSheet" onclick="triggerSlotUpload('cutSheet')">
              <div class="img-slot-icon">&#9986;</div>
              <div class="img-slot-hint">Click to upload cut sheet</div>
            </div>
            <div class="img-slot-preview" id="prev_cutSheet" style="display:none;">
              <img id="img_cutSheet" src="" alt="Cut Sheet">
              <div class="img-slot-fname" id="fname_cutSheet"></div>
            </div>
            <input type="file" id="file_cutSheet" accept="image/*,.pdf" style="display:none;" onchange="handleSlotUpload('cutSheet',this)">
          </div>

        </div><!-- .img-slots -->
      </div>

      <!-- SECTION: Installation Scopes -->
      <div class="ms"><div class="mst">Preset Installation Scopes</div>
        <p style="font-size:12px;color:var(--gray);margin-bottom:14px;">
          Check the scopes that apply to this floor plan. These appear as quick-select options when clients submit an order.
        </p>
        <div id="fpe_scopes_list"></div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
          <input type="text" id="fpe_custom_scope" placeholder="Add custom scope for this plan..." style="flex:1;">
          <button class="bs nv" onclick="addCustomScope()">+ Add</button>
        </div>
      </div>

      <div id="fpe_err" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#b91c1c;padding:10px 14px;border-radius:3px;font-size:13px;margin-top:8px;"></div>
    </div>
    <div class="mf">
      <button class="bl dn" id="fpe_delbtn" style="display:none;margin-right:auto;" onclick="deleteFpFromModal()">&#128465; Delete Plan</button>
      <button class="bl ol" onclick="closeM('mfpe')">Cancel</button>
      <button class="bl gd" onclick="saveFpFromModal()">Save Floor Plan</button>
    </div>
  </div>
</div>

<div class="mb" id="muser">
  <div class="modal" style="max-width:620px;">
    <div class="mh"><h3>Add Client Login</h3><button class="mx" onclick="closeM('muser')">&#10005;</button></div>
    <div class="mbody">
      <div class="form-row">
        <div class="fg"><label>First Name *</label><input type="text" id="mu_first" placeholder="Jane"></div>
        <div class="fg"><label>Last Name *</label><input type="text" id="mu_last" placeholder="Smith"></div>
      </div>
      <div class="fg"><label>Email Address *</label><input type="email" id="mu_email" placeholder="jane@propertyco.com"></div>
      <div class="form-row">
        <div class="fg"><label>Password *</label><input type="password" id="mu_pw" placeholder="Min 8 characters"></div>
        <div class="fg"><label>Confirm Password *</label><input type="password" id="mu_pw2" placeholder="Repeat password"></div>
      </div>
      <div id="mu_err" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#b91c1c;padding:10px 14px;border-radius:3px;font-size:13px;margin-bottom:12px;"></div>
      <div class="form-row" style="align-items:flex-end;gap:8px;">
        <div class="fg" style="flex:2;">
          <label>Position / Role *</label>
          <select id="mu_role" style="width:100%;"></select>
        </div>
        <div class="fg" style="flex:1;min-width:130px;">
          <label style="white-space:nowrap;">+ Add Position</label>
          <div style="display:flex;gap:6px;">
            <input type="text" id="mu_new_pos" placeholder="New title..." style="flex:1;min-width:0;" onkeydown="if(event.key==='Enter'){addQuickPosition();event.preventDefault();}">
            <button class="bs gd" onclick="addQuickPosition()" style="white-space:nowrap;flex-shrink:0;">Add</button>
          </div>
        </div>
      </div>
      <div class="fg">
        <label>Assign to Properties * <span style="font-size:10px;font-weight:400;color:var(--gray);text-transform:none;letter-spacing:0;">Select one or more</span></label>
        <div style="margin-top:6px;margin-bottom:8px;display:flex;flex-direction:column;gap:6px;">
          <div style="position:relative;">
            <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--gray);pointer-events:none;font-size:14px;">&#128269;</span>
            <input type="text" id="mu_prop_search" placeholder="Search properties..." oninput="filterUserPropSearch(this.value)" style="width:100%;padding:8px 12px 8px 34px;border:1px solid var(--border);border-radius:var(--r);font-size:13px;box-sizing:border-box;">
          </div>
          <select id="mu_hub" onchange="filterUserProps(this.value)" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--r);font-size:13px;">
            <option value="all">All Markets</option>
          </select>
        </div>
        <div id="uproplist" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--r);padding:8px;"></div>
        <div id="mu_prop_count" style="font-size:11px;color:var(--gray);margin-top:5px;"></div>
      </div>
    </div>
    <div class="mf"><button class="bl ol" onclick="closeM('muser')">Cancel</button><button class="bl gd" onclick="saveNewUser()">Create Login</button></div>
  </div>
</div>


<div class="mb" id="mfpadd">
  <div class="modal">
    <div class="mh"><h3 id="mfpadd_title">Add Floor Plan</h3><button class="mx" onclick="closeM('mfpadd')">&#10005;</button></div>
    <div class="mbody">
      <input type="hidden" id="fpa_prop">
      <input type="hidden" id="fpa_id_orig">
      <div class="fg"><label>Plan Name *</label><input type="text" id="fpa_name" placeholder="e.g. Addison Renovated"></div>
      <div class="form-row">
        <div class="fg"><label>Sq Ft *</label><input type="text" id="fpa_sqft" placeholder="e.g. 735"></div>
        <div class="fg"><label>Bedrooms *</label>
          <select id="fpa_beds"><option value="0">Studio</option><option value="1">1 Bed</option><option value="2">2 Bed</option><option value="3">3 Bed</option><option value="4">4 Bed</option></select>
        </div>
        <div class="fg"><label>Bathrooms *</label>
          <select id="fpa_baths"><option value="1">1 Bath</option><option value="1.5">1.5 Bath</option><option value="2">2 Bath</option><option value="2.5">2.5 Bath</option><option value="3">3 Bath</option><option value="3.5">3.5 Bath</option><option value="4">4 Bath</option></select>
        </div>
      </div>
      <div class="fg"><label>Rooms (one per line)</label>
        <textarea id="fpa_rooms" rows="6" placeholder="Living Room&#10;Bedroom&#10;Kitchen&#10;Bathroom&#10;Walk-in Closet&#10;Patio/Balcony"></textarea>
      </div>
      <div id="fpa_err" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#b91c1c;padding:10px 14px;border-radius:3px;font-size:13px;"></div>
    </div>
    <div class="mf">
      <button class="bl dn" id="fpa_delbtn" style="display:none;margin-right:auto;padding:10px 20px;font-size:12px;" onclick="deleteFloorPlan()">&#128465; Delete</button>
      <button class="bl ol" onclick="closeM('mfpadd')">Cancel</button>
      <button class="bl gd" onclick="saveFloorPlan()">Save Floor Plan</button>
    </div>
  </div>
</div>

<div class="mb" id="mteam">
  <div class="modal" style="max-width:680px;">
    <div class="mh"><h3>Add Portal User</h3><button class="mx" onclick="closeM('mteam')">&#10005;</button></div>
    <div class="mbody">
      <div class="form-row">
        <div class="fg"><label>First Name *</label><input type="text" id="tm_first" placeholder="Jane"></div>
        <div class="fg"><label>Last Name *</label><input type="text" id="tm_last" placeholder="Smith"></div>
      </div>
      <div class="fg"><label>Email Address *</label><input type="email" id="tm_email" placeholder="jane@protectiveflooring.com"></div>
      <div class="form-row">
        <div class="fg"><label>Password *</label><input type="password" id="tm_pw" placeholder="Min 8 characters"></div>
        <div class="fg"><label>Confirm Password *</label><input type="password" id="tm_pw2" placeholder="Repeat password"></div>
      </div>
      <div class="form-row">
        <div class="fg"><label>Role / Access Level *</label>
          <select id="tm_role" onchange="syncPermCheckboxes('tm')">
            <option value="superadmin">&#128737; Super Admin — Full system access + user management + settings</option>
            <option value="admin" selected>&#128274; Admin — Orders, properties, client logins, reports</option>
            <option value="management">&#127970; Management — Orders, properties, leads &amp; proposals, reports</option>
            <option value="sales">&#128200; Sales — Leads, proposals, view orders</option>
            <option value="editor">&#9998; Editor — Create &amp; edit orders and floor plans</option>
          </select>
        </div>
        <div class="fg" style="max-width:180px;"><label>Default Hub</label>
          <select id="tm_hub">
            <option value="">All Hubs</option>
          </select>
        </div>
      </div>
      <div class="role-defaults-hint">&#8505;&#65039; Permissions below are pre-set based on the selected role. You can customize individual access for this user.</div>
      <!-- PERMISSIONS -->
      <div class="perm-section" style="margin-top:14px;">
        <div class="perm-section-hd">&#9783; Orders &amp; Work</div>
        <div class="perm-rows">
          <label class="perm-row"><input type="checkbox" id="tm_p_view_orders"> <span class="perm-row-label">View Orders</span><span class="perm-row-desc">See all work orders &amp; dashboard</span></label>
          <label class="perm-row"><input type="checkbox" id="tm_p_edit_orders"> <span class="perm-row-label">Create &amp; Edit Orders</span><span class="perm-row-desc">Submit and modify work orders</span></label>
          <label class="perm-row"><input type="checkbox" id="tm_p_void_orders"> <span class="perm-row-label">Void / Cancel Orders</span><span class="perm-row-desc">Mark orders void or cancelled</span></label>
          <label class="perm-row"><input type="checkbox" id="tm_p_confirm_orders"> <span class="perm-row-label">Confirm &amp; Schedule Orders</span><span class="perm-row-desc">Set install dates and confirm jobs</span></label>
        </div>
      </div>
      <div class="perm-section">
        <div class="perm-section-hd">&#127968; Properties &amp; Floor Plans</div>
        <div class="perm-rows">
          <label class="perm-row"><input type="checkbox" id="tm_p_view_props"> <span class="perm-row-label">View Properties</span><span class="perm-row-desc">Browse property list and details</span></label>
          <label class="perm-row"><input type="checkbox" id="tm_p_edit_props"> <span class="perm-row-label">Add &amp; Edit Properties</span><span class="perm-row-desc">Create and modify property records</span></label>
          <label class="perm-row"><input type="checkbox" id="tm_p_edit_fps"> <span class="perm-row-label">Manage Floor Plans</span><span class="perm-row-desc">Add, edit, and delete floor plans</span></label>
        </div>
      </div>
      <div class="perm-section">
        <div class="perm-section-hd">&#128200; Sales &amp; Proposals</div>
        <div class="perm-rows">
          <label class="perm-row"><input type="checkbox" id="tm_p_leads"> <span class="perm-row-label">Leads &amp; CRM</span><span class="perm-row-desc">Access lead tracker and contacts</span></label>
          <label class="perm-row"><input type="checkbox" id="tm_p_proposals"> <span class="perm-row-label">Proposals &amp; Pricing</span><span class="perm-row-desc">Create and send pricing proposals</span></label>
          <label class="perm-row"><input type="checkbox" id="tm_p_reports"> <span class="perm-row-label">Reports &amp; Analytics</span><span class="perm-row-desc">View revenue and performance data</span></label>
        </div>
      </div>
      <div class="perm-section">
        <div class="perm-section-hd">&#128274; Admin Controls</div>
        <div class="perm-rows">
          <label class="perm-row"><input type="checkbox" id="tm_p_clients"> <span class="perm-row-label">Client Logins</span><span class="perm-row-desc">Add and manage client portal access</span></label>
          <label class="perm-row"><input type="checkbox" id="tm_p_users"> <span class="perm-row-label">Portal Users</span><span class="perm-row-desc">Add, edit, and manage team users</span></label>
          <label class="perm-row"><input type="checkbox" id="tm_p_settings"> <span class="perm-row-label">Portal Settings</span><span class="perm-row-desc">Scopes, markets, service types, branding</span></label>
        </div>
      </div>
      <div id="tm_err" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#b91c1c;padding:10px 14px;border-radius:3px;font-size:13px;margin-top:12px;"></div>
    </div>
    <div class="mf">
      <button class="bl ol" onclick="closeM('mteam')">Cancel</button>
      <button class="bl gd" onclick="saveNewTeamUser()">Create User</button>
    </div>
  </div>
</div>

<div class="mb" id="mteamedit">
  <div class="modal" style="max-width:680px;">
    <div class="mh"><h3>Edit Portal User</h3><button class="mx" onclick="closeM('mteamedit')">&#10005;</button></div>
    <div class="mbody">
      <input type="hidden" id="te_id">
      <div class="form-row">
        <div class="fg"><label>First Name *</label><input type="text" id="te_first"></div>
        <div class="fg"><label>Last Name *</label><input type="text" id="te_last"></div>
      </div>
      <div class="fg"><label>Email Address *</label><input type="email" id="te_email"></div>
      <div class="ms" style="margin-bottom:16px;">
        <div class="mst">Reset Password <span style="font-size:10px;font-weight:400;color:var(--gray);text-transform:none;letter-spacing:0;">(leave blank to keep current)</span></div>
        <div class="form-row">
          <div class="fg" style="margin-bottom:0;"><label>New Password</label><input type="password" id="te_pw" placeholder="Leave blank to keep current"></div>
          <div class="fg" style="margin-bottom:0;"><label>Confirm</label><input type="password" id="te_pw2"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="fg"><label>Role / Access Level</label>
          <select id="te_role" onchange="syncPermCheckboxes('te')">
            <option value="superadmin">&#128737; Super Admin — Full system access + user management + settings</option>
            <option value="admin">&#128274; Admin — Orders, properties, client logins, reports</option>
            <option value="management">&#127970; Management — Orders, properties, leads &amp; proposals, reports</option>
            <option value="sales">&#128200; Sales — Leads, proposals, view orders</option>
            <option value="editor">&#9998; Editor — Create &amp; edit orders and floor plans</option>
          </select>
        </div>
        <div class="fg" style="max-width:160px;"><label>Default Hub</label>
          <select id="te_hub">
            <option value="">All Hubs</option>
          </select>
        </div>
        <div class="fg" style="max-width:160px;"><label>Status</label>
          <select id="te_status">
            <option value="active">Active</option>
            <option value="inactive">Inactive / Suspended</option>
          </select>
        </div>
      </div>
      <div class="role-defaults-hint">&#8505;&#65039; Permissions are pre-set by role. Customize individual access as needed — changes here override the role defaults.</div>
      <!-- PERMISSIONS -->
      <div class="perm-section" style="margin-top:14px;">
        <div class="perm-section-hd">&#9783; Orders &amp; Work</div>
        <div class="perm-rows">
          <label class="perm-row"><input type="checkbox" id="te_p_view_orders"> <span class="perm-row-label">View Orders</span><span class="perm-row-desc">See all work orders &amp; dashboard</span></label>
          <label class="perm-row"><input type="checkbox" id="te_p_edit_orders"> <span class="perm-row-label">Create &amp; Edit Orders</span><span class="perm-row-desc">Submit and modify work orders</span></label>
          <label class="perm-row"><input type="checkbox" id="te_p_void_orders"> <span class="perm-row-label">Void / Cancel Orders</span><span class="perm-row-desc">Mark orders void or cancelled</span></label>
          <label class="perm-row"><input type="checkbox" id="te_p_confirm_orders"> <span class="perm-row-label">Confirm &amp; Schedule Orders</span><span class="perm-row-desc">Set install dates and confirm jobs</span></label>
        </div>
      </div>
      <div class="perm-section">
        <div class="perm-section-hd">&#127968; Properties &amp; Floor Plans</div>
        <div class="perm-rows">
          <label class="perm-row"><input type="checkbox" id="te_p_view_props"> <span class="perm-row-label">View Properties</span><span class="perm-row-desc">Browse property list and details</span></label>
          <label class="perm-row"><input type="checkbox" id="te_p_edit_props"> <span class="perm-row-label">Add &amp; Edit Properties</span><span class="perm-row-desc">Create and modify property records</span></label>
          <label class="perm-row"><input type="checkbox" id="te_p_edit_fps"> <span class="perm-row-label">Manage Floor Plans</span><span class="perm-row-desc">Add, edit, and delete floor plans</span></label>
        </div>
      </div>
      <div class="perm-section">
        <div class="perm-section-hd">&#128200; Sales &amp; Proposals</div>
        <div class="perm-rows">
          <label class="perm-row"><input type="checkbox" id="te_p_leads"> <span class="perm-row-label">Leads &amp; CRM</span><span class="perm-row-desc">Access lead tracker and contacts</span></label>
          <label class="perm-row"><input type="checkbox" id="te_p_proposals"> <span class="perm-row-label">Proposals &amp; Pricing</span><span class="perm-row-desc">Create and send pricing proposals</span></label>
          <label class="perm-row"><input type="checkbox" id="te_p_reports"> <span class="perm-row-label">Reports &amp; Analytics</span><span class="perm-row-desc">View revenue and performance data</span></label>
        </div>
      </div>
      <div class="perm-section">
        <div class="perm-section-hd">&#128274; Admin Controls</div>
        <div class="perm-rows">
          <label class="perm-row"><input type="checkbox" id="te_p_clients"> <span class="perm-row-label">Client Logins</span><span class="perm-row-desc">Add and manage client portal access</span></label>
          <label class="perm-row"><input type="checkbox" id="te_p_users"> <span class="perm-row-label">Portal Users</span><span class="perm-row-desc">Add, edit, and manage team users</span></label>
          <label class="perm-row"><input type="checkbox" id="te_p_settings"> <span class="perm-row-label">Portal Settings</span><span class="perm-row-desc">Scopes, markets, service types, branding</span></label>
        </div>
      </div>
      <div id="te_err" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#b91c1c;padding:10px 14px;border-radius:3px;font-size:13px;margin-top:12px;"></div>
    </div>
    <div class="mf">
      <button class="bl dn" style="margin-right:auto;padding:10px 20px;font-size:12px;" onclick="deleteTeamUser()">&#128465; Delete</button>
      <button class="bl ol" onclick="closeM('mteamedit')">Cancel</button>
      <button class="bl gd" onclick="saveEditTeamUser()">Save Changes</button>
    </div>
  </div>
</div>

<div class="mb" id="medit">
  <div class="modal">
    <div class="mh"><h3>Edit Client Login</h3><button class="mx" onclick="closeM('medit')">&#10005;</button></div>
    <div class="mbody">
      <input type="hidden" id="eu_id">
      <div class="form-row">
        <div class="fg"><label>First Name *</label><input type="text" id="eu_first"></div>
        <div class="fg"><label>Last Name *</label><input type="text" id="eu_last"></div>
      </div>
      <div class="fg"><label>Email Address *</label><input type="email" id="eu_email"></div>
      <div class="ms" style="margin-bottom:16px;">
        <div class="mst">Reset Password <span style="font-size:10px;font-weight:400;color:var(--gray);text-transform:none;letter-spacing:0;">(leave blank to keep current)</span></div>
        <div class="form-row">
          <div class="fg" style="margin-bottom:0;"><label>New Password</label><input type="password" id="eu_pw" placeholder="Leave blank to keep current"></div>
          <div class="fg" style="margin-bottom:0;"><label>Confirm Password</label><input type="password" id="eu_pw2" placeholder="Repeat if changing"></div>
        </div>
      </div>
      <div class="fg"><label>Position / Role</label>
        <select id="eu_role" style="width:100%;"></select>
      </div>
      <div class="fg"><label>Status</label>
        <select id="eu_status">
          <option value="active">Active</option>
          <option value="inactive">Inactive / Suspended</option>
        </select>
      </div>
      <div id="eu_err" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#b91c1c;padding:10px 14px;border-radius:3px;font-size:13px;"></div>
    </div>
    <div class="mf">
      <button class="bl dn" style="margin-right:auto;padding:10px 20px;font-size:12px;" onclick="deleteUser()">&#128465; Delete User</button>
      <button class="bl ol" onclick="closeM('medit')">Cancel</button>
      <button class="bl gd" onclick="saveEditUser()">Save Changes</button>
    </div>
  </div>
</div>

<div class="toast" id="toastEl"><span>&#10003;</span><span id="toastmsg"></span></div>
<!-- EDIT WORK ORDER MODAL -->
<div class="mb" id="mwoedit">
  <div class="modal" style="max-width:700px;width:700px;">
    <div class="mh">
      <div>
        <h3 id="woedit_title">Edit Work Order</h3>
        <div id="woedit_num" style="font-size:12px;color:var(--gray);margin-top:2px;"></div>
      </div>
      <button class="mx" onclick="closeM('mwoedit')">&#10005;</button>
    </div>
    <div class="mbody">
      <div class="ms"><div class="mst">Property &amp; Unit</div>
        <div class="form-row">
          <div class="fg" style="flex:2;"><label>Property</label>
            <select id="woedit_prop" onchange="woeditPropChange()"></select></div>
          <div class="fg"><label>Unit Number</label>
            <input type="text" id="woedit_unit" placeholder="e.g. 214"></div>
        </div>
        <div class="form-row" style="margin-top:8px;">
          <div class="fg"><label>Floor Plan</label>
            <select id="woedit_plan"><option value="">-- Select --</option></select></div>
          <div class="fg"><label>Occupancy</label>
            <select id="woedit_occ"><option value="Vacant">Vacant</option><option value="Occupied">Occupied</option></select></div>
          <div class="fg"><label>Hub</label>
            <select id="woedit_hub"><option value="Memphis">Memphis</option><option value="Nashville">Nashville</option></select></div>
          <div class="fg"><label>Status</label>
            <select id="woedit_status">
              <option value="requested">Requested</option>
              <option value="scheduled">Scheduled</option>
              <option value="completed">Completed</option>
            </select></div>
        </div>
      </div>
      <div class="ms"><div class="mst">Service &amp; Scope</div>
        <div class="form-row">
          <div class="fg" style="flex:2;"><label>Flooring Service</label>
            <select id="woedit_service">
              <option value="">-- Select Service --</option>
              <option>Carpet Installation</option><option>Luxury Vinyl Plank (LVP)</option>
              <option>Sheet Vinyl</option><option>Tile Installation</option>
              <option>Pet Seal Treatment</option><option>Subfloor Repair</option>
              <option>Repair</option><option>Call Back</option>
            </select></div>
        </div>
        <div class="fg" style="margin-top:10px;"><label>Scope of Work <span style="font-size:11px;font-weight:400;color:var(--gray);">(one item per line)</span></label>
          <textarea id="woedit_scope" rows="4" placeholder="Living Room&#10;Bedroom 1&#10;Hallway" style="resize:vertical;"></textarea></div>
      </div>
      <div class="ms"><div class="mst">Scheduling</div>
        <div class="form-row">
          <div class="fg"><label>Requested Install Date</label><input type="date" id="woedit_reqdate"></div>
          <div class="fg"><label>Confirmed Date <span style="font-size:11px;font-weight:400;color:var(--gray);">(leave blank if pending)</span></label><input type="date" id="woedit_confdate"></div>
          <div class="fg"><label>Time Window</label>
            <select id="woedit_timewindow">
              <option value="To be confirmed">To be confirmed</option>
              <option value="Morning (7 AM - 12 PM)">Morning (7 AM - 12 PM)</option>
              <option value="Afternoon (12 PM - 5 PM)">Afternoon (12 PM - 5 PM)</option>
              <option value="No Preference">No Preference</option>
            </select></div>
        </div>
      </div>
      <div class="ms"><div class="mst">Notes &amp; Instructions</div>
        <div class="fg"><textarea id="woedit_notes" rows="3" placeholder="Special instructions, damage notes, access info..." style="resize:vertical;"></textarea></div>
      </div>
      <div class="ms" style="background:#fffbeb;border:1px solid #fde68a;border-radius:4px;padding:14px 16px;">
        <div style="font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#b45309;margin-bottom:8px;">&#9998; Reason for Edit <span style="color:#b91c1c;">*</span></div>
        <select id="woedit_reason_sel" onchange="toggleWoEditOther(this.value)" style="margin-bottom:8px;">
          <option value="">-- Select reason --</option>
          <option>Date change</option><option>Scope of work updated</option>
          <option>Service type correction</option><option>Unit number correction</option>
          <option>Property or address correction</option><option>Status update</option>
          <option>Customer request</option><option value="Other">Other (specify)</option>
        </select>
        <textarea id="woedit_reason_other" placeholder="Describe the reason..." style="display:none;resize:vertical;min-height:60px;"></textarea>
      </div>
      <div id="woedit_err" style="display:none;color:#b91c1c;font-size:13px;margin-top:10px;padding:8px 12px;background:#fef2f2;border-radius:4px;"></div>
    </div>
    <div class="mf">
      <button class="bs ol" onclick="closeM('mwoedit')">Cancel</button>
      <button class="bl gd" onclick="saveWoEdit()">&#10003; Save Changes</button>
    </div>
  </div>
</div>

<!-- VOID / CANCEL WORK ORDER MODAL -->
<div class="mb" id="mvoid">
  <div class="modal" style="max-width:480px;">
    <div class="mh">
      <h3>&#128683; Cancel Work Order</h3>
      <button class="mx" onclick="closeM('mvoid')">&#10005;</button>
    </div>
    <div class="mbody">
      <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:4px;padding:14px 16px;margin-bottom:20px;">
        <strong style="color:#b91c1c;">&#9888; This action cannot be undone.</strong>
        <p style="font-size:13px;color:#7f1d1d;margin-top:4px;">The work order will be marked <strong>VOID</strong> and removed from the active queue. A cancellation record will be saved.</p>
      </div>
      <div id="void_wo_info" style="font-size:13px;color:var(--navy);font-weight:600;margin-bottom:16px;padding:10px 14px;background:var(--cream);border-radius:4px;border:1px solid var(--border);"></div>
      <div class="fg">
        <label>Reason for Cancellation <span style="color:var(--red);">*</span></label>
        <select id="void_reason_sel" onchange="toggleVoidCustom(this.value)" style="margin-bottom:8px;">
          <option value="">-- Select a reason --</option>
          <option value="Unit no longer vacant">Unit no longer vacant</option>
          <option value="Resident extended lease">Resident extended lease</option>
          <option value="Work order submitted in error">Work order submitted in error</option>
          <option value="Property using different vendor">Property using different vendor</option>
          <option value="Budget hold / approval pending">Budget hold / approval pending</option>
          <option value="Duplicate order">Duplicate order</option>
          <option value="Other">Other (specify below)</option>
        </select>
        <textarea id="void_reason_other" placeholder="Please describe the reason for cancellation..." style="display:none;resize:vertical;min-height:80px;"></textarea>
      </div>
      <div class="fg" style="margin-top:4px;">
        <label>Additional Notes <span style="font-size:11px;color:var(--gray);">(optional)</span></label>
        <textarea id="void_notes" placeholder="Any additional context, follow-up instructions, etc." style="resize:vertical;min-height:60px;"></textarea>
      </div>
    </div>
    <div class="mf">
      <button class="bs ol" onclick="closeM('mvoid')">Keep Order</button>
      <button class="bl dn" onclick="confirmVoidOrder()">&#128683; Confirm Cancellation</button>
    </div>
  </div>
</div>

</div>

<script>// ── DATA ──

// ── MARKETS ──
var DEFAULT_MARKETS = [
  {id:'mkt1', key:'memphis',   label:'Memphis',   address:'3846 Delp Street, Memphis, TN 38118',    phone:'(901) 794-4101'},
  {id:'mkt2', key:'nashville', label:'Nashville', address:'808 Overton Lea Rd, Nashville, TN 37220', phone:'(615) 988-5188'}
];
function loadMarkets() {
  try { var s=localStorage.getItem('pf_markets'); return s?JSON.parse(s):JSON.parse(JSON.stringify(DEFAULT_MARKETS)); }
  catch(e){ return JSON.parse(JSON.stringify(DEFAULT_MARKETS)); }
}
function saveMarkets(arr) { try { localStorage.setItem('pf_markets',JSON.stringify(arr)); } catch(e){} }
function getMarket(keyOrLabel) {
  if (!keyOrLabel) return null;
  var k = (keyOrLabel+'').toLowerCase();
  return loadMarkets().find(function(m){ return m.key===k || m.label.toLowerCase()===k; }) || null;
}
function hubBadgeHtml(hub) {
  var m = getMarket(hub);
  if (!hub) return '<span style="color:var(--gray);">—</span>';
  var lbl = m ? m.label : (hub.charAt(0).toUpperCase()+hub.slice(1));
  return '<span class="b hub-b" style="background:rgba(2,10,91,.08);color:var(--navy);border:1px solid rgba(2,10,91,.15);">'+lbl+'</span>';
}
// Populate a <select> with hub options (label as value, for orders)
function populateHubSelect(elId, selectedVal, allLabel) {
  var el = document.getElementById(elId); if (!el) return;
  var cur = selectedVal !== undefined ? selectedVal : el.value;
  var html = '<option value="">'+(allLabel||'All Hubs')+'</option>';
  loadMarkets().forEach(function(m){ html+='<option value="'+m.label+'"'+(m.label===cur?' selected':'')+'>'+m.label+'</option>'; });
  el.innerHTML = html;
}
// Populate a <select> with hub key options (key as value, for filtering)
function populateHubKeySelect(elId, selectedKey, allLabel) {
  var el = document.getElementById(elId); if (!el) return;
  var cur = selectedKey !== undefined ? selectedKey : el.value;
  var html = '<option value="">'+(allLabel||'All Hubs')+'</option>';
  loadMarkets().forEach(function(m){ html+='<option value="'+m.key+'"'+(m.key===cur?' selected':'')+'>'+m.label+'</option>'; });
  el.innerHTML = html;
}
// Populate a hub select for property add/edit (key as value, "X Hub" as label)
function populatePropHubSelect(elId, selectedKey) {
  var el = document.getElementById(elId); if (!el) return;
  var cur = selectedKey !== undefined ? selectedKey : el.value;
  var html = '';
  loadMarkets().forEach(function(m){ html+='<option value="'+m.key+'"'+(m.key===cur?' selected':'')+'>'+m.label+' Hub</option>'; });
  el.innerHTML = html;
}
// Populate All Markets select (for client login modal, key as value)
function populateAllMarketsSelect(elId, selectedKey) {
  var el = document.getElementById(elId); if (!el) return;
  var cur = selectedKey !== undefined ? selectedKey : el.value;
  var html = '<option value="all">All Markets</option>';
  loadMarkets().forEach(function(m){ html+='<option value="'+m.key+'"'+(m.key===cur?' selected':'')+'>'+m.label+'</option>'; });
  el.innerHTML = html;
}

// ── TEAM STORE ──
var DEFAULT_TEAM = [
  {id:"t1", email:"admin@protectiveflooring.com",  password:"PF-Admin-2025!", name:"PF Admin",       initials:"PA", role:"superadmin", hub:"",          status:"active", created:"Jan 1, 2025"},
  {id:"t2", email:"sarah@protectiveflooring.com",  password:"PF-Sarah-25!",  name:"Sarah Williams",  initials:"SW", role:"admin",      hub:"",          status:"active", created:"Jan 5, 2025"},
  {id:"t3", email:"james@protectiveflooring.com",  password:"PF-James-25!",  name:"James Carter",    initials:"JC", role:"management", hub:"Memphis",   status:"active", created:"Mar 1, 2025"},
  {id:"t4", email:"lisa@protectiveflooring.com",   password:"PF-Lisa-25!",   name:"Lisa Monroe",     initials:"LM", role:"sales",      hub:"Nashville", status:"active", created:"Apr 1, 2025"},
  {id:"t5", email:"derek@protectiveflooring.com",  password:"PF-Derek-25!",  name:"Derek Shaw",      initials:"DS", role:"editor",     hub:"Memphis",   status:"active", created:"Apr 15, 2025"}
];
function loadTeam() {
  try { var s=localStorage.getItem('pf_team'); return s?JSON.parse(s):JSON.parse(JSON.stringify(DEFAULT_TEAM)); } catch(e) { return JSON.parse(JSON.stringify(DEFAULT_TEAM)); }
}
function saveTeam(arr) { try { localStorage.setItem('pf_team',JSON.stringify(arr)); } catch(e) {} }
function getTeam() { return loadTeam(); }

// ── CLIENT LOGIN STORE ──
var DEFAULT_CLIENTS = [
  {id:"u1",email:"manager@cherrycreek.com",  password:"Cherry2025!", name:"Jessica Lane",   initials:"JL",props:["Cherry Creek Apartments"],  role:"Property Manager",hub:"nashville",status:"active", created:"Feb 20, 2025", lastLogin:"2/24/2026 9:15 AM CST",  lastLoginISO:"2026-02-24T15:15:00.000Z"},
  {id:"u2",email:"manager@riverside.com",    password:"PF-River25!", name:"Rachel Moore",   initials:"RM",props:["Riverside Apartments"],      role:"Property Manager",hub:"memphis",  status:"active", created:"Jan 10, 2025", lastLogin:"2/18/2026 2:42 PM CST",  lastLoginISO:"2026-02-18T20:42:00.000Z"},
  {id:"u3",email:"manager@arborridge.com",   password:"Arbor2025!",  name:"Keisha Davis",   initials:"KD",props:["Arbor Ridge Nashville"],      role:"Property Manager",hub:"nashville",status:"active", created:"Jan 15, 2025", lastLogin:"1/30/2026 11:03 AM CST", lastLoginISO:"2026-01-30T17:03:00.000Z"}
];
function loadUsers() {
  try { var s=localStorage.getItem('pf_users'); return s?JSON.parse(s):JSON.parse(JSON.stringify(DEFAULT_CLIENTS)); } catch(e) { return JSON.parse(JSON.stringify(DEFAULT_CLIENTS)); }
}
function saveUsers(arr) { try { localStorage.setItem('pf_users',JSON.stringify(arr)); } catch(e) {} }
function getUsers() { return loadUsers(); }

// ── PROPERTY STORE ──
var DEFAULT_PROPS = [
  {id:"prop-rv", name:"Riverside Apartments",      mgmt:"",                        addr:"3846 Delp Street",     city:"Memphis",   state:"TN",zip:"38118",phone:"(901) 362-7700",email:"office@riverside.com",   web:"",hub:"memphis",  units:100,status:"active", notes:"",created:"2024-01-10",deletedAt:null},
  {id:"prop-pk", name:"Parkview Commons",           mgmt:"",                        addr:"4820 Millbranch Road", city:"Memphis",   state:"TN",zip:"38116",phone:"(901) 396-6644",email:"manager@parkview.com",   web:"",hub:"memphis",  units:148,status:"active", notes:"",created:"2024-01-15",deletedAt:null},
  {id:"prop-co", name:"The Columns at Bartlett",    mgmt:"",                        addr:"7200 US-70",           city:"Bartlett",  state:"TN",zip:"38134",phone:"(901) 388-3300",email:"office@columns.com",     web:"",hub:"memphis",  units:72, status:"active", notes:"",created:"2024-03-01",deletedAt:null},
  {id:"prop-mg", name:"Magnolia Trace",             mgmt:"",                        addr:"1480 Goodman Road",    city:"Southaven", state:"MS",zip:"38671",phone:"(662) 349-4400",email:"leasing@magnoliatrace.com",web:"",hub:"memphis",  units:90, status:"active", notes:"",created:"2024-04-01",deletedAt:null},
  {id:"prop-wh", name:"Whitehaven Village",         mgmt:"",                        addr:"4100 Elvis Presley Blvd",city:"Memphis", state:"TN",zip:"38116",phone:"",              email:"",                       web:"",hub:"memphis",  units:55, status:"inactive",notes:"Inactive pending renovation",created:"2023-06-01",deletedAt:null},
  {id:"prop-cc", name:"Cherry Creek Apartments",    mgmt:"Willow Bridge Property Co.",addr:"1100 Crystal Spring Lane",city:"Hermitage",state:"TN",zip:"37076",phone:"(615) 229-8238",email:"manager@cherrycreek.com",web:"https://www.willowbridgepc.com/properties/cherry-creek-apartments-hermitage-tn",hub:"nashville",units:627,status:"active",notes:"",created:"2024-02-01",deletedAt:null},
  {id:"prop-ar", name:"Arbor Ridge Nashville",      mgmt:"",                        addr:"2940 Brick Church Pike",city:"Nashville",state:"TN",zip:"37207",phone:"(615) 228-5500",email:"leasing@arborridge.com", web:"",hub:"nashville",units:200,status:"active", notes:"",created:"2024-01-20",deletedAt:null},
  {id:"prop-rh", name:"The Reserve at Hermitage",   mgmt:"",                        addr:"600 Hermitage Ave",    city:"Hermitage", state:"TN",zip:"37076",phone:"(615) 883-7700",email:"office@reservehermitage.com",web:"",hub:"nashville",units:160,status:"active", notes:"",created:"2024-05-01",deletedAt:null}
];
function loadProps() {
  try { var s=localStorage.getItem('pf_props'); return s?JSON.parse(s):JSON.parse(JSON.stringify(DEFAULT_PROPS)); } catch(e) { return JSON.parse(JSON.stringify(DEFAULT_PROPS)); }
}
function saveProps(arr) { try { localStorage.setItem('pf_props',JSON.stringify(arr)); } catch(e) {} }
function getProps() { return loadProps(); }
// Return only visible (non-deleted, non-filtered) props
function getActiveProps() { return getProps().filter(function(pr){ return !pr.deletedAt || pr.deletedAt==='null'; }); }

// ── GLOBAL SCOPE STORE ──
var DEFAULT_SCOPES = [
  {id:"sc1",name:"Carpet Throughout",    svc:"Carpet Installation"},
  {id:"sc2",name:"Carpet Bedrooms Only", svc:"Carpet Installation"},
  {id:"sc3",name:"Vinyl Wet Areas",      svc:"Sheet Vinyl"},
  {id:"sc4",name:"Vinyl Wet + Dining",   svc:"Sheet Vinyl"},
  {id:"sc5",name:"LVP Throughout",       svc:"Luxury Vinyl Plank"},
  {id:"sc6",name:"Full Turnover",        svc:"Full Turnover Package"},
  {id:"sc7",name:"Subfloor Repair Only", svc:"Subfloor Repair"}
];
// ── Canonical service type list — used everywhere scopes reference a service ──
var DEFAULT_SERVICES = [
  {id:'svc1', name:'Carpet Installation'},
  {id:'svc2', name:'Luxury Vinyl Plank (LVP)'},
  {id:'svc3', name:'Sheet Vinyl'},
  {id:'svc4', name:'Tile Installation'},
  {id:'svc5', name:'Pet Seal Treatment'},
  {id:'svc6', name:'Subfloor Repair'},
  {id:'svc7', name:'Full Turnover Package'},
  {id:'svc8', name:'Repair'},
  {id:'svc9', name:'Call Back'}
];
// Live list — kept in sync with localStorage by saveServices()
var SVC_LIST = DEFAULT_SERVICES.map(function(s){ return s.name; });
function loadServices() {
  try {
    var s = localStorage.getItem('pf_services');
    return s ? JSON.parse(s) : JSON.parse(JSON.stringify(DEFAULT_SERVICES));
  } catch(e) { return JSON.parse(JSON.stringify(DEFAULT_SERVICES)); }
}
function saveServices(arr) {
  try { localStorage.setItem('pf_services', JSON.stringify(arr)); } catch(e) {}
  // Refresh SVC_LIST so all dropdowns stay in sync
  SVC_LIST = arr.map(function(s){ return s.name; });
}
function svcOptions(selected) {
  var list = loadServices();
  var html = '<option value="">No specific service</option>';
  list.forEach(function(s) {
    html += '<option value="' + s.name + '"' + (s.name === selected ? ' selected' : '') + '>' + s.name + '</option>';
  });
  return html;
}

function loadScopes() {
  try { var s=localStorage.getItem('pf_scopes'); return s?JSON.parse(s):JSON.parse(JSON.stringify(DEFAULT_SCOPES)); } catch(e) { return JSON.parse(JSON.stringify(DEFAULT_SCOPES)); }
}
function saveScopes(arr) { try { localStorage.setItem('pf_scopes',JSON.stringify(arr)); } catch(e) {} }

// ── FLOOR PLAN STORE ──
// Each floor plan stored under key pf_fp_{propId}
// Schema: {id, name, sqft, beds, baths, unitCount, renovated, rooms[], 
//          images:{floorPlan:{src,name}, seam:{src,name}, cutSheet:{src,name}},
//          scopes:["sc1","sc2",...], customScopes:[{name,svc}], status}
var DEFAULT_FP = {
  "prop-rv":[
    {id:"RV-1BR",    name:"1 Bed / 1 Bath",     sqft:"650", beds:1,baths:1,  unitCount:24,renovated:false,rooms:["Living Room","Bedroom","Kitchen","Bathroom","Hallway"],              images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"},
    {id:"RV-2BR1BA", name:"2 Bed / 1 Bath",     sqft:"850", beds:2,baths:1,  unitCount:36,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Kitchen","Bathroom","Hallway"],        images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3"],customScopes:[],status:"active"},
    {id:"RV-2BR2BA", name:"2 Bed / 2 Bath",     sqft:"1050",beds:2,baths:2,  unitCount:28,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Kitchen","Bath 1","Bath 2","Dining"],  images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3","sc4","sc6"],customScopes:[],status:"active"},
    {id:"RV-3BR2BA", name:"3 Bed / 2 Bath",     sqft:"1280",beds:3,baths:2,  unitCount:12,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bed 3","Kitchen","Bath 1","Bath 2","Dining","Laundry"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3","sc6"],customScopes:[],status:"active"}
  ],
  "prop-pk":[
    {id:"PV-1BR",    name:"1 Bed / 1 Bath",     sqft:"620", beds:1,baths:1,  unitCount:48,renovated:false,rooms:["Living Room","Bedroom","Kitchen","Bathroom"],                        images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"},
    {id:"PV-2BR1BA", name:"2 Bed / 1 Bath",     sqft:"820", beds:2,baths:1,  unitCount:60,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Kitchen","Bathroom"],                  images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3"],customScopes:[],status:"active"},
    {id:"PV-2BR2BA", name:"2 Bed / 2 Bath",     sqft:"980", beds:2,baths:2,  unitCount:40,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bath 1","Bath 2","Kitchen"],            images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3","sc6"],customScopes:[],status:"active"}
  ],
  "prop-co":[
    {id:"CO-2BR2BA",name:"2 Bed / 2 Bath",      sqft:"1100",beds:2,baths:2,  unitCount:40,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bath 1","Bath 2","Kitchen"],            images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"},
    {id:"CO-3BR2BA",name:"3 Bed / 2 Bath",      sqft:"1380",beds:3,baths:2,  unitCount:32,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bed 3","Bath 1","Bath 2","Kitchen","Dining"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc2","sc6"],customScopes:[],status:"active"}
  ],
  "prop-mg":[
    {id:"MG-1BR",   name:"1 Bed / 1 Bath",      sqft:"680", beds:1,baths:1,  unitCount:30,renovated:false,rooms:["Living Room","Bedroom","Kitchen","Bathroom"],                        images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"},
    {id:"MG-2BR2BA",name:"2 Bed / 2 Bath",      sqft:"1020",beds:2,baths:2,  unitCount:60,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bath 1","Bath 2"],                    images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"}
  ],
  "prop-cc":[
    {id:"CC-ASHFORD",    name:"Ashford",          sqft:"600", beds:1,baths:1,  unitCount:32,renovated:false,rooms:["Living Room","Bedroom","Kitchen","Bathroom","Patio/Balcony"],        images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"},
    {id:"CC-ASHFORD-R",  name:"Ashford",          sqft:"600", beds:1,baths:1,  unitCount:20,renovated:true, rooms:["Living Room","Bedroom","Kitchen","Bathroom","Patio/Balcony"],        images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"},
    {id:"CC-ADDISON",    name:"Addison",          sqft:"735", beds:1,baths:1,  unitCount:28,renovated:false,rooms:["Living Room","Bedroom","Kitchen","Bathroom","Dining Area","Patio/Balcony"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"},
    {id:"CC-ADDISON-R",  name:"Addison",          sqft:"735", beds:1,baths:1,  unitCount:20,renovated:true, rooms:["Living Room","Bedroom","Kitchen","Bathroom","Dining Area","Patio/Balcony"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"},
    {id:"CC-ASHLEY",     name:"Ashley",           sqft:"920", beds:1,baths:1,  unitCount:24,renovated:false,rooms:["Living Room","Bedroom","Kitchen","Bathroom","Walk-in Closet","Patio/Balcony"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"},
    {id:"CC-ASHLEY-R",   name:"Ashley",           sqft:"920", beds:1,baths:1,  unitCount:16,renovated:true, rooms:["Living Room","Bedroom","Kitchen","Bathroom","Walk-in Closet","Patio/Balcony"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"},
    {id:"CC-BRITTANY",   name:"Brittany",         sqft:"800", beds:2,baths:1,  unitCount:30,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Kitchen","Bathroom","Patio/Balcony"],  images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3"],customScopes:[],status:"active"},
    {id:"CC-BRITTANY-R", name:"Brittany",         sqft:"800", beds:2,baths:1,  unitCount:20,renovated:true, rooms:["Living Room","Bed 1","Bed 2","Kitchen","Bathroom","Patio/Balcony"],  images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3"],customScopes:[],status:"active"},
    {id:"CC-BERKLEY",    name:"Berkley",          sqft:"971", beds:2,baths:1,  unitCount:32,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Kitchen","Bathroom","Dining Area"],     images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3"],customScopes:[],status:"active"},
    {id:"CC-BERKLEY-R",  name:"Berkley",          sqft:"971", beds:2,baths:1,  unitCount:20,renovated:true, rooms:["Living Room","Bed 1","Bed 2","Kitchen","Bathroom","Dining Area"],     images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3"],customScopes:[],status:"active"},
    {id:"CC-CHARLESTON", name:"Charleston",       sqft:"1073",beds:2,baths:2,  unitCount:40,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bath 1","Bath 2","Kitchen","W/D Hookup"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3","sc6"],customScopes:[],status:"active"},
    {id:"CC-CHARLESTON-R",name:"Charleston",      sqft:"1073",beds:2,baths:2,  unitCount:24,renovated:true, rooms:["Living Room","Bed 1","Bed 2","Bath 1","Bath 2","Kitchen","W/D Hookup"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3","sc6"],customScopes:[],status:"active"},
    {id:"CC-CAMERON",    name:"Cameron",          sqft:"1100",beds:2,baths:2,  unitCount:36,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bath 1","Bath 2","Kitchen","Dining Area"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3","sc4","sc6"],customScopes:[],status:"active"},
    {id:"CC-CAMERON-R",  name:"Cameron",          sqft:"1100",beds:2,baths:2,  unitCount:20,renovated:true, rooms:["Living Room","Bed 1","Bed 2","Bath 1","Bath 2","Kitchen","Dining Area"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3","sc4","sc6"],customScopes:[],status:"active"},
    {id:"CC-CARLTON",    name:"Carlton",          sqft:"1289",beds:2,baths:2,  unitCount:28,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bath 1","Bath 2","Kitchen","Dining Area","W/D Hookup"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3","sc4","sc6"],customScopes:[],status:"active"},
    {id:"CC-CARLTON-R",  name:"Carlton",          sqft:"1289",beds:2,baths:2,  unitCount:16,renovated:true, rooms:["Living Room","Bed 1","Bed 2","Bath 1","Bath 2","Kitchen","Dining Area","W/D Hookup"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3","sc4","sc6"],customScopes:[],status:"active"},
    {id:"CC-DEVONSHIRE", name:"Devonshire",       sqft:"1402",beds:3,baths:2,  unitCount:20,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bed 3","Bath 1","Bath 2","Kitchen","Dining Area","W/D Hookup","Patio/Balcony"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc2","sc3","sc4","sc6"],customScopes:[],status:"active"},
    {id:"CC-DEVONSHIRE-R",name:"Devonshire",      sqft:"1402",beds:3,baths:2,  unitCount:12,renovated:true, rooms:["Living Room","Bed 1","Bed 2","Bed 3","Bath 1","Bath 2","Kitchen","Dining Area","W/D Hookup","Patio/Balcony"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc2","sc3","sc4","sc6"],customScopes:[],status:"active"}
  ],
  "prop-ar":[
    {id:"AR-STU",   name:"Studio",               sqft:"450", beds:0,baths:1,  unitCount:20,renovated:false,rooms:["Main Area","Kitchen","Bathroom"],                                     images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc5","sc3"],customScopes:[],status:"active"},
    {id:"AR-1BR",   name:"1 Bed / 1 Bath",        sqft:"700", beds:1,baths:1,  unitCount:80,renovated:false,rooms:["Living Room","Bedroom","Kitchen","Bathroom"],                        images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3","sc5"],customScopes:[],status:"active"},
    {id:"AR-2BR2BA",name:"2 Bed / 2 Bath",        sqft:"1080",beds:2,baths:2,  unitCount:60,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bath 1","Bath 2","Kitchen","Dining Area"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc4","sc6"],customScopes:[],status:"active"},
    {id:"AR-3BR2BA",name:"3 Bed / 2 Bath",        sqft:"1350",beds:3,baths:2,  unitCount:40,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bed 3","Bath 1","Bath 2","Kitchen","Dining Area","Laundry"],images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc2","sc3","sc6"],customScopes:[],status:"active"}
  ],
  "prop-rh":[
    {id:"RH-1BR",   name:"1 Bed / 1 Bath",        sqft:"660", beds:1,baths:1,  unitCount:60,renovated:false,rooms:["Living Room","Bedroom","Kitchen","Bathroom"],                        images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc3"],customScopes:[],status:"active"},
    {id:"RH-2BR2BA",name:"2 Bed / 2 Bath",        sqft:"1040",beds:2,baths:2,  unitCount:100,renovated:false,rooms:["Living Room","Bed 1","Bed 2","Bath 1","Bath 2"],                   images:{floorPlan:null,seam:null,cutSheet:null},scopes:["sc1","sc2","sc3","sc6"],customScopes:[],status:"active"}
  ]
};

function loadFpForProp(propId) {
  try {
    var s = localStorage.getItem('pf_fp_' + propId);
    if (s) return JSON.parse(s);
  } catch(e){}
  return JSON.parse(JSON.stringify(DEFAULT_FP[propId] || []));
}
function saveFpForProp(propId, arr) {
  try { localStorage.setItem('pf_fp_' + propId, JSON.stringify(arr)); } catch(e) {}
}
// Seed localStorage with default data on first load
(function seedAll() {
  Object.keys(DEFAULT_FP).forEach(function(k) {
    try { if (!localStorage.getItem('pf_fp_'+k)) saveFpForProp(k, JSON.parse(JSON.stringify(DEFAULT_FP[k]))); } catch(e){}
  });
  try { if (!localStorage.getItem('pf_scopes')) saveScopes(JSON.parse(JSON.stringify(DEFAULT_SCOPES))); } catch(e){}
  try { if (!localStorage.getItem('pf_props')) saveProps(JSON.parse(JSON.stringify(DEFAULT_PROPS))); } catch(e){}
})();

// ── Legacy aliases so existing order form still works ──
var fpByProp = {};
var fpDetails = {};
(function buildLegacy() {
  getActiveProps().forEach(function(prop) {
    var fps = loadFpForProp(prop.id);
    var legacyKey = prop.name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
    fpByProp[legacyKey] = fps.map(function(fp) {
      var label = fp.renovated ? fp.name + ' (Renovated)' : fp.name;
      return {id: fp.id, name: label, sqft: fp.sqft};
    });
    fps.forEach(function(fp) {
      fpDetails[fp.id] = {name: fp.name, sqft: fp.sqft+' sq ft', beds: fp.beds, baths: fp.baths, rooms: fp.rooms, renovated: fp.renovated};
    });
    // Also index by propId directly
    fpByProp[prop.id] = fpByProp[legacyKey];
  });
})();



// ── PROPERTY CARD RENDERING ──
var curHub = 'all';
function switchHub(hub, el) {
  curHub = hub;
  document.querySelectorAll('.tabs .tab').forEach(function(t){ t.classList.remove('on'); });
  el.classList.add('on');
  filterProps();
}
function filterProps() {
  var q = (document.getElementById('psearch')||{value:''}).value.toLowerCase();
  var sf = (document.getElementById('pstatus')||{value:''}).value;
  // Reset all counts to 0 before recounting
  var allEl = document.getElementById('call');
  if (allEl) allEl.textContent = '0';
  document.querySelectorAll('.tabs .tc').forEach(function(el){ el.textContent='0'; });
  var counts = {};
  var all = 0;
  document.querySelectorAll('#proplist .pr-card').forEach(function(card) {
    var hub=card.dataset.hub||'', nameCity=(card.dataset.name||'')+' '+(card.dataset.city||'')+' '+(card.dataset.zip||'');
    var status=card.dataset.status||'';
    var matchHub = curHub==='all'||hub===curHub;
    var matchQ = !q || nameCity.indexOf(q)>=0;
    var matchS = !sf || status===sf;
    var visible = matchHub && matchQ && matchS;
    card.style.display = visible ? '' : 'none';
    // Counts: always based on search+status match (not hub tab) so tabs show correct totals
    if (matchQ && matchS) {
      all++;
      counts[hub] = (counts[hub]||0) + 1;
    }
  });
  if (allEl) allEl.textContent = all;
  Object.keys(counts).forEach(function(hub) {
    var cEl = document.getElementById('c_'+hub);
    if (cEl) cEl.textContent = counts[hub];
  });
}
function togProp(card) {
  card.classList.toggle('open');
}function buildHubTabs() {
  var tabs = document.getElementById('hub_tabs');
  if (!tabs) return;
  var html = '<div class="tab on" onclick="switchHub(\'all\',this)">All <span class="tc" id="call">0</span></div>';
  loadMarkets().forEach(function(m) {
    html += '<div class="tab" onclick="switchHub(\''+m.key+'\',this)">&#128205; '+m.label+' <span class="tc" id="c_'+m.key+'">0</span></div>';
  });
  tabs.innerHTML = html;
}


function populateAllHubDropdowns() {
  populateHubSelect('adash_hub', '', 'All Hubs');
  populateHubSelect('aord_hub', '', 'All Hubs');
  populateHubKeySelect('ucl_hub', '', 'All Hubs');
  populateHubKeySelect('ch_hub_filter', '', 'All Hubs');
  populatePropHubSelect('madd_hub', 'memphis');
  populateAllMarketsSelect('mu_hub', 'all');
}




function renderPropList() {
  var list = document.getElementById('proplist');
  if (!list) return;
  buildHubTabs();
  // Apply login default hub if set, otherwise reset to 'all'
  var _defHub = window._loginDefaultHub || '';
  if (_defHub) {
    curHub = _defHub;
    // Highlight correct tab
    document.querySelectorAll('.tabs .tab').forEach(function(t){ t.classList.remove('on'); });
    var matchTab = document.querySelector('.tabs .tab[onclick*="\'' + _defHub + '\'"]');
    if (matchTab) matchTab.classList.add('on');
    else {
      document.querySelectorAll('.tabs .tab').forEach(function(t,i){ t.classList.toggle('on', i===0); });
      curHub = 'all';
    }
  } else {
    curHub = 'all';
    document.querySelectorAll('.tabs .tab').forEach(function(t,i){ t.classList.toggle('on', i===0); });
  }
  var props = getProps().filter(function(pr){ return !pr.deletedAt; });
  list.innerHTML = '';
  props.forEach(function(prop) {
    var fps = loadFpForProp(prop.id);
    var initials = prop.name.split(' ').slice(0,2).map(function(w){return w[0]||'';}).join('').toUpperCase();
    var hubBadge = hubBadgeHtml(prop.hub);
    var statusBadge = prop.status==='active'
      ? '<span class="b ac">Active</span>'
      : '<span class="b in">Inactive</span>';
    var pid = prop.id;
    var actionBtns = prop.status==='active'
      ? '<button class="bs ol" onclick="openEditProp(\'' + pid + '\');event.stopPropagation();">Edit</button>'
        +'<button class="bs dn" onclick="deactivateProp(\'' + pid + '\');event.stopPropagation();">Deactivate</button>'
      : '<button class="bs gd" onclick="reactivateProp(\'' + pid + '\');event.stopPropagation();">Reactivate</button>'
        +'<button class="bs ol" onclick="openEditProp(\'' + pid + '\');event.stopPropagation();">Edit</button>';
    // Floor plan table rows
    var fpRows = fps.map(function(fp) {
      var renovBadge = fp.renovated ? '<span class="chip" style="background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe;font-size:9px;padding:1px 5px;">RENOV</span>' : '';
      var bedsLabel = fp.beds===0 ? 'Studio' : fp.beds+'BR/'+fp.baths+'BA';
      var roomsHtml = (fp.rooms||[]).map(function(r){ return '<span class="chip">'+r+'</span>'; }).join('');
      var allScopes = getScopesForFp(fp);
      var scopesHtml = allScopes.map(function(s){ return '<span class="chip gd">'+s.name+'</span>'; }).join('');
      var imgBtns = (function() {
        var SLOTS = ['floorPlan','seam','cutSheet'];
        var ICONS = {floorPlan:'&#127760;',seam:'&#9999;',cutSheet:'&#9986;'};
        var LABELS = {floorPlan:'Floor Plan',seam:'Seam',cutSheet:'Cut Sheet'};
        return SLOTS.map(function(slot) {
          var hasImg = fp.images && fp.images[slot] && fp.images[slot].src;
          var cls = hasImg ? 'fp-img-btn has-img' : 'fp-img-btn no-img';
          var onclick = 'openFpDoc(\'' + prop.id + '\',\'' + fp.id + '\',\'' + slot + '\');event.stopPropagation();';
          return '<button class="' + cls + '" onclick="' + onclick + '" title="' + LABELS[slot] + '">' + ICONS[slot] + '</button>';
        }).join(' ');
      })();
      return '<tr>'
        +'<td><strong>'+fp.name+'</strong> '+renovBadge+'</td>'
        +'<td style="white-space:nowrap;">'+bedsLabel+'</td>'
        +'<td style="white-space:nowrap;">'+fp.sqft+' sqft</td>'
        +'<td>'+imgBtns+'</td>'
        +'<td>'+roomsHtml+'</td>'
        +'<td>'+scopesHtml+'</td>'
        +'<td><span class="b '+(fp.status==='active'?'ac':'in')+'">'+fp.status+'</span></td>'
        +'<td><button class="bs ol" data-prop="'+prop.id+'" data-fp="'+fp.id+'" onclick="editFpClick(this)">Edit</button></td>'
        +'</tr>';
    }).join('');

    var detailHtml = '';
    if (prop.mgmt) detailHtml += '<div class="pr-detail-item"><label>Management Co.</label><span>'+prop.mgmt+'</span></div>';
    if (prop.phone) detailHtml += '<div class="pr-detail-item"><label>Phone</label><span><a href="tel:'+prop.phone+'">'+prop.phone+'</a></span></div>';
    if (prop.email) detailHtml += '<div class="pr-detail-item"><label>Email</label><span><a href="mailto:'+prop.email+'">'+prop.email+'</a></span></div>';
    if (prop.web) detailHtml += '<div class="pr-detail-item"><label>Website</label><span><a href="'+prop.web+'" target="_blank" rel="noopener">View Site &#8599;</a></span></div>';
    if (prop.notes) detailHtml += '<div class="pr-detail-item" style="grid-column:1/-1;"><label>Notes</label><span>'+prop.notes+'</span></div>';

    var contactLine = [prop.phone, prop.email].filter(Boolean).join(' &nbsp;·&nbsp; ');

    var card = document.createElement('div');
    card.className = 'pr-card' + (prop.status!=='active' ? ' inactive-prop' : '');
    card.dataset.hub = prop.hub;
    card.dataset.name = prop.name.toLowerCase();
    card.dataset.city = (prop.city||'').toLowerCase();
    card.dataset.zip  = (prop.zip||'').toLowerCase();
    card.dataset.status = prop.status || 'active';
    card.innerHTML =
      '<div class="pr-header" onclick="openEditProp(\''+prop.id+'\');event.stopPropagation();" style="cursor:pointer;">'
        +'<div class="pr-avatar">'+initials+'</div>'
        +'<div class="pr-info">'
          +'<div class="pr-name">'+prop.name+'</div>'
          +'<div class="pr-addr">&#128205; '+prop.addr+', '+prop.city+', '+prop.state+' '+prop.zip+'</div>'
          +(contactLine ? '<div class="pr-contact">'+contactLine+'</div>' : '')
        +'</div>'
        +'<div class="pr-meta">'+hubBadge+'<span class="pp">'+prop.units+' Units</span>'+statusBadge+'</div>'
        +'<div class="pr-actions" onclick="event.stopPropagation()">'+actionBtns+'</div>'
        +'<span class="pr-chevron">&#9660;</span>'
      +'</div>'
      +'<div class="pr-body">'
        +(detailHtml ? '<div class="pr-section-title">Contact &amp; Details</div><div class="pr-detail-grid">'+detailHtml+'</div>' : '')
        +'<div class="pr-section-title">Floor Plans</div>'
        +'<div class="fp-table-wrap"><table class="fpt">'
          +'<thead><tr><th>Plan Name</th><th>Type</th><th>Size</th><th>Images</th><th>Rooms</th><th>Preset Scopes</th><th>Status</th><th></th></tr></thead>'
          +'<tbody>'+fpRows+'</tbody>'
        +'</table></div>'
        +'<button class="bs gd" data-prop="' + prop.id + '" onclick="addFpClick(this)">+ Add Floor Plan</button>'
      +'</div>';
    list.appendChild(card);
  });
  filterProps();
}

// ── PROPERTY CRUD ──
function openAddPropModal() {
  populatePropHubSelect('madd_hub', 'memphis');
  document.getElementById('madd_id').value = '';
  document.getElementById('madd_title').textContent = 'Add New Property';
  document.getElementById('madd_name').value = '';
  document.getElementById('madd_mgmt').value = '';
  document.getElementById('madd_web').value = '';
  document.getElementById('madd_addr').value = '';
  document.getElementById('madd_city').value = '';
  document.getElementById('madd_state').value = 'TN';
  document.getElementById('madd_zip').value = '';
  document.getElementById('madd_phone').value = '';
  document.getElementById('madd_email').value = '';
  document.getElementById('madd_units').value = '';
  document.getElementById('madd_hub').value = 'memphis';
  document.getElementById('madd_status').value = 'active';
  document.getElementById('madd_notes').value = '';
  document.getElementById('madd_url').value = '';
  document.getElementById('madd_err').style.display = 'none';
  document.getElementById('madd_delbtn').style.display = 'none';
  document.getElementById('madd_fp_section').style.display = 'none';
  openM('madd');
}

function openEditProp(propId) {
  var props = getActiveProps();
  var prop = null;
  for(var i=0;i<props.length;i++){ if(props[i].id===propId){prop=props[i];break;} }
  if (!prop) return;
  document.getElementById('madd_id').value = prop.id;
  document.getElementById('madd_title').textContent = 'Edit: ' + prop.name;
  document.getElementById('madd_name').value = prop.name||'';
  document.getElementById('madd_mgmt').value = prop.mgmt||'';
  document.getElementById('madd_web').value = prop.web||'';
  document.getElementById('madd_addr').value = prop.addr||'';
  document.getElementById('madd_city').value = prop.city||'';
  document.getElementById('madd_state').value = prop.state||'TN';
  document.getElementById('madd_zip').value = prop.zip||'';
  document.getElementById('madd_phone').value = prop.phone||'';
  document.getElementById('madd_email').value = prop.email||'';
  document.getElementById('madd_units').value = prop.units||'';
  document.getElementById('madd_hub').value = prop.hub||'memphis';
  document.getElementById('madd_status').value = prop.status||'active';
  document.getElementById('madd_notes').value = prop.notes||'';
  document.getElementById('madd_url').value = prop.web||'';
  document.getElementById('madd_err').style.display = 'none';
  var delbtn = document.getElementById('madd_delbtn');
  delbtn.style.display = (window.currentTeamUser && window.currentTeamUser.role==='superadmin') ? 'inline-flex' : 'none';
  // Show floor plan section and render it
  document.getElementById('madd_fp_section').style.display = 'block';
  document.getElementById('madd_fp_addbtn').dataset.prop = propId;
  renderInlineFpList(propId);
  openM('madd');
}
function saveProperty() {
  var name = (document.getElementById('madd_name').value||'').trim();
  var addr = (document.getElementById('madd_addr').value||'').trim();
  var city = (document.getElementById('madd_city').value||'').trim();
  var zip  = (document.getElementById('madd_zip').value||'').trim();
  if (!name||!addr||!city||!zip) {
    var err = document.getElementById('madd_err');
    err.textContent = 'Please fill in Property Name, Street Address, City, and Zip.';
    err.style.display = 'block'; return;
  }
  var props = getProps();
  var id = document.getElementById('madd_id').value;
  var isNew = !id;
  if (isNew) id = 'prop-' + Date.now().toString(36);
  var obj = {
    id:id, name:name,
    mgmt:(document.getElementById('madd_mgmt').value||'').trim(),
    addr:addr, city:city,
    state:document.getElementById('madd_state').value,
    zip:zip,
    phone:(document.getElementById('madd_phone').value||'').trim(),
    email:(document.getElementById('madd_email').value||'').trim(),
    web:(document.getElementById('madd_web').value||'').trim(),
    hub:document.getElementById('madd_hub').value,
    units:parseInt(document.getElementById('madd_units').value)||0,
    status:document.getElementById('madd_status').value,
    notes:(document.getElementById('madd_notes').value||'').trim(),
    created: isNew ? new Date().toISOString().slice(0,10) : null,
    deletedAt: null
  };
  if (!isNew) {
    // preserve created date
    for(var i=0;i<props.length;i++){
      if(props[i].id===id){ obj.created=props[i].created; break; }
    }
    props = props.map(function(pr){ return pr.id===id ? obj : pr; });
  } else {
    props.push(obj);
  }
  saveProps(props);
  closeM('madd');
  renderPropList();
  rebuildLegacy();
  toast(isNew ? 'Property added.' : 'Property updated.');
}
function deactivateProp(propId) {
  if (!confirm('Deactivate this property? It will be hidden from clients but can be reactivated later.')) return;
  var props = getProps().map(function(pr){
    return pr.id===propId ? Object.assign({},pr,{status:'inactive'}) : pr;
  });
  saveProps(props);
  renderPropList();
  toast('Property deactivated.');
}
function reactivateProp(propId) {
  var props = getProps().map(function(pr){
    return pr.id===propId ? Object.assign({},pr,{status:'active'}) : pr;
  });
  saveProps(props);
  renderPropList();
  toast('Property reactivated.');
}
function deleteProperty() {
  var id = document.getElementById('madd_id').value;
  if (!id) return;
  if (!confirm('Permanently hide this property? It will not be deleted from the database but will no longer appear anywhere. A superadmin can restore it.')) return;
  var props = getProps().map(function(pr){
    return pr.id===id ? Object.assign({},pr,{deletedAt: new Date().toISOString()}) : pr;
  });
  saveProps(props);
  closeM('madd');
  renderPropList();
  rebuildLegacy();
  toast('Property removed.');
}

// ── URL IMPORT ──
function importFromUrl() {
  var url = (document.getElementById('madd_url').value||'').trim();
  if (!url) { toast('Please enter a URL first.'); return; }
  // Extract property name from URL path segments
  var name = '';
  try {
    var u = new URL(url);
    // Take the last meaningful path segment, clean hyphens
    var segs = u.pathname.split('/').filter(function(s){return s.length>2;});
    if (segs.length) {
      var last = segs[segs.length-1].replace(/-/g,' ').replace(/\.html$/,'');
      name = last.split(' ').map(function(w){return w.charAt(0).toUpperCase()+w.slice(1);}).join(' ');
    }
    // Pre-fill website
    document.getElementById('madd_web').value = url;
    // Try to detect city from path (common URL pattern: property-name-city-state)
    var parts = last ? last.split(' ') : [];
    var stateAbbrs = ['tn','ms','al','ar','ky','ga'];
    var stateIdx = parts.findIndex(function(p){ return stateAbbrs.indexOf(p.toLowerCase())>=0; });
    if (stateIdx > 0) {
      var city = parts.slice(stateIdx-1, stateIdx).join(' ');
      var state = parts[stateIdx].toUpperCase();
      if (city) document.getElementById('madd_city').value = city.charAt(0).toUpperCase()+city.slice(1);
      if (state) document.getElementById('madd_state').value = state;
      // Remove city+state from name
      name = parts.slice(0, stateIdx-1).map(function(w){return w.charAt(0).toUpperCase()+w.slice(1);}).join(' ');
    }
  } catch(e) {}
  if (name) document.getElementById('madd_name').value = name;
  toast('Auto-filled from URL. Please review and complete the form.');
}

// Rebuild legacy fpByProp/fpDetails when properties change
function rebuildLegacy() {
  getActiveProps().forEach(function(prop) {
    var fps = loadFpForProp(prop.id);
    var legacyKey = prop.name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
    fpByProp[legacyKey] = fps.map(function(fp) {
      var label = fp.renovated ? fp.name + ' (Renovated)' : fp.name;
      return {id: fp.id, name: label, sqft: fp.sqft};
    });
    fps.forEach(function(fp) {
      fpDetails[fp.id] = {name:fp.name,sqft:fp.sqft+' sq ft',beds:fp.beds,baths:fp.baths,rooms:fp.rooms,renovated:fp.renovated};
    });
    fpByProp[prop.id] = fpByProp[legacyKey];
  });
}

// ── FLOOR PLAN EDITOR ──
var _fpeRooms = [];
var _fpeImages = {floorPlan:null, seam:null, cutSheet:null};

function openAddFpForProp(propId) {
  _fpeRooms = [];
  _fpeImages = {floorPlan:null, seam:null, cutSheet:null};
  document.getElementById('fpetitle').textContent = 'Add Floor Plan';
  document.getElementById('fpe_prop_id').value = propId;
  document.getElementById('fpe_fp_id').value = '';
  document.getElementById('fpe_name').value = '';
  document.getElementById('fpe_sqft').value = '';
  document.getElementById('fpe_units').value = '';
  document.getElementById('fpe_beds').value = '1';
  document.getElementById('fpe_baths').value = '1';
  document.getElementById('fpe_renov').value = 'false';
  document.getElementById('fpe_delbtn').style.display = 'none';
  document.getElementById('fpe_err').style.display = 'none';
  renderRoomChips();
  resetAllSlots();
  renderScopeCheckboxes([]);
  openM('mfpe');
}
function openEditFpForProp(propId, fpId) {
  var fps = loadFpForProp(propId);
  var fp = null;
  for(var i=0;i<fps.length;i++){ if(fps[i].id===fpId){fp=fps[i];break;} }
  if (!fp) return;
  _fpeRooms = (fp.rooms||[]).slice();
  _fpeImages = {
    floorPlan: (fp.images&&fp.images.floorPlan) ? Object.assign({},fp.images.floorPlan) : null,
    seam:      (fp.images&&fp.images.seam)      ? Object.assign({},fp.images.seam)      : null,
    cutSheet:  (fp.images&&fp.images.cutSheet)  ? Object.assign({},fp.images.cutSheet)  : null
  };
  document.getElementById('fpetitle').textContent = 'Edit Floor Plan';
  document.getElementById('fpe_prop_id').value = propId;
  document.getElementById('fpe_fp_id').value = fpId;
  document.getElementById('fpe_name').value = fp.name||'';
  document.getElementById('fpe_sqft').value = fp.sqft||'';
  document.getElementById('fpe_units').value = fp.unitCount||'';
  document.getElementById('fpe_beds').value = String(fp.beds||0);
  document.getElementById('fpe_baths').value = String(fp.baths||1);
  document.getElementById('fpe_renov').value = fp.renovated ? 'true' : 'false';
  document.getElementById('fpe_delbtn').style.display = 'inline-flex';
  document.getElementById('fpe_err').style.display = 'none';
  renderRoomChips();
  resetAllSlots();
  ['floorPlan','seam','cutSheet'].forEach(function(slot) {
    if (_fpeImages[slot] && _fpeImages[slot].src) showSlotPreview(slot, _fpeImages[slot].src, _fpeImages[slot].name);
  });
  var fpScopes = (fp.scopes||[]).concat((fp.customScopes||[]).map(function(cs){return 'custom:'+cs.name;}));
  renderScopeCheckboxes(fpScopes, fp.customScopes||[]);
  openM('mfpe');
}

function renderRoomChips() {
  var wrap = document.getElementById('fpe_room_chips');
  if (!wrap) return;
  wrap.innerHTML = '';
  _fpeRooms.forEach(function(room, idx) {
    var chip = document.createElement('div');
    chip.className = 'room-chip';
    chip.innerHTML = '<span>'+room+'</span><button type="button" onclick="removeRoomChip('+idx+')">&#215;</button>';
    wrap.appendChild(chip);
  });
}
function addRoomChip() {
  var inp = document.getElementById('fpe_room_input');
  var val = (inp.value||'').trim();
  if (!val) return;
  if (_fpeRooms.indexOf(val) < 0) _fpeRooms.push(val);
  inp.value = '';
  renderRoomChips();
}
function addRoomChipVal(val) {
  if (_fpeRooms.indexOf(val) < 0) _fpeRooms.push(val);
  renderRoomChips();
}
function removeRoomChip(idx) {
  _fpeRooms.splice(idx,1);
  renderRoomChips();
}

// ── IMAGE SLOTS ──
function triggerSlotUpload(slot) { document.getElementById('file_'+slot).click(); }
function handleSlotUpload(slot, input) {
  var file = input.files[0]; if (!file) return;
  var rd = new FileReader();
  rd.onload = function(e) {
    _fpeImages[slot] = {src: e.target.result, name: file.name};
    showSlotPreview(slot, e.target.result, file.name);
  };
  rd.readAsDataURL(file);
}
function showSlotPreview(slot, src, fname) {
  document.getElementById('drop_'+slot).style.display = 'none';
  document.getElementById('prev_'+slot).style.display = 'block';
  var img = document.getElementById('img_'+slot);
  if (img) img.src = src;
  var fn = document.getElementById('fname_'+slot);
  if (fn) fn.textContent = fname||'';
  var hd = document.getElementById('slot_'+slot).querySelector('.img-slot-print');
  if (hd) hd.style.display = 'inline-flex';
  var clr = document.getElementById('slot_'+slot).querySelector('.img-slot-clear');
  if (clr) clr.style.display = 'inline-flex';
}
function clearSlot(slot) {
  _fpeImages[slot] = null;
  document.getElementById('drop_'+slot).style.display = '';
  document.getElementById('prev_'+slot).style.display = 'none';
  var img = document.getElementById('img_'+slot);
  if (img) img.src = '';
  document.getElementById('file_'+slot).value = '';
  var hd = document.getElementById('slot_'+slot).querySelector('.img-slot-print');
  if (hd) hd.style.display = 'none';
  var clr = document.getElementById('slot_'+slot).querySelector('.img-slot-clear');
  if (clr) clr.style.display = 'none';
}
function resetAllSlots() {
  ['floorPlan','seam','cutSheet'].forEach(function(slot){ clearSlot(slot); });
}

// ── PRINT SLOT ──
function printSlot(slot) {
  var propId  = document.getElementById('fpe_prop_id').value;
  var fpName  = document.getElementById('fpe_name').value || 'Floor Plan';
  var propName = '';
  getActiveProps().forEach(function(pr){ if(pr.id===propId) propName=pr.name; });
  var imgData = _fpeImages[slot];
  if (!imgData || !imgData.src) { toast('No image uploaded for this slot.'); return; }
  var labels = {floorPlan:'Floor Plan', seam:'Seam Diagram', cutSheet:'Cut Sheet'};
  openPrintPage(imgData.src, labels[slot], fpName, propName);
}
function openFpDoc(propId, fpId, slot) {
  var fps = loadFpForProp(propId);
  var fp = null;
  for(var i=0;i<fps.length;i++){ if(fps[i].id===fpId){fp=fps[i];break;} }
  if (!fp) return;
  var img = fp.images && fp.images[slot];
  if (!img || !img.src) { toast('No image uploaded for this slot yet.'); return; }
  var propName = '';
  getActiveProps().forEach(function(pr){ if(pr.id===propId) propName=pr.name; });
  var labels = {floorPlan:'Floor Plan', seam:'Seam Diagram', cutSheet:'Cut Sheet'};
  openPrintPage(img.src, labels[slot], fp.name, propName);
}
function openPrintPage(src, docLabel, planName, propName) {
  var pg = document.getElementById('print-page');
  if (!pg) {
    pg = document.createElement('div');
    pg.id = 'print-page';
    pg.className = 'print-page';
    document.body.appendChild(pg);
  }
  pg.innerHTML =
    '<div class="print-page-hd">'
      +'<div><div class="print-page-title">'+docLabel+': '+planName+'</div>'
      +'<div class="print-page-sub">'+propName+' &nbsp;·&nbsp; Protective Flooring &nbsp;·&nbsp; '+new Date().toLocaleDateString()+'</div></div>'
    +'</div>'
    +'<img src="'+src+'" alt="'+docLabel+'">'
    +'<div class="print-page-actions">'
      +'<button class="bl ol" onclick="closePrintPage()">&#8592; Close</button>'
      +'<button class="bl gd" onclick="window.print()">&#128438; Print</button>'
    +'</div>';
  pg.style.display = 'block';
}
function closePrintPage() {
  var pg = document.getElementById('print-page');
  if (pg) pg.style.display = 'none';
}

// ── SCOPES ──
function getScopesForFp(fp) {
  var global = loadScopes();
  var sel = fp.scopes || [];
  var customs = fp.customScopes || [];
  var result = [];
  global.forEach(function(sc){ if(sel.indexOf(sc.id)>=0) result.push(sc); });
  customs.forEach(function(cs){ result.push({id:'custom:'+cs.name, name:cs.name, svc:cs.svc||''}); });
  return result;
}
function renderScopeCheckboxes(selectedIds, customScopes) {
  var list = document.getElementById('fpe_scopes_list');
  if (!list) return;
  list.innerHTML = '';
  var global = loadScopes();
  global.forEach(function(sc) {
    var checked = selectedIds.indexOf(sc.id) >= 0;
    var row = document.createElement('div');
    row.className = 'scope-row';
    row.innerHTML = '<label><input type="checkbox" value="'+sc.id+'" '+(checked?'checked':'')+'> '+sc.name+' <span class="svc-tag">'+sc.svc+'</span></label>';
    list.appendChild(row);
  });
  (customScopes||[]).forEach(function(cs) {
    var row = document.createElement('div');
    row.className = 'scope-row';
    row.innerHTML = '<label><input type="checkbox" value="custom:'+cs.name+'" checked> '+cs.name+' <span class="svc-tag">'+(cs.svc||'custom')+'</span></label>'
      +'<span class="del-scope" onclick="this.parentElement.remove()">&#10005;</span>';
    list.appendChild(row);
  });
}
function addCustomScope() {
  var inp = document.getElementById('fpe_custom_scope');
  var val = (inp.value||'').trim();
  if (!val) return;
  var list = document.getElementById('fpe_scopes_list');
  var row = document.createElement('div');
  row.className = 'scope-row';
  row.innerHTML = '<label><input type="checkbox" value="custom:'+val+'" checked> '+val+' <span class="svc-tag">custom</span></label>'
    +'<span class="del-scope" onclick="this.parentElement.remove()">&#10005;</span>';
  list.appendChild(row);
  inp.value = '';
}

function saveFpFromModal() {
  var propId = document.getElementById('fpe_prop_id').value;
  var fpId   = document.getElementById('fpe_fp_id').value;
  var name   = (document.getElementById('fpe_name').value||'').trim();
  if (!name) { var e=document.getElementById('fpe_err'); e.textContent='Plan name is required.'; e.style.display='block'; return; }
  // Collect selected scopes
  var globalScopes = [], customScopes = [];
  document.querySelectorAll('#fpe_scopes_list input[type=checkbox]:checked').forEach(function(cb) {
    var v = cb.value;
    if (v.startsWith('custom:')) {
      customScopes.push({name: v.slice(7), svc:''});
    } else {
      globalScopes.push(v);
    }
  });
  var fps = loadFpForProp(propId);
  var isNew = !fpId;
  if (isNew) fpId = propId.replace('prop-','') + '-' + Date.now().toString(36).toUpperCase();
  var obj = {
    id: fpId,
    name: name,
    sqft: (document.getElementById('fpe_sqft').value||'').trim(),
    beds: parseInt(document.getElementById('fpe_beds').value)||0,
    baths: parseFloat(document.getElementById('fpe_baths').value)||1,
    unitCount: parseInt(document.getElementById('fpe_units').value)||0,
    renovated: document.getElementById('fpe_renov').value === 'true',
    rooms: _fpeRooms.slice(),
    images: {
      floorPlan: _fpeImages.floorPlan ? {src:_fpeImages.floorPlan.src, name:_fpeImages.floorPlan.name} : null,
      seam:      _fpeImages.seam      ? {src:_fpeImages.seam.src,      name:_fpeImages.seam.name}      : null,
      cutSheet:  _fpeImages.cutSheet  ? {src:_fpeImages.cutSheet.src,  name:_fpeImages.cutSheet.name}  : null
    },
    scopes: globalScopes,
    customScopes: customScopes,
    status: 'active'
  };
  if (isNew) {
    fps.push(obj);
  } else {
    fps = fps.map(function(fp){ return fp.id===fpId ? obj : fp; });
  }
  saveFpForProp(propId, fps);
  rebuildLegacy();
  closeM('mfpe');
  renderPropList();
  toast(isNew ? 'Floor plan added.' : 'Floor plan updated.');
  // If we came from the property edit modal, re-open it
  if (window._fpModalReturnPropId) {
    var retId = window._fpModalReturnPropId;
    window._fpModalReturnPropId = null;
    setTimeout(function(){ openEditProp(retId); }, 200);
  }
}
function deleteFpFromModal() {
  var propId = document.getElementById('fpe_prop_id').value;
  var fpId   = document.getElementById('fpe_fp_id').value;
  if (!fpId) return;
  if (!confirm('Delete this floor plan? This cannot be undone.')) return;
  var fps = loadFpForProp(propId).filter(function(fp){ return fp.id!==fpId; });
  saveFpForProp(propId, fps);
  rebuildLegacy();
  closeM('mfpe');
  renderPropList();
  toast('Floor plan deleted.');
}

// ── GLOBAL SCOPE MANAGER (Settings panel) ──
// ── SERVICE TYPES MANAGER ──
function renderServiceTypes() {
  var list = document.getElementById('svc_type_list');
  if (!list) return;
  var services = loadServices();
  list.innerHTML = '';

  if (!services.length) {
    list.innerHTML = '<div style="padding:12px;color:var(--gray);font-size:13px;font-style:italic;">No service types defined.</div>';
    return;
  }

  services.forEach(function(svc, idx) {
    var row = document.createElement('div');
    row.className = 'scope-row';
    row.dataset.svid = svc.id;

    row.innerHTML =
      '<span class="drag-handle" title="Drag to reorder">&#8597;</span>'
      + '<div class="svc-name-display" style="flex:1;font-size:13px;font-weight:600;color:var(--navy);">'
          + '<span class="svc-num" style="display:inline-block;width:22px;height:22px;border-radius:50%;background:var(--navy);color:#fff;font-size:10px;font-weight:700;text-align:center;line-height:22px;margin-right:8px;">' + (idx + 1) + '</span>'
          + svc.name
        + '</div>'
      + '<div class="svc-edit-fields" style="display:none;flex:1;gap:8px;align-items:center;">'
          + '<input type="text" class="svc-edit-name" value="' + svc.name + '" placeholder="Service type name" style="flex:1;min-width:180px;">'
          + '<button class="bs gd" style="font-size:11px;white-space:nowrap;" onclick="saveSvcEdit(this)">&#10003; Save</button>'
          + '<button class="bs ol" style="font-size:11px;" onclick="cancelSvcEdit(this)">Cancel</button>'
        + '</div>'
      + '<button class="bs nv" style="font-size:11px;flex-shrink:0;" onclick="openSvcEdit(this)">&#9998; Edit</button>'
      + '<button class="bs dn" style="font-size:11px;flex-shrink:0;" onclick="deleteSvcType(this)" data-svid="' + svc.id + '">&#10005; Remove</button>';

    // Drag to reorder
    row.draggable = true;
    row.addEventListener('dragstart', function(e) {
      e.dataTransfer.setData('text/plain', svc.id);
      setTimeout(function(){ row.classList.add('dragging'); }, 0);
    });
    row.addEventListener('dragend', function() {
      row.classList.remove('dragging');
      document.querySelectorAll('#svc_type_list .scope-row').forEach(function(r){ r.classList.remove('drag-over'); });
    });
    row.addEventListener('dragover', function(e) {
      e.preventDefault();
      document.querySelectorAll('#svc_type_list .scope-row').forEach(function(r){ r.classList.remove('drag-over'); });
      row.classList.add('drag-over');
    });
    row.addEventListener('drop', function(e) {
      e.preventDefault();
      var draggedId = e.dataTransfer.getData('text/plain');
      if (draggedId === svc.id) return;
      var fresh = loadServices();
      var from = fresh.findIndex(function(s){ return s.id === draggedId; });
      var to   = fresh.findIndex(function(s){ return s.id === svc.id; });
      if (from < 0 || to < 0) return;
      var moved = fresh.splice(from, 1)[0];
      fresh.splice(to, 0, moved);
      saveServices(fresh);
      renderServiceTypes();
      toast('Service type order saved.');
    });

    list.appendChild(row);
  });
}

function openSvcEdit(btn) {
  var row = btn.closest('.scope-row');
  row.querySelector('.svc-name-display').style.display = 'none';
  row.querySelector('.svc-edit-fields').style.display = 'flex';
  btn.style.display = 'none';
  row.querySelector('.bs.dn').style.display = 'none';
  row.querySelector('.svc-edit-name').focus();
  row.querySelector('.svc-edit-name').select();
}

function cancelSvcEdit(btn) {
  var row = btn.closest('.scope-row');
  row.querySelector('.svc-name-display').style.display = '';
  row.querySelector('.svc-edit-fields').style.display = 'none';
  row.querySelectorAll('.bs').forEach(function(b){ b.style.display = ''; });
}

function saveSvcEdit(btn) {
  var row  = btn.closest('.scope-row');
  var svid = row.dataset.svid;
  var name = row.querySelector('.svc-edit-name').value.trim();
  if (!name) { toast('Service type name cannot be empty.'); return; }
  var services = loadServices();
  var old = '';
  services = services.map(function(s) {
    if (s.id === svid) { old = s.name; return {id: s.id, name: name}; }
    return s;
  });
  saveServices(services);
  // Also update any scopes that reference the old name
  if (old && old !== name) {
    var scopes = loadScopes().map(function(sc) {
      return sc.svc === old ? Object.assign({}, sc, {svc: name}) : sc;
    });
    saveScopes(scopes);
  }
  renderServiceTypes();
  renderScopeAdmin();
  toast('Service type updated.');
}

function deleteSvcType(btn) {
  var svid = btn.getAttribute('data-svid');
  var services = loadServices();
  var svc = services.find(function(s){ return s.id === svid; });
  if (!svc) return;
  // Check if any scopes use this service type
  var using = loadScopes().filter(function(sc){ return sc.svc === svc.name; });
  var msg = 'Remove "' + svc.name + '" from service types?';
  if (using.length) {
    msg += '\n\n' + using.length + ' scope(s) reference this service type and will be set to "No specific service".';
  }
  if (!confirm(msg)) return;
  // Clear references in scopes
  if (using.length) {
    var updated = loadScopes().map(function(sc) {
      return sc.svc === svc.name ? Object.assign({}, sc, {svc: ''}) : sc;
    });
    saveScopes(updated);
  }
  saveServices(services.filter(function(s){ return s.id !== svid; }));
  renderServiceTypes();
  renderScopeAdmin();
  toast('"' + svc.name + '" removed.');
}

function addServiceType() {
  var inp = document.getElementById('svc_new_name');
  var name = (inp ? inp.value : '').trim();
  if (!name) { toast('Please enter a service type name.'); return; }
  var services = loadServices();
  if (services.find(function(s){ return s.name.toLowerCase() === name.toLowerCase(); })) {
    toast('A service type with that name already exists.'); return;
  }
  services.push({id: 'svc_' + Date.now().toString(36), name: name});
  saveServices(services);
  if (inp) inp.value = '';
  renderServiceTypes();
  renderScopeAdmin();
  toast('"' + name + '" added to service types.');
}

function renderMarketSettings() {
  var list = document.getElementById('market_list');
  if (!list) return;
  var markets = loadMarkets();
  list.innerHTML = '';
  if (!markets.length) {
    list.innerHTML = '<div style="padding:12px;color:var(--gray);font-size:13px;">No markets defined.</div>';
    return;
  }
  markets.forEach(function(m) {
    var row = document.createElement('div');
    row.className = 'scope-row';
    row.dataset.mid = m.id;
    row.innerHTML =
      '<div class="svc-name-display" style="flex:1;">'
        + '<strong style="font-size:13px;color:var(--navy);">'+m.label+'</strong>'
        + '<span style="font-size:11px;color:var(--gray);margin-left:10px;font-family:monospace;">'+m.key+'</span>'
        + (m.address ? '<div style="font-size:11px;color:var(--gray);margin-top:2px;">'+m.address+(m.phone?' &bull; '+m.phone:'')+'</div>' : '')
      + '</div>'
      + '<div class="svc-edit-fields" style="display:none;flex:1;flex-direction:column;gap:6px;">'
        + '<div style="display:flex;gap:8px;">'
          + '<input class="mkt-edit-name" type="text" value="'+m.label+'" placeholder="Market name" style="flex:1;">'
          + '<input class="mkt-edit-key" type="text" value="'+m.key+'" placeholder="key" style="width:100px;text-transform:lowercase;">'
        + '</div>'
        + '<div style="display:flex;gap:8px;">'
          + '<input class="mkt-edit-addr" type="text" value="'+(m.address||'')+'" placeholder="Address" style="flex:1;">'
          + '<input class="mkt-edit-phone" type="text" value="'+(m.phone||'')+'" placeholder="Phone" style="width:140px;">'
        + '</div>'
        + '<div style="display:flex;gap:6px;">'
          + '<button class="bs gd" style="font-size:11px;" onclick="saveMarketEdit(this)">&#10003; Save</button>'
          + '<button class="bs ol" style="font-size:11px;" onclick="cancelMarketEdit(this)">Cancel</button>'
        + '</div>'
      + '</div>'
      + '<button class="bs nv" style="font-size:11px;flex-shrink:0;" onclick="openMarketEdit(this)">&#9998; Edit</button>'
      + (markets.length > 1 ? '<button class="bs dn" style="font-size:11px;flex-shrink:0;" onclick="deleteMarket(this.dataset.mid)" data-mid="'+m.id+'">&#10005;</button>' : '');
    list.appendChild(row);
  });
}

function openMarketEdit(btn) {
  var row = btn.closest('.scope-row');
  row.querySelector('.svc-name-display').style.display = 'none';
  row.querySelector('.svc-edit-fields').style.display = 'flex';
  btn.style.display = 'none';
  var delBtn = row.querySelector('.bs.dn');
  if (delBtn) delBtn.style.display = 'none';
  row.querySelector('.mkt-edit-name').focus();
}

function cancelMarketEdit(btn) {
  var row = btn.closest('.scope-row');
  row.querySelector('.svc-name-display').style.display = '';
  row.querySelector('.svc-edit-fields').style.display = 'none';
  row.querySelectorAll('.bs').forEach(function(b){ b.style.display = ''; });
}

function saveMarketEdit(btn) {
  var row   = btn.closest('.scope-row');
  var mid   = row.dataset.mid;
  var name  = row.querySelector('.mkt-edit-name').value.trim();
  var key   = row.querySelector('.mkt-edit-key').value.trim().toLowerCase().replace(/[^a-z0-9_]/g,'');
  var addr  = row.querySelector('.mkt-edit-addr').value.trim();
  var phone = row.querySelector('.mkt-edit-phone').value.trim();
  if (!name || !key) { toast('Market name and key are required.'); return; }
  var markets = loadMarkets();
  markets = markets.map(function(m) {
    return m.id === mid ? {id:m.id, key:key, label:name, address:addr, phone:phone} : m;
  });
  saveMarkets(markets);
  renderMarketSettings();
  populateAllHubDropdowns();
  toast('Market updated.');
}

function deleteMarket(mid) {
  var markets = loadMarkets();
  if (markets.length <= 1) { toast('Cannot remove the last market.'); return; }
  var m = markets.find(function(x){ return x.id===mid; });
  if (!m) return;
  if (!confirm('Remove "'+m.label+'" market? Properties assigned to this market will need to be reassigned.')) return;
  saveMarkets(markets.filter(function(x){ return x.id!==mid; }));
  renderMarketSettings();
  populateAllHubDropdowns();
  buildHubTabs();
  toast('"'+m.label+'" removed.');
}

function addMarket() {
  var name  = (document.getElementById('mkt_new_name')||{value:''}).value.trim();
  var key   = (document.getElementById('mkt_new_key')||{value:''}).value.trim().toLowerCase().replace(/[^a-z0-9_]/g,'');
  var addr  = (document.getElementById('mkt_new_addr')||{value:''}).value.trim();
  var phone = (document.getElementById('mkt_new_phone')||{value:''}).value.trim();
  if (!name) { toast('Please enter a market name.'); return; }
  if (!key)  { toast('Please enter a market key (e.g. jackson).'); return; }
  var markets = loadMarkets();
  if (markets.find(function(m){ return m.key===key; })) { toast('A market with that key already exists.'); return; }
  markets.push({id:'mkt_'+Date.now().toString(36), key:key, label:name, address:addr, phone:phone});
  saveMarkets(markets);
  ['mkt_new_name','mkt_new_key','mkt_new_addr','mkt_new_phone'].forEach(function(id){
    var el=document.getElementById(id); if(el) el.value='';
  });
  renderMarketSettings();
  populateAllHubDropdowns();
  buildHubTabs();
  toast('"'+name+'" added as a new market.');
}

function renderScopeAdmin() {
  var list = document.getElementById('scope_list_admin');
  if (!list) return;
  var scopes = loadScopes();

  // Keep scope_new_svc in sync with SVC_LIST
  var newSvcSel = document.getElementById('scope_new_svc');
  if (newSvcSel) {
    newSvcSel.innerHTML = svcOptions('');
  }
  list.innerHTML = '';

  if (!scopes.length) {
    list.innerHTML = '<div style="padding:16px;color:var(--gray);font-size:13px;">No scopes yet. Add one below.</div>';
  }

  scopes.forEach(function(sc) {
    var row = document.createElement('div');
    row.className = 'scope-row';
    row.draggable = true;
    row.dataset.sid = sc.id;

    var svcLabel = sc.svc
      ? '<span class="svc-tag">' + sc.svc + '</span>'
      : '<span style="font-size:11px;color:var(--gray);font-style:italic;">No service assigned</span>';

    row.innerHTML =
      '<span class="drag-handle" title="Drag to reorder">&#8597;</span>'
      + '<div class="scope-name-display" style="flex:1;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">'
          + '<strong style="font-size:13px;">' + sc.name + '</strong>'
          + svcLabel
        + '</div>'
      + '<div class="scope-edit-fields" style="flex:1;">'
          + '<input type="text" class="scope-edit-name" value="' + sc.name + '" placeholder="Scope name" style="width:160px;">'
          + '<select class="scope-edit-svc" style="min-width:180px;">' + svcOptions(sc.svc) + '</select>'
          + '<button class="bs gd" style="font-size:11px;white-space:nowrap;" onclick="saveScopeEdit(this)">&#10003; Save</button>'
          + '<button class="bs ol" style="font-size:11px;" onclick="cancelScopeEdit(this)">Cancel</button>'
        + '</div>'
      + '<button class="bs nv" style="font-size:11px;flex-shrink:0;" data-sid="' + sc.id + '" onclick="openScopeEdit(this)">&#9998; Edit</button>'
      + '<button class="bs dn" style="font-size:11px;flex-shrink:0;" data-sid="' + sc.id + '" onclick="delScopeClick(this)">&#10005; Remove</button>';

    // ── Drag events ──
    row.addEventListener('dragstart', function(e) {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', sc.id);
      setTimeout(function(){ row.classList.add('dragging'); }, 0);
    });
    row.addEventListener('dragend', function() {
      row.classList.remove('dragging');
      document.querySelectorAll('#scope_list_admin .scope-row').forEach(function(r){
        r.classList.remove('drag-over');
      });
    });
    row.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      document.querySelectorAll('#scope_list_admin .scope-row').forEach(function(r){
        r.classList.remove('drag-over');
      });
      row.classList.add('drag-over');
    });
    row.addEventListener('drop', function(e) {
      e.preventDefault();
      var draggedId = e.dataTransfer.getData('text/plain');
      if (draggedId === sc.id) return;
      var fresh = loadScopes();
      var fromIdx = fresh.findIndex(function(s){ return s.id===draggedId; });
      var toIdx   = fresh.findIndex(function(s){ return s.id===sc.id; });
      if (fromIdx < 0 || toIdx < 0) return;
      var moved = fresh.splice(fromIdx, 1)[0];
      fresh.splice(toIdx, 0, moved);
      saveScopes(fresh);
      renderScopeAdmin();
      toast('Scope order saved.');
    });

    list.appendChild(row);
  });
}

function openScopeEdit(btn) {
  var row = btn.closest('.scope-row');
  row.querySelector('.scope-name-display').classList.add('hidden');
  row.querySelector('.scope-edit-fields').classList.add('open');
  btn.style.display = 'none';
  row.querySelector('.bs.dn').style.display = 'none';
  row.querySelector('.scope-edit-name').focus();
}

function cancelScopeEdit(btn) {
  var row = btn.closest('.scope-row');
  row.querySelector('.scope-name-display').classList.remove('hidden');
  row.querySelector('.scope-edit-fields').classList.remove('open');
  row.querySelectorAll('.bs').forEach(function(b){ b.style.display=''; });
}

function saveScopeEdit(btn) {
  var row    = btn.closest('.scope-row');
  var sid    = row.dataset.sid;
  var name   = row.querySelector('.scope-edit-name').value.trim();
  var svc    = row.querySelector('.scope-edit-svc').value;
  if (!name) { toast('Scope name cannot be empty.'); return; }
  var scopes = loadScopes();
  scopes = scopes.map(function(sc){
    return sc.id===sid ? Object.assign({},sc,{name:name,svc:svc}) : sc;
  });
  saveScopes(scopes);
  renderScopeAdmin();
  toast('Scope updated.');
}
function addGlobalScope() {
  var name = (document.getElementById('scope_new_name').value||'').trim();
  var svc  = document.getElementById('scope_new_svc').value||'';
  if (!name) { toast('Please enter a scope name.'); return; }
  var scopes = loadScopes();
  scopes.push({id:'sc_'+Date.now().toString(36), name:name, svc:svc});
  saveScopes(scopes);
  document.getElementById('scope_new_name').value = '';
  renderScopeAdmin();
  toast('Scope added to global library.');
}

function loadNotifSettings() {
  try {
    var s = localStorage.getItem('pf_notif');
    return s ? JSON.parse(s) : {
      req_client:true, req_company:true,
      conf_client:true, conf_company:false,
      comp_client:false, comp_company:false,
      void_client:true, void_company:false
    };
  } catch(e) {
    return {req_client:true,req_company:true,conf_client:true,conf_company:false,comp_client:false,comp_company:false,void_client:true,void_company:false};
  }
}
function applyNotifSettings() {
  var ns = loadNotifSettings();
  Object.keys(ns).forEach(function(k){
    var el = document.getElementById('notif_'+k);
    if (el) el.checked = ns[k];
  });
}
function getNotifSettings() {
  var keys = ['req_client','req_company','conf_client','conf_company','comp_client','comp_company','void_client','void_company'];
  var out = {};
  keys.forEach(function(k){
    var el = document.getElementById('notif_'+k);
    out[k] = el ? el.checked : false;
  });
  return out;
}
function savePortalSettings() {
  var notifEmail = (document.getElementById('set_notif_email')||{value:''}).value.trim();
  if (notifEmail) try { localStorage.setItem('pf_notif_email', notifEmail); } catch(e){}
  try { localStorage.setItem('pf_notif', JSON.stringify(getNotifSettings())); } catch(e){}
  toast('Settings saved.');
}

function deleteGlobalScope(id) {
  if (!confirm('Remove this scope from the global library?')) return;
  var scopes = loadScopes().filter(function(sc){ return sc.id!==id; });
  saveScopes(scopes);
  renderScopeAdmin();
  toast('Scope removed.');
}

// Wire openM for madd to use new function
function openAddPropertyBtn() { openAddPropModal(); }

// Patch legacy openAddFp / openEditFp calls embedded in old HTML
function openAddFp() {
  toast('Use the "+ Add Floor Plan" button inside a property card.');
}
function openEditFp(id) {
  toast('Use the "Edit" button inside a property card.');
}




// Called from "+ Add Floor Plan" button inside the Edit Property modal
function openAddFpInline() {
  var propId = document.getElementById('madd_fp_addbtn').dataset.prop ||
               document.getElementById('madd_id').value;
  closeM('madd');  // close property modal first, then open FP modal
  // brief timeout so modals don't stack weirdly
  setTimeout(function() {
    openAddFpForProp(propId);
    // When FP modal saves, re-open property modal
    window._fpModalReturnPropId = propId;
  }, 100);
}


// ── INLINE FLOOR PLAN LIST (inside Edit Property modal) ──
var COMMON_ROOMS = [
  'Living Room','Bedroom','Bed 1','Bed 2','Bed 3','Bed 4',
  'Kitchen','Bathroom','Bath 1','Bath 2',
  'Dining Area','Hallway','Walk-in Closet','Laundry Room',
  'Patio/Balcony','Entry','Main Area','W/D Hookup'
];

function renderInlineFpList(propId) {
  var list = document.getElementById('madd_fp_list');
  if (!list) return;
  var fps = loadFpForProp(propId);
  var globalScopes = loadScopes();
  list.innerHTML = '';

  if (fps.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--gray);font-size:13px;">No floor plans yet. Click "+ Add Floor Plan" above to create the first one.</div>';
    return;
  }

  fps.forEach(function(fp, fi) {
    var bedsLabel = fp.beds === 0 ? 'Studio' :
      fp.beds + 'BR / ' + fp.baths + 'BA';
    var renovBadge = fp.renovated
      ? '<span style="background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;margin-left:6px;">RENOV</span>'
      : '';
    var metaStr = [bedsLabel, fp.sqft ? fp.sqft+' sqft' : '', fp.unitCount ? fp.unitCount+' units' : ''].filter(Boolean).join(' · ');

    // ── Rooms section: toggleable chips from COMMON_ROOMS + any custom already on plan ──
    var planRooms = fp.rooms || [];
    var allRoomOptions = COMMON_ROOMS.slice();
    planRooms.forEach(function(r){ if(allRoomOptions.indexOf(r)<0) allRoomOptions.push(r); });
    var roomsHtml = allRoomOptions.map(function(room) {
      var sel = planRooms.indexOf(room) >= 0;
      return '<span class="room-toggle'+(sel?' selected':'')+'" data-room="'+room+'" data-fp="'+fp.id+'" data-prop="'+propId+'" onclick="toggleRoomInline(this)">'+room+'</span>';
    }).join('');

    // ── Scopes section: global checkboxes + custom scopes for this plan ──
    var selectedGlobal = fp.scopes || [];
    var customScopes   = fp.customScopes || [];
    var scopesHtml = '<div class="scope-grid">'
      + globalScopes.map(function(sc) {
          var checked = selectedGlobal.indexOf(sc.id) >= 0;
          return '<label class="scope-toggle'+(checked?' selected':'')+'">'
            + '<input type="checkbox" '+(checked?'checked':'')+' value="'+sc.id+'" data-fp="'+fp.id+'" data-prop="'+propId+'" onchange="syncScopeToggle(this)">'
            + '<span style="flex:1;">'+sc.name+'</span>'
            + (sc.svc ? '<span class="svc-tag">'+sc.svc+'</span>' : '')
            + '</label>';
        }).join('')
      + '</div>';

    // Custom scopes for this plan
    var customScopesHtml = '<div id="cscopes_'+fp.id+'" style="margin-top:8px;">'
      + customScopes.map(function(cs, ci) {
          return '<div class="scope-row" style="margin-bottom:4px;">'
            + '<span style="flex:1;font-size:12px;">'+cs.name+(cs.svc?'<span class="svc-tag">'+cs.svc+'</span>':'')+'</span>'
            + '<button class="bs dn" style="font-size:10px;padding:2px 6px;" data-fp="'+fp.id+'" data-prop="'+propId+'" data-ci="'+ci+'" onclick="deleteCustomScopeInline(this)">&#10005;</button>'
            + '</div>';
        }).join('')
      + '</div>'
      + '<div class="scope-custom-row" style="margin-top:8px;">'
      +   '<input type="text" id="csc_inp_'+fp.id+'" placeholder="Add scope specific to this plan..." style="flex:1;font-size:12px;">'
      +   '<button class="bs nv" style="font-size:11px;" data-fp="'+fp.id+'" data-prop="'+propId+'" onclick="addCustomScopeInline(this)">+ Add</button>'
      + '</div>';

    var card = document.createElement('div');
    card.className = 'fp-inline-card';
    card.id = 'fpic_' + fp.id;
    card.innerHTML =
      '<div class="fp-inline-hd" onclick="toggleInlineFpCard(this.parentElement)">'
        + '<span class="fp-inline-name">'+fp.name+renovBadge+'</span>'
        + '<span class="fp-inline-meta">'+metaStr+'</span>'
        + '<div style="display:flex;gap:6px;margin-left:12px;" onclick="event.stopPropagation();">'
          + '<button class="bs ol" data-prop="'+propId+'" data-fp="'+fp.id+'" onclick="editFpFromInline(this)">&#9998; Edit Plan Details</button>'
          + '<button class="bs dn" data-prop="'+propId+'" data-fp="'+fp.id+'" onclick="deleteFpInline(this)">&#128465;</button>'
        + '</div>'
        + '<span class="fp-inline-chevron">&#9660;</span>'
      + '</div>'
      + '<div class="fp-inline-body">'
        + '<div class="fp-inline-section">'
          + '<div class="fp-inline-section-title">Rooms Included in This Floor Plan</div>'
          + '<div class="room-grid">'+roomsHtml+'</div>'
          + '<div style="display:flex;gap:8px;margin-top:10px;">'
            + '<input type="text" id="room_inp_'+fp.id+'" placeholder="Add custom room..." style="flex:1;font-size:12px;">'
            + '<button class="bs nv" style="font-size:11px;" data-fp="'+fp.id+'" data-prop="'+propId+'" onclick="addCustomRoomInline(this)">+ Add</button>'
          + '</div>'
        + '</div>'
        + '<div class="fp-inline-section">'
          + '<div class="fp-inline-section-title">Preset Installation Scopes — Check All That Apply</div>'
          + scopesHtml
          + customScopesHtml
        + '</div>'
      + '</div>';

    list.appendChild(card);
  });
}

function toggleInlineFpCard(card) {
  card.classList.toggle('open');
}

// Toggle a room on/off for a floor plan inline
function toggleRoomInline(el) {
  var room   = el.dataset.room;
  var propId = el.dataset.prop;
  var fpId   = el.dataset.fp;
  el.classList.toggle('selected');
  // Save immediately
  var fps = loadFpForProp(propId);
  fps = fps.map(function(fp) {
    if (fp.id !== fpId) return fp;
    var rooms = (fp.rooms || []).slice();
    var idx = rooms.indexOf(room);
    if (el.classList.contains('selected')) {
      if (idx < 0) rooms.push(room);
    } else {
      if (idx >= 0) rooms.splice(idx, 1);
    }
    fp.rooms = rooms;
    return fp;
  });
  saveFpForProp(propId, fps);
  rebuildLegacy();
}

// Add a custom room not in the preset list
function addCustomRoomInline(btn) {
  var propId = btn.dataset.prop;
  var fpId   = btn.dataset.fp;
  var inp    = document.getElementById('room_inp_' + fpId);
  var val    = (inp ? inp.value : '').trim();
  if (!val) return;
  var fps = loadFpForProp(propId);
  fps = fps.map(function(fp) {
    if (fp.id !== fpId) return fp;
    var rooms = (fp.rooms || []).slice();
    if (rooms.indexOf(val) < 0) rooms.push(val);
    fp.rooms = rooms;
    return fp;
  });
  saveFpForProp(propId, fps);
  rebuildLegacy();
  inp.value = '';
  renderInlineFpList(propId);
  toast('Room added.');
}

// Sync scope checkbox to data store
function syncScopeToggle(cb) {
  var propId  = cb.dataset.prop;
  var fpId    = cb.dataset.fp;
  var scId    = cb.value;
  // Update the label style
  var lbl = cb.closest('label');
  if (lbl) lbl.classList.toggle('selected', cb.checked);
  // Save
  var fps = loadFpForProp(propId);
  fps = fps.map(function(fp) {
    if (fp.id !== fpId) return fp;
    var scopes = (fp.scopes || []).slice();
    var i = scopes.indexOf(scId);
    if (cb.checked) { if (i < 0) scopes.push(scId); }
    else            { if (i >= 0) scopes.splice(i, 1); }
    fp.scopes = scopes;
    return fp;
  });
  saveFpForProp(propId, fps);
  rebuildLegacy();
}

// Add a floor-plan-specific custom scope
function addCustomScopeInline(btn) {
  var propId = btn.dataset.prop;
  var fpId   = btn.dataset.fp;
  var inp    = document.getElementById('csc_inp_' + fpId);
  var val    = (inp ? inp.value : '').trim();
  if (!val) return;
  var fps = loadFpForProp(propId);
  fps = fps.map(function(fp) {
    if (fp.id !== fpId) return fp;
    var customs = (fp.customScopes || []).slice();
    customs.push({name: val, svc: ''});
    fp.customScopes = customs;
    return fp;
  });
  saveFpForProp(propId, fps);
  rebuildLegacy();
  inp.value = '';
  renderInlineFpList(propId);
  toast('Scope added.');
}

// Delete a custom scope from a floor plan
function deleteCustomScopeInline(btn) {
  var propId = btn.dataset.prop;
  var fpId   = btn.dataset.fp;
  var ci     = parseInt(btn.dataset.ci);
  var fps = loadFpForProp(propId);
  fps = fps.map(function(fp) {
    if (fp.id !== fpId) return fp;
    var customs = (fp.customScopes || []).slice();
    customs.splice(ci, 1);
    fp.customScopes = customs;
    return fp;
  });
  saveFpForProp(propId, fps);
  rebuildLegacy();
  renderInlineFpList(propId);
}

// Edit plan details from inline card (opens mfpe modal, returns to property edit)
function editFpFromInline(btn) {
  var propId = btn.dataset.prop;
  var fpId   = btn.dataset.fp;
  window._fpModalReturnPropId = propId;
  closeM('madd');
  setTimeout(function() { openEditFpForProp(propId, fpId); }, 100);
}

// Delete floor plan directly from inline card
function deleteFpInline(btn) {
  var propId = btn.dataset.prop;
  var fpId   = btn.dataset.fp;
  if (!confirm('Delete this floor plan? This cannot be undone.')) return;
  var fps = loadFpForProp(propId).filter(function(fp){ return fp.id !== fpId; });
  saveFpForProp(propId, fps);
  rebuildLegacy();
  renderInlineFpList(propId);
  renderPropList();
  toast('Floor plan deleted.');
}


function openFpImgSrc(fpId, propId) {
  var fps = loadFpForProp(propId);
  var fp = fps.find(function(f){ return f.id===fpId; });
  if (!fp || !fp.images || !fp.images.floorPlan) { toast('No floor plan image uploaded yet.'); return; }
  var propName = '';
  getActiveProps().forEach(function(pr){ if(pr.id===propId) propName=pr.name; });
  openPrintPage(fp.images.floorPlan.src, 'Floor Plan', fp.name, propName);
}


function svcDisplay(o) {
  // If service is blank or placeholder, show scope list
  var svc = o.service || '';
  if (!svc || svc === '(See scopes)' || svc === 'See Work Order') {
    return (o.scope && o.scope.length) ? o.scope.join(', ') : '—';
  }
  // If scopes exist and differ from service, append them
  if (o.scope && o.scope.length && !(o.scope.length === 1 && o.scope[0] === svc)) {
    return svc + '<br><span style="font-size:11px;color:var(--gray);">' + o.scope.join(', ') + '</span>';
  }
  return svc;
}

// ── WORK ORDER EDIT ──

function cstNow() {
  // Returns CST timestamp string
  var now = new Date();
  return now.toLocaleString('en-US', {
    timeZone: 'America/Chicago',
    month: 'short', day: 'numeric', year: 'numeric',
    hour: 'numeric', minute: '2-digit', second: '2-digit',
    hour12: true
  }) + ' CST';
}

function dateToDisplay(isoDate) {
  // "2025-02-20" -> "February 20, 2025"
  if (!isoDate) return 'Pending';
  var d = new Date(isoDate + 'T12:00:00');
  return d.toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'});
}

function displayToIso(displayDate) {
  // "February 20, 2025" -> "2025-02-20" (manual parse — avoids browser Date quirks)
  if (!displayDate || displayDate === 'Pending') return '';
  var MONTHS = {January:'01',February:'02',March:'03',April:'04',May:'05',June:'06',
    July:'07',August:'08',September:'09',October:'10',November:'11',December:'12'};
  var m = displayDate.match(/^(\w+)\s+(\d{1,2}),?\s+(\d{4})$/);
  if (!m) return '';
  var mon = MONTHS[m[1]];
  if (!mon) return '';
  return m[3] + '-' + mon + '-' + String(m[2]).padStart(2,'0');
}

function openWoEdit(id) {
  var o = orders[id]; if (!o) return;

  // Populate property dropdown
  var propSel = document.getElementById('woedit_prop');
  propSel.innerHTML = '';
  getActiveProps().forEach(function(pr) {
    var opt = document.createElement('option');
    opt.value = pr.name; opt.textContent = pr.name;
    propSel.appendChild(opt);
  });
  propSel.value = o.property;

  // Populate floor plans for this property
  woeditPopulatePlans(o.property, o.plan);

  document.getElementById('woedit_title').textContent = 'Edit Work Order';
  document.getElementById('woedit_num').textContent   = '#' + o.num + ' — Submitted ' + o.submittedDate;
  document.getElementById('woedit_unit').value        = o.unit || '';
  document.getElementById('woedit_occ').value         = o.occ  || 'Vacant';
  document.getElementById('woedit_hub').value         = o.hub  || 'Memphis';
  document.getElementById('woedit_status').value      = o.status || 'requested';
  document.getElementById('woedit_service').value     = o.service || '';
  document.getElementById('woedit_scope').value       = (o.scope||[]).join('\n');
  document.getElementById('woedit_reqdate').value     = displayToIso(o.reqDate);
  document.getElementById('woedit_confdate').value    = displayToIso(o.confDate);
  document.getElementById('woedit_timewindow').value  = o.timeWindow || 'To be confirmed';
  document.getElementById('woedit_notes').value       = o.notes !== 'No additional notes.' ? (o.notes||'') : '';
  document.getElementById('woedit_reason_sel').value  = '';
  document.getElementById('woedit_reason_other').style.display = 'none';
  document.getElementById('woedit_reason_other').value = '';
  document.getElementById('woedit_err').style.display = 'none';

  // Store the id being edited
  document.getElementById('mwoedit').dataset.editId = id;
  openM('mwoedit');
}

function woeditPropChange() {
  var propName = document.getElementById('woedit_prop').value;
  woeditPopulatePlans(propName, '');
}

function woeditPopulatePlans(propName, currentPlan) {
  var planSel = document.getElementById('woedit_plan');
  planSel.innerHTML = '<option value="">-- Select Floor Plan --</option>';
  var prop = null;
  getActiveProps().forEach(function(pr) { if (pr.name === propName) prop = pr; });
  if (!prop) return;
  var fps = loadFpForProp(prop.id);
  fps.forEach(function(fp) {
    var opt = document.createElement('option');
    var label = fp.name;
    if (fp.beds === 0) label += ' (Studio)';
    else if (fp.beds) label += ' (' + fp.beds + 'bd/' + fp.baths + 'ba)';
    if (fp.sqft) label += ' — ' + fp.sqft + ' sqft';
    if (fp.renovated) label += ' ★';
    opt.value = fp.name; opt.textContent = label;
    planSel.appendChild(opt);
  });
  // Match by name
  for (var i = 0; i < planSel.options.length; i++) {
    if (planSel.options[i].value === currentPlan ||
        planSel.options[i].textContent.indexOf(currentPlan) === 0) {
      planSel.selectedIndex = i; break;
    }
  }
}

function toggleWoEditOther(val) {
  document.getElementById('woedit_reason_other').style.display =
    val === 'Other' ? 'block' : 'none';
}

function saveWoEdit() {
  var id = document.getElementById('mwoedit').dataset.editId;
  var o  = orders[id]; if (!o) return;

  var reason    = document.getElementById('woedit_reason_sel').value;
  var otherTxt  = document.getElementById('woedit_reason_other').value.trim();
  var errEl     = document.getElementById('woedit_err');

  if (!reason) {
    errEl.textContent = 'Please select a reason for this edit.';
    errEl.style.display='block';
    errEl.scrollIntoView({behavior:'smooth',block:'nearest'});
    return;
  }
  if (reason === 'Other' && !otherTxt) {
    errEl.textContent = 'Please describe the reason for this edit.';
    errEl.style.display='block';
    errEl.scrollIntoView({behavior:'smooth',block:'nearest'});
    return;
  }
  errEl.style.display = 'none';

  var finalReason = reason === 'Other' ? otherTxt : reason;
  var editor      = (window.currentTeamUser && window.currentTeamUser.name) || 'Admin';
  var ts          = cstNow();
  var scopeRaw    = document.getElementById('woedit_scope').value;
  var newScope    = scopeRaw.split('\n').map(function(s){ return s.trim(); }).filter(Boolean);
  var newReqDate  = dateToDisplay(document.getElementById('woedit_reqdate').value);
  var newConfRaw  = document.getElementById('woedit_confdate').value;
  var newConf     = newConfRaw ? dateToDisplay(newConfRaw) : 'Pending';

  // Build diff log
  var FIELD_LABELS = {
    property:'Property', unit:'Unit', plan:'Floor Plan', occ:'Occupancy',
    hub:'Hub', status:'Status', service:'Service', scope:'Scope',
    reqDate:'Requested Date', confDate:'Confirmed Date',
    timeWindow:'Time Window', notes:'Notes'
  };
  var changes = [];
  var newVals = {
    property:   document.getElementById('woedit_prop').value,
    unit:       document.getElementById('woedit_unit').value.trim(),
    plan:       document.getElementById('woedit_plan').value,
    occ:        document.getElementById('woedit_occ').value,
    hub:        document.getElementById('woedit_hub').value,
    status:     document.getElementById('woedit_status').value,
    service:    document.getElementById('woedit_service').value,
    scope:      newScope,
    reqDate:    newReqDate,
    confDate:   newConf,
    timeWindow: document.getElementById('woedit_timewindow').value,
    notes:      document.getElementById('woedit_notes').value.trim() || 'No additional notes.'
  };

  Object.keys(FIELD_LABELS).forEach(function(key) {
    var oldVal = key === 'scope' ? (o[key]||[]).join(', ') : (o[key]||'');
    var newVal = key === 'scope' ? newScope.join(', ') : newVals[key];
    if (String(oldVal) !== String(newVal)) {
      changes.push({ field: FIELD_LABELS[key], from: String(oldVal), to: String(newVal) });
    }
  });

  // Apply changes
  Object.keys(newVals).forEach(function(k){ o[k] = newVals[k]; });

  // Write audit log entry
  if (!o.log) o.log = [];
  o.log.push({
    ts:      ts,
    by:      editor,
    reason:  finalReason,
    changes: changes.length ? changes : [{field:'No field changes', from:'—', to:'(saved with no detected differences)'}]
  });

  saveOrders();
  closeM('mwoedit');
  refreshAllOrderViews();
  // If work order preview is still open, refresh it in place
  var mwoEl = document.getElementById('mwo');
  if (mwoEl && mwoEl.classList.contains('op')) {
    oworder(id);
  }
  toast('\u2713 Work order #' + o.num + ' saved successfully.');
}

function exportWoLog(id) {
  var o = orders[id]; if (!o || !o.log || !o.log.length) { toast('No change log for this order.'); return; }
  var lines = ['WORK ORDER CHANGE LOG'];
  lines.push('Work Order: #' + o.num);
  lines.push('Property: ' + o.property + ' — Unit ' + o.unit);
  lines.push('Generated: ' + cstNow());
  lines.push('');
  o.log.forEach(function(entry, idx) {
    lines.push('─────────────────────────────────────');
    lines.push('Edit #' + (idx+1) + ' — ' + entry.ts);
    lines.push('Edited by: ' + entry.by);
    lines.push('Reason: ' + entry.reason);
    if (entry.changes && entry.changes.length) {
      lines.push('Changes:');
      entry.changes.forEach(function(c) {
        lines.push('  • ' + c.field + ':');
        lines.push('      From: ' + c.from);
        lines.push('      To:   ' + c.to);
      });
    }
    lines.push('');
  });
  lines.push('─────────────────────────────────────');
  lines.push('END OF LOG — Protective Services Company, Inc. dba Protective Flooring');
  var blob = new Blob([lines.join('\n')], {type:'text/plain'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href     = url;
  a.download = 'WO-Log-' + o.num + '.txt';
  a.click();
  URL.revokeObjectURL(url);
}

function printWorkOrder() {
  var woHtml = document.getElementById('woprint');
  if (!woHtml || !woHtml.innerHTML.trim()) { toast('No work order loaded.'); return; }
  var win = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
  if (!win) { toast('Please allow popups to print.'); window.print(); return; }
  var cssVars = '';
  // Collect computed CSS variables
  var style = getComputedStyle(document.documentElement);
  var varNames = ['--navy','--gold','--white','--cream','--off','--gray','--border','--r','--lg','--green','--navy-lt','--gold-bg','--shl'];
  varNames.forEach(function(v){ cssVars += v + ':' + style.getPropertyValue(v) + ';'; });

  win.document.write(
    '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
    '<title>Work Order</title>' +
    '<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">' +
    '<style>' +
    ':root{' + cssVars + '}' +
    'body{font-family:Inter,sans-serif;font-size:14px;color:#1a1a2e;margin:0;padding:24px;-webkit-print-color-adjust:exact;print-color-adjust:exact;}' +
    document.querySelector('style').textContent +
    '.ppbar{display:none!important;}' +
    '.wod{padding:32px 40px;}' +
    '@page{margin:0.4in;}' +
    '</style></head><body>' +
    woHtml.outerHTML +
    '<script>window.onload=function(){window.print();}<\/script>' +
    '</body></html>'
  );
  win.document.close();
}

// ── VOID / CANCEL ORDER ──
var _voidTargetId = null;
var _currentWoId = null;

function openVoidOrder(id) {
  _voidTargetId = id;
  var o = orders[id];
  if (!o) return;
  document.getElementById('void_wo_info').innerHTML =
    '<strong>#' + o.num + '</strong> &mdash; ' + o.property + ', Unit ' + o.unit +
    ' &mdash; ' + o.service + ' &mdash; <span class="b rq">Requested ' + o.reqDate + '</span>';
  document.getElementById('void_reason_sel').value = '';
  document.getElementById('void_reason_other').style.display = 'none';
  document.getElementById('void_reason_other').value = '';
  document.getElementById('void_notes').value = '';
  openM('mvoid');
}

function toggleVoidCustom(val) {
  document.getElementById('void_reason_other').style.display = val === 'Other' ? 'block' : 'none';
}

function confirmVoidOrder() {
  if (!_voidTargetId) return;
  var reason = document.getElementById('void_reason_sel').value;
  var other  = document.getElementById('void_reason_other').value.trim();
  var notes  = document.getElementById('void_notes').value.trim();
  if (!reason) { toast('Please select a cancellation reason.'); return; }
  if (reason === 'Other' && !other) { toast('Please describe the reason.'); return; }
  var finalReason = reason === 'Other' ? other : reason;
  var o = orders[_voidTargetId];
  o.status        = 'vd';
  o.voidReason    = finalReason;
  o.voidNotes     = notes;
  o.voidDate      = new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  o.voidBy        = (window.currentTeamUser && window.currentTeamUser.name) || 'Admin';
  saveOrders();
  closeM('mvoid');
  closeM('mwo');
  toast('Work order #' + o.num + ' has been voided.');
  refreshAllOrderViews();
}

// ── Resolve the effective date for an order (ISO string or '')
// Priority: confDate (if ISO) → reqDate (if ISO) → parsed legacy
function resolveOrderDate(o) {
  // Normalise any date string to YYYY-MM-DD for reliable ISO comparison
  var toIso = function(d) {
    if (!d || d === 'Pending' || d === '__TODAY__') return '';
    // Already ISO
    if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    // Long-form: "February 20, 2025" or "Feb 20, 2025"
    var longMonth = {January:'01',February:'02',March:'03',April:'04',May:'05',June:'06',
      July:'07',August:'08',September:'09',October:'10',November:'11',December:'12',
      Jan:'01',Feb:'02',Mar:'03',Apr:'04',Jun:'06',Jul:'07',Aug:'08',Sep:'09',Oct:'10',Nov:'11',Dec:'12'};
    var lm = d.match(/^([A-Za-z]+)\s+(\d{1,2}),?\s+(\d{4})$/);
    if (lm) {
      var mo = longMonth[lm[1]];
      if (mo) return lm[3]+'-'+mo+'-'+String(lm[2]).padStart(2,'0');
    }
    // MM/DD/YYYY
    var slash = d.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (slash) return slash[3]+'-'+String(slash[1]).padStart(2,'0')+'-'+String(slash[2]).padStart(2,'0');
    // Fallback: let JS parse it but use noon UTC to avoid timezone shift
    var parsed = new Date(d + (d.indexOf(':') === -1 ? 'T12:00:00' : ''));
    if (!isNaN(parsed)) {
      return parsed.getFullYear()+'-'+String(parsed.getMonth()+1).padStart(2,'0')+'-'+String(parsed.getDate()).padStart(2,'0');
    }
    return '';
  };
  // Priority: confirmed ISO date → requested date (any format)
  return toIso(o.confDate) || toIso(o.reqDate) || '';
}

// ── Compute [startISO, endISO] for a date range key
function dateRangeBounds(range) {
  var now = new Date();
  var y = now.getFullYear(), m = now.getMonth(), d = now.getDate();
  var iso = function(dt) {
    return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');
  };
  var today = new Date(y, m, d);
  if (range === 'today')     return [iso(today), iso(today)];
  if (range === 'yesterday') { var y1=new Date(y,m,d-1); return [iso(y1),iso(y1)]; }
  if (range === 'tomorrow')  { var t1=new Date(y,m,d+1); return [iso(t1),iso(t1)]; }
  if (range === 'last_week') {
    var dow=now.getDay();
    return [iso(new Date(y,m,d-dow-7)), iso(new Date(y,m,d-dow-1))];
  }
  if (range === 'last_month') {
    return [iso(new Date(y,m-1,1)), iso(new Date(y,m,0))];
  }
  if (range === 'last_quarter') {
    var q=Math.floor(m/3);
    if (q===0) return [iso(new Date(y-1,9,1)), iso(new Date(y-1,12,0))];
    return [iso(new Date(y,(q-1)*3,1)), iso(new Date(y,q*3,0))];
  }
  if (range === 'qtd') {
    // Quarter to date: start of current quarter through today
    var cq = Math.floor(m/3);
    return [iso(new Date(y, cq*3, 1)), iso(today)];
  }
  if (range === 'last_year') return [iso(new Date(y-1,0,1)), iso(new Date(y-1,11,31))];
  if (range === 'ytd')       return [iso(new Date(y,0,1)), iso(today)];
  if (range === 'custom') {
    var from = (document.getElementById('aord_date_from')||{value:''}).value;
    var to   = (document.getElementById('aord_date_to')||{value:''}).value;
    if (!from && !to) return null;
    return [from || '0000-01-01', to || '9999-12-31'];
  }
  return null;
}

// Show/hide custom date inputs when "Custom" is selected
function onDateRangeChange() {
  var val = (document.getElementById('aord_date_range')||{value:''}).value;
  var customDiv = document.getElementById('aord_custom_dates');
  if (customDiv) customDiv.style.display = (val === 'custom') ? 'flex' : 'none';
  renderAdminOrders();
}

function renderAdminOrders() {
  var tbody = document.getElementById('aord_tbody');
  if (!tbody) return;
  populateHubSelect('aord_hub', (document.getElementById('aord_hub')||{value:''}).value, 'All Hubs');

  var propSel = document.getElementById('aord_prop');
  if (propSel) {
    var curPropVal = propSel.value;
    propSel.innerHTML = '<option value="">All Properties</option>';
    var seen = {};
    Object.keys(orders).forEach(function(id){ seen[orders[id].property] = 1; });
    Object.keys(seen).sort().forEach(function(pn){
      var o2 = document.createElement('option'); o2.value = pn; o2.textContent = pn;
      propSel.appendChild(o2);
    });
    propSel.value = curPropVal;
  }

  var q         = (document.getElementById('aord_search')     ||{value:''}).value.trim().toLowerCase();
  var prop      = (document.getElementById('aord_prop')       ||{value:''}).value;
  var st        = (document.getElementById('aord_status')     ||{value:''}).value;
  var hub       = (document.getElementById('aord_hub')        ||{value:''}).value;
  var srt       = (document.getElementById('aord_sort')       ||{value:'newest'}).value;
  var dateRange = (document.getElementById('aord_date_range') ||{value:''}).value;
  var drBounds  = dateRange ? dateRangeBounds(dateRange) : null;

  var ids = Object.keys(orders).filter(function(id){
    var o = orders[id];
    if (prop && o.property !== prop) return false;
    if (st) { if (o.status !== st) return false; }
    else { if (o.status === 'vd') return false; }
    if (hub && (o.hub||'') !== hub) return false;
    if (q) {
      var hay = (o.num+' '+o.property+' '+o.unit+' '+svcDisplay(o)+' '+(o.plan||'')).toLowerCase();
      if (hay.indexOf(q) === -1) return false;
    }
    if (drBounds) {
      var effDate = resolveOrderDate(o);
      if (!effDate || effDate < drBounds[0] || effDate > drBounds[1]) return false;
    }
    return true;
  });

  ids.sort(function(a,b){
    var oa=orders[a], ob=orders[b];
    if (srt==='property') return (oa.property||'').localeCompare(ob.property||'');
    if (srt==='status')   return (oa.status||'').localeCompare(ob.status||'');
    if (srt==='service')  return (oa.service||'').localeCompare(ob.service||'');
    if (srt==='date')     return resolveOrderDate(oa).localeCompare(resolveOrderDate(ob));
    return b.localeCompare(a);
  });

  var countEl = document.getElementById('aord_count');
  if (countEl) countEl.textContent = ids.length + ' order' + (ids.length===1?'':'s');

  var _dateTh = document.getElementById('aord_date_th');
  if (_dateTh) _dateTh.textContent = 'Date';

  var rows = '';
  ids.forEach(function(id){
    var o = orders[id];
    var hubBadge = hubBadgeHtml(o.hub);
    var sb = '<span class="b '+o.status+'">'+(slab[o.status]||o.status)+'</span>';
    var voidNote = o.status==='vd'
      ? '<div style="font-size:11px;color:#7f1d1d;margin-top:2px;">'+(o.voidReason||'')+'</div>' : '';
    var effDate = resolveOrderDate(o);
    var view     = '<button class="bs ol" onclick="event.stopPropagation();oworder(\''+id+'\')">View</button>';
    var conf     = o.status==='requested'
      ? ' <button class="bs gd" onclick="event.stopPropagation();openConfirm(\''+id+'\')">&#10003; Confirm</button>' : '';
    var complete = o.status==='scheduled'
      ? ' <button class="bs gn" onclick="event.stopPropagation();markOrderComplete(\''+id+'\')">&#10003; Complete</button>' : '';
    var vd = (o.status==='completed'||o.status==='requested'||o.status==='scheduled')
      ? ' <button class="bs dn" onclick="event.stopPropagation();openVoidOrder(\''+id+'\')">Void</button>' : '';
    rows += '<tr onclick="oworder(\''+id+'\')">'+
      '<td><strong>#'+o.num+'</strong>'+voidNote+'</td>'+
      '<td>'+o.property+'</td>'+
      '<td>'+hubBadge+'</td>'+
      '<td>'+o.unit+'</td>'+
      '<td>'+svcDisplay(o)+'</td>'+
      '<td>'+fmtDate(effDate)+'</td>'+
      '<td>'+sb+'</td>'+
      '<td><div style="display:flex;gap:4px;">'+view+conf+complete+vd+'</div></td>'+
      '</tr>';
  });
  tbody.innerHTML = rows || '<tr><td colspan="8" style="text-align:center;color:var(--gray);padding:32px;">No orders found.</td></tr>';

  // Re-apply column sort if active
  var cs = _sortState['aord_tbl'];
  if (cs && cs.col >= 0) {
    var tbl = document.getElementById('aord_tbl');
    if (tbl) {
      var tb2 = tbl.querySelector('tbody');
      var rs2 = Array.prototype.slice.call(tb2.querySelectorAll('tr'));
      var mm = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
      rs2.sort(function(a,b){
        var ac=a.cells[cs.col],bc=b.cells[cs.col];
        if(!ac||!bc) return 0;
        var av=ac.textContent.trim().replace(/^#/,'');
        var bv=bc.textContent.trim().replace(/^#/,'');
        var cmp=0;
        if(cs.type==='date'){
          var pd=function(s){if(!s||s==='—'||s==='Pending')return 0;var mx=s.match(/^(\w{3})\s+(\d+)/);return mx?mm[mx[1]]*100+parseInt(mx[2]):0;};
          cmp=pd(av)-pd(bv);
        } else { cmp=av.toLowerCase().localeCompare(bv.toLowerCase()); }
        return cs.dir==='asc'?cmp:-cmp;
      });
      rs2.forEach(function(r){tb2.appendChild(r);});
      tbl.querySelectorAll('th.sortable').forEach(function(th,i){
        th.classList.remove('sort-asc','sort-desc');
        if(i===cs.col) th.classList.add(cs.dir==='asc'?'sort-asc':'sort-desc');
      });
    }
  }
}


// ── DASHBOARD & ORDER HISTORY RENDER FUNCTIONS ──

var _dashTab = 'recent'; // default tab

function switchDashTab(tab) {
  _dashTab = tab;
  document.getElementById('tab_recent').classList.toggle('on', tab === 'recent');
  document.getElementById('tab_today').classList.toggle('on',  tab === 'today');
  document.getElementById('adash_recent_wrap').style.display = tab === 'recent' ? '' : 'none';
  document.getElementById('adash_today_wrap').style.display  = tab === 'today'  ? '' : 'none';
  var title = tab === 'today' ? "Today's Installs" : 'New Orders — Action Required';
  document.getElementById('adash_table_title').textContent = title;
  if (tab === 'today') renderAdashToday();
  else                 renderAdashRecent();
}

function todayStr() {
  var d = new Date();
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}

function fmtDate(d) {
  if (!d || d === 'Pending') return '—';
  // ISO format: YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var parts = d.split('-');
    return months[parseInt(parts[1],10)-1] + ' ' + parseInt(parts[2],10);
  }
  // Legacy long form: "February 20, 2025"
  var parts = d.replace(',','').split(' ');
  if (parts.length >= 2) return parts[0].slice(0,3) + ' ' + parts[1];
  return d;
}

// Mark order complete

// ── SORTABLE TABLES ──
var _sortState = {}; // {tableId: {col, dir}}

function sortTable(tableId, colIdx, type) {
  var state = _sortState[tableId] || {col:-1, dir:'asc'};
  var dir = (state.col === colIdx && state.dir === 'asc') ? 'desc' : 'asc';
  _sortState[tableId] = {col: colIdx, dir: dir, type: type};

  var table = document.getElementById(tableId);
  if (!table) return;
  var tbody = table.querySelector('tbody');
  if (!tbody) return;

  // Update header classes
  table.querySelectorAll('th.sortable').forEach(function(th, i) {
    th.classList.remove('sort-asc','sort-desc');
    if (i === colIdx) th.classList.add(dir === 'asc' ? 'sort-asc' : 'sort-desc');
  });

  var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
  rows.sort(function(a, b) {
    var ac = a.cells[colIdx], bc = b.cells[colIdx];
    if (!ac || !bc) return 0;
    var av = ac.textContent.trim().replace(/^#/,'');
    var bv = bc.textContent.trim().replace(/^#/,'');
    var cmp = 0;
    if (type === 'num') {
      cmp = (parseFloat(av)||0) - (parseFloat(bv)||0);
    } else if (type === 'date') {
      // Handle "Pending", "—", month-day formats
      var monthMap = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
      var parseD = function(s) {
        if (!s || s==='—' || s==='Pending') return 0;
        var m = s.match(/^(\w{3})\s+(\d+)/);
        return m ? monthMap[m[1]]*100 + parseInt(m[2]) : 0;
      };
      cmp = parseD(av) - parseD(bv);
    } else {
      cmp = av.toLowerCase().localeCompare(bv.toLowerCase());
    }
    return dir === 'asc' ? cmp : -cmp;
  });
  rows.forEach(function(r){ tbody.appendChild(r); });
}

function markOrderComplete(id) {
  var o = orders[id]; if (!o) return;
  if (!confirm('Mark work order #'+o.num+' as Completed?')) return;
  o.status = 'completed';
  if (!o.log) o.log = [];
  o.log.push({
    ts: cstNow(),
    by: (window.currentTeamUser && window.currentTeamUser.name) || 'Admin',
    reason: 'Completed',
    changes: [{field:'Status', from:'Scheduled', to:'Completed'}]
  });
  saveOrders();
  refreshAllOrderViews();
  toast('Work order #'+o.num+' marked complete.');
  // Refresh WO detail if open
  var mwo = document.getElementById('mwo');
  if (mwo && mwo.classList.contains('open')) { oworder(id); }
}

function orderActionBtns(id, o) {
  var view     = '<button class="bs ol" onclick="event.stopPropagation();oworder(\''+id+'\')">View</button>';
  var conf     = o.status==='requested'
    ? ' <button class="bs gd" onclick="event.stopPropagation();openConfirm(\''+id+'\')">&#10003; Confirm</button>' : '';
  var complete = o.status==='scheduled'
    ? ' <button class="bs gn" onclick="event.stopPropagation();markOrderComplete(\''+id+'\')">&#10003; Complete</button>' : '';
  var vd       = (o.status==='completed')
    ? ' <button class="bs dn" onclick="event.stopPropagation();openVoidOrder(\''+id+'\')">Void</button>'
    : (o.status!=='vd' && o.status!=='requested' && o.status!=='scheduled' ? ''
      : (o.status!=='vd' ? ' <button class="bs dn" onclick="event.stopPropagation();openVoidOrder(\''+id+'\')">Void</button>' : ''));
  return '<div style="display:flex;gap:5px;">'+view+conf+complete+vd+'</div>';
}

function statusBadge(status) {
  return '<span class="b '+status+'">'+(slab[status]||status)+'</span>';
}

function renderAdashRecent() {
  var tbody = document.getElementById('adash_recent_tbody');
  if (!tbody) return;
  populateHubSelect('adash_hub', (document.getElementById('adash_hub')||{value:''}).value, 'All Hubs');
  var adashHub = (document.getElementById('adash_hub')||{value:''}).value;

  // Show: all 'requested' orders first, then recent 'scheduled', exclude completed/void
  var allIds = Object.keys(orders).filter(function(id){
    var o = orders[id];
    if (o.status === 'vd' || o.status === 'completed') return false;
    if (adashHub && (o.hub||'') !== adashHub) return false;
    return true;
  });

  // Sort: requested first, then scheduled; newest within each group
  allIds.sort(function(a, b) {
    var sa = orders[a].status, sb = orders[b].status;
    var rank = {requested:0,scheduled:1};
    var ra = rank[sa] !== undefined ? rank[sa] : 3;
    var rb = rank[sb] !== undefined ? rank[sb] : 3;
    if (ra !== rb) return ra - rb;
    // Within same status: newest first (timestamp keys first)
    var aTs = a.indexOf('WO-')===0, bTs = b.indexOf('WO-')===0;
    if (aTs && !bTs) return -1; if (!aTs && bTs) return 1;
    return b > a ? 1 : -1;
  });

  var ids = allIds.slice(0, 10);
  var html = '';
  ids.forEach(function(id) {
    var o = orders[id];
    var hub = hubBadgeHtml(o.hub);
    html += '<tr onclick="oworder(\''+id+'\')">'+
      '<td><strong>#'+o.num+'</strong></td>'+
      '<td>'+o.property+'</td>'+
      '<td>'+hub+'</td>'+
      '<td>'+o.unit+'</td>'+
      '<td>'+svcDisplay(o)+'</td>'+
      '<td>'+fmtDate(o.reqDate)+'</td>'+
      '<td>'+(o.confDate && o.confDate!=='Pending' ? fmtDate(o.confDate) : '<span style="color:var(--gray);font-size:11px;">Pending</span>')+'</td>'+
      '<td>'+statusBadge(o.status)+'</td>'+
      '<td>'+orderActionBtns(id,o)+'</td>'+
      '</tr>';
  });
  tbody.innerHTML = html || '<tr><td colspan="9" style="text-align:center;color:var(--gray);padding:24px;">No pending orders.</td></tr>';
}

function renderAdashToday() {
  populateHubSelect('adash_hub', (document.getElementById('adash_hub')||{value:''}).value, 'All Hubs');
  var tbody = document.getElementById('adash_today_tbody');
  if (!tbody) return;
  var adashHub = (document.getElementById('adash_hub')||{value:''}).value;
  var today = todayStr();
  var html = '';
  Object.keys(orders).forEach(function(id) {
    var o = orders[id];
    if (o.confDate !== today) return;
    if (o.status === 'vd' || o.status === 'completed') return;
    if (adashHub && (o.hub||'') !== adashHub) return;
    var hub = hubBadgeHtml(o.hub);
    html += '<tr onclick="oworder(\''+id+'\')">'+
      '<td><strong>#'+o.num+'</strong></td>'+
      '<td>'+o.property+'</td>'+
      '<td>'+hub+'</td>'+
      '<td>'+o.unit+'</td>'+
      '<td>'+svcDisplay(o)+'</td>'+
      '<td>'+fmtDate(o.reqDate)+'</td>'+
      '<td>'+fmtDate(o.confDate)+'</td>'+
      '<td>'+statusBadge(o.status)+'</td>'+
      '<td>'+orderActionBtns(id,o)+'</td>'+
      '</tr>';
  });
  tbody.innerHTML = html || '<tr><td colspan="9" style="text-align:center;color:var(--gray);padding:24px;">No installs scheduled for today.</td></tr>';
}

function renderClientDash() {
  var tbody = document.getElementById('cd_tbody');
  if (!tbody || !currentUser) return;
  var userProps = currentUser.props || [];
  var html = '';
  var shown = 0;
  // Sort: requested first, then by date
  var allPNames = getActiveProps().map(function(pr){ return pr.name; });
  var isAdminView = userProps.length >= allPNames.length - 1;
  var ids = Object.keys(orders).filter(function(id){
    var o = orders[id];
    return isAdminView || userProps.indexOf(o.property) !== -1;
  });
  ids.sort(function(a,b){
    var aTs = a.indexOf("WO-")===0, bTs = b.indexOf("WO-")===0;
    if (aTs && !bTs) return -1; if (!aTs && bTs) return 1;
    return b > a ? 1 : -1;
  });
  ids.slice(0,10).forEach(function(id) {
    var o = orders[id];
    shown++;
    html += '<tr onclick="oworder(\''+id+'\')">'
      +'<td><strong>#'+o.num+'</strong></td>'
      +'<td>Unit '+o.unit+'</td>'
      +'<td>'+svcDisplay(o)+'</td>'
      +'<td>'+fmtDate(o.reqDate)+'</td>'
      +'<td>'+statusBadge(o.status)+'</td>'
      +'<td><button class="bs ol" onclick="event.stopPropagation();oworder(\''+id+'\')">View / Print</button></td>'
      +'</tr>';
  });
  tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:24px;">No orders yet. <a href="#" onclick="cnav(\'co\',document.querySelector(\'#cl .ni[onclick*=&quot;co&quot;]\'))">Submit your first order.</a></td></tr>';
}

function renderClientHistory() {
  var tbody = document.getElementById('ch_tbody');
  if (!tbody || !currentUser) return;
  populateHubKeySelect('ch_hub_filter', (document.getElementById('ch_hub_filter')||{value:''}).value, 'All Hubs');
  var userProps = currentUser.props || [];
  var allPN = getActiveProps().map(function(pr){ return pr.name; });
  var isAdm = userProps.length === 0 || userProps.length >= allPN.length - 1;

  // Filters
  var chQ   = (document.getElementById('ch_search')||{value:''}).value.trim().toLowerCase();
  var chSt  = (document.getElementById('ch_status_filter')||{value:''}).value;
  var chPr  = (document.getElementById('ch_prop_filter')||{value:''}).value;
  var chHub = (document.getElementById('ch_hub_filter')||{value:''}).value;
  var chSrt = (document.getElementById('ch_sort')||{value:'newest'}).value;

  var ids = Object.keys(orders).filter(function(id){
    var o = orders[id];
    if (!isAdm && userProps.indexOf(o.property) === -1) return false;
    if (chSt  && o.status !== chSt) return false;
    if (chPr  && o.property !== chPr) return false;
    if (chHub && (o.hub||'').toLowerCase() !== chHub) return false;
    if (chQ) {
      var hay = (o.num+' '+o.property+' '+o.unit+' '+svcDisplay(o)+' '+(o.plan||'')).toLowerCase();
      if (hay.indexOf(chQ) === -1) return false;
    }
    return true;
  });

  ids.sort(function(a,b){
    var oa=orders[a], ob=orders[b];
    if (chSrt==='property') return (oa.property||'').localeCompare(ob.property||'');
    if (chSrt==='status')   return (oa.status||'').localeCompare(ob.status||'');
    if (chSrt==='service')  return (oa.service||'').localeCompare(ob.service||'');
    if (chSrt==='date')     return (oa.reqDate||'').localeCompare(ob.reqDate||'');
    // newest first (timestamp keys first)
    var aTs=a.indexOf('WO-')===0, bTs=b.indexOf('WO-')===0;
    if (aTs && !bTs) return -1; if (!aTs && bTs) return 1;
    return b > a ? 1 : -1;
  });

  // Populate property dropdown (always refresh)
  var propSel = document.getElementById('ch_prop_filter');
  if (propSel) {
    var curVal = propSel.value;
    propSel.innerHTML = '<option value="">All Properties</option>';
    var seen = {};
    Object.keys(orders).forEach(function(id){ seen[orders[id].property] = 1; });
    Object.keys(seen).sort().forEach(function(pn){
      var opt = document.createElement('option');
      opt.value = pn; opt.textContent = pn;
      propSel.appendChild(opt);
    });
    propSel.value = curVal;
  }

  var html = '';
  ids.forEach(function(id) {
    var o = orders[id];
    html += '<tr onclick="oworder(\''+id+'\')">'+
      '<td><strong>#'+o.num+'</strong></td>'+
      '<td>'+o.property+'</td>'+
      '<td>'+o.unit+'</td>'+
      '<td>'+svcDisplay(o)+'</td>'+
      '<td>'+fmtDate(o.reqDate)+'</td>'+
      '<td>'+(hubBadgeHtml(o.hub))+'</td>'+
      '<td>'+statusBadge(o.status)+'</td>'+
      '<td><button class="bs ol" onclick="event.stopPropagation();oworder(\''+id+'\')">View / Print</button></td>'+
      '</tr>';
  });
  var countEl = document.getElementById('ch_count');
  if (countEl) countEl.textContent = ids.length + ' order' + (ids.length===1?'':'s');
  tbody.innerHTML = html || '<tr><td colspan="8" style="text-align:center;color:var(--gray);padding:24px;">No orders found.</td></tr>';
}

function refreshAllOrderViews() {
  renderClientDash();
  renderClientHistory();
  renderAdashRecent();
  renderAdminOrders();
  if (_dashTab === 'today') renderAdashToday();
}

// ── AUTH ──
function doLogin() {
  var email = document.getElementById('lemail').value.trim().toLowerCase();
  var pw = document.getElementById('lpw').value;
  document.getElementById('lerr').style.display = 'none';

  // Check portal users (admin/staff accounts)
  var team = getTeam();
  for (var i = 0; i < team.length; i++) {
    var tu = team[i];
    if (tu.email.toLowerCase() === email && tu.password === pw) {
      if (tu.status === 'inactive') {
        document.getElementById('lerr').textContent = 'This account has been deactivated.';
        document.getElementById('lerr').style.display = 'block';
        return;
      }
      // Store logged-in team user info for permission checks
      window.currentTeamUser = tu;
      window._portalRole = tu.role || 'admin';
      // Update admin sidebar with real user info
      var avn = document.getElementById('aavatar'); if (avn) avn.textContent = tu.initials || (tu.name||'?')[0];
      var anm = document.getElementById('aname');   if (anm) anm.textContent = tu.name || tu.email;
      var arl = document.getElementById('arole');   if (arl) arl.textContent = {superadmin:'Super Admin',admin:'Admin',management:'Management',sales:'Sales',editor:'Editor'}[tu.role] || 'Portal User';
      go('ad');
      applyRoleRestrictions(tu.role || 'admin');

      // ── Apply default hub from user profile ──
      var defaultHub = tu.hub || '';
      // Dashboard hub
      var dashHubEl = document.getElementById('adash_hub');
      if (dashHubEl && defaultHub) {
        populateHubSelect('adash_hub', defaultHub, 'All Hubs');
      }
      // All Orders hub
      var aordHubEl = document.getElementById('aord_hub');
      if (aordHubEl && defaultHub) {
        populateHubSelect('aord_hub', defaultHub, 'All Hubs');
      }
      // Properties hub tab
      if (defaultHub) {
        var hubKey = defaultHub.toLowerCase();
        window._loginDefaultHub = hubKey;
      } else {
        window._loginDefaultHub = '';
      }

      // Activate dashboard tab and render it
      var dashNavEl = document.querySelector('#ad .ni[onclick*="adash"]');
      anav('adash', dashNavEl);
      return;
    }
  }

  // Check client accounts from store
  var clients = getUsers();
  var user = null;
  for (var i = 0; i < clients.length; i++) {
    if (clients[i].email.toLowerCase() === email && clients[i].password === pw) {
      if (clients[i].status === 'inactive') {
        document.getElementById('lerr').textContent = 'This account has been deactivated. Contact your administrator.';
        document.getElementById('lerr').style.display = 'block';
        return;
      }
      user = clients[i];
      // Stamp last login timestamp in CST
      var _now = new Date();
      var _cst = new Date(_now.toLocaleString('en-US', {timeZone:'America/Chicago'}));
      var _pad = function(n){return String(n).padStart(2,'0');};
      var _hr = _cst.getHours(), _ampm = _hr>=12?'PM':'AM';
      _hr = _hr%12||12;
      clients[i].lastLogin = (_cst.getMonth()+1)+'/'+_cst.getDate()+'/'+_cst.getFullYear()
        +' '+_hr+':'+_pad(_cst.getMinutes())+' '+_ampm+' CST';
      clients[i].lastLoginISO = _now.toISOString();
      saveUsers(clients);
      break;
    }
  }
  if (!user) {
    document.getElementById('lerr').textContent = 'Incorrect email or password. Please try again.';
    document.getElementById('lerr').style.display = 'block';
    return;
  }
  loadClientPortal(user);
  go('cl');
  var bs = document.getElementById('adminBackBtnSidebar'); if(bs) bs.style.display='none';
}
// demoLogin removed - login screen has no demo buttons

// Data-attribute click handlers (avoid escaping issues in dynamic HTML)
function delScopeClick(btn) {
  deleteGlobalScope(btn.getAttribute('data-sid'));
}
function fpDocClick(btn) {
  var propId = btn.getAttribute('data-prop');
  var fpId   = btn.getAttribute('data-fp');
  var slot   = btn.getAttribute('data-slot');
  openFpDoc(propId, fpId, slot);
}
function editFpClick(btn) {
  var propId = btn.getAttribute('data-prop');
  var fpId   = btn.getAttribute('data-fp');
  openEditFpForProp(propId, fpId);
}
function addFpClick(btn) {
  var propId = btn.getAttribute('data-prop');
  openAddFpForProp(propId);
}

function goClientPortalFromChooser() {
  // Build a synthetic admin user with ALL active properties
  var allProps = getActiveProps().map(function(pr){ return pr.name; });
  var tu = window.currentTeamUser || {};
  var synth = {
    name: tu.name || 'Admin View',
    initials: tu.initials || 'PF',
    email: tu.email || 'info@protectiveflooring.com',
    props: allProps.length ? allProps : ['Cherry Creek Apartments'],
    role: 'Property Manager'
  };
  loadClientPortal(synth);
  go('cl');
  // Show sidebar back button for team users
  var bs = document.getElementById('adminBackBtnSidebar'); if(bs) bs.style.display='';
}

// Go back to admin panel from client portal (for admin users)
function goBackToAdmin() {
  go('ad');
  // Re-apply role restrictions after returning
  applyRoleRestrictions(window._portalRole || 'admin');
  // Re-activate the dashboard tab
  var dashNavEl = document.querySelector('#ad .ni[onclick*="adash"]');
  anav('adash', dashNavEl);
}

// Go to chooser screen
function goToChooser() {
  go('sc');
}

// Place an order for a specific property — opens client portal order tab pre-selected
function adminPlaceOrder(propName) {
  goClientPortalFromChooser();
  setTimeout(function() {
    cnav('co', document.querySelectorAll('#cl .ni')[1]);
    if (propName) {
      var sel = document.getElementById('cpropsel');
      if (sel) {
        for (var i = 0; i < sel.options.length; i++) {
          if (sel.options[i].text === propName) {
            sel.selectedIndex = i;
            updatePropFloorPlans(sel.value);
            break;
          }
        }
      }
    }
  }, 200);
}

function doLogout() {
  currentUser = null;
  window.currentTeamUser = null;
  document.getElementById('lemail').value = 'manager@cherrycreek.com';
  document.getElementById('lpw').value = 'Cherry2025!';
  document.getElementById('lerr').style.display = 'none';
  go('sl');
}
function loadClientPortal(user) {
  currentUser = user;
  document.getElementById('cavatar').textContent = user.initials;
  document.getElementById('cname').textContent = user.name;
  var propLabel = user.props.length > 1 ? user.props.length + ' Properties' : user.props[0];
  document.getElementById('cprop').textContent = propLabel;
  document.getElementById('ctopprop').textContent = '📍 ' + propLabel;

  // Populate property dropdown in order form
  var sel = document.getElementById('cpropsel');
  sel.innerHTML = '<option value="">-- Select Property --</option>';
  user.props.forEach(function(pname) {
    var opt = document.createElement('option');
    opt.textContent = pname;
    // find real prop.id from store
    var pid = '';
    getActiveProps().forEach(function(pr){ if(pr.name===pname) pid=pr.id; });
    opt.value = pid;
    sel.appendChild(opt);
  });
  // If only one property, auto-select it
  if (user.props.length === 1) {
    sel.selectedIndex = 1;
    updatePropFloorPlans(sel.value);
  }

  // Populate floor plans page
  buildFloorPlansPage(user);
  cnav('cd', document.querySelectorAll('#cl .ni')[0]);
}

// ── FLOOR PLANS PAGE ──
function buildFloorPlansPage(user) {
  var grid = document.getElementById('cfgrid');
  var title = document.getElementById('cfproptitle');
  title.textContent = user.props.join(' / ');
  grid.innerHTML = '';
  user.props.forEach(function(pname) {
    var matchedProp = null;
    getActiveProps().forEach(function(pr){ if(pr.name===pname) matchedProp=pr; });
    var propId = matchedProp ? matchedProp.id : '';
    var fps = matchedProp ? loadFpForProp(propId) : [];
    fps.forEach(function(fp) {
      var det = fpDetails[fp.id] || {};
      var roomList = fp.rooms || det.rooms || [];
      var beds = fp.beds !== undefined ? fp.beds : det.beds;
      var baths = fp.baths !== undefined ? fp.baths : det.baths;
      var sqftDisplay = fp.sqft ? fp.sqft + ' sq ft' : (det.sqft || '');
      var typeLabel = '';
      if (beds === 0) typeLabel = 'Studio';
      else if (beds) typeLabel = beds + ' Bed / ' + baths + ' Bath';
      var renovBadge = (fp.renovated || det.renovated)
        ? '<span style="background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;padding:2px 7px;border-radius:3px;font-size:10px;font-weight:700;margin-left:8px;vertical-align:middle;">RENOVATED</span>' : '';
      var rooms = roomList.map(function(r){ return '<span class="chip">'+r+'</span>'; }).join('');
      var fpImg = fp.images && fp.images.floorPlan && fp.images.floorPlan.src;
      var scopes = fp.scopes || [];
      var allScopes = loadScopes();
      var scopeChips = scopes.length
        ? '<div style="margin-bottom:8px;">'
          + scopes.map(function(sid){
              var sc = allScopes.find(function(s){ return s.id===sid; });
              return sc ? '<span class="chip" style="background:rgba(2,10,91,.08);color:var(--navy);">'+sc.name+'</span>' : '';
            }).join('')
          + '</div>'
        : '';

      var card = document.createElement('div');
      card.className = 'fc';
      card.style.marginBottom = '0';

      var inner = '<h3 style="font-size:17px;">'+fp.name+renovBadge+'</h3>'
        + '<p style="font-size:12px;color:var(--gray);margin-bottom:6px;">'
          + (typeLabel ? typeLabel+' &bull; ' : '') + sqftDisplay + ' &bull; '+pname
        + '</p>'
        + '<div style="margin-bottom:10px;">'+rooms+'</div>'
        + scopeChips;
      card.innerHTML = inner;

      if (fpImg && propId) {
        var btn = document.createElement('button');
        btn.className = 'fit hi';
        btn.innerHTML = '&#128506; View Floor Plan';
        (function(fid, pid){ btn.onclick = function(){ openFpImgSrc(fid, pid); }; })(fp.id, propId);
        card.appendChild(btn);
      }

      grid.appendChild(card);
    });
  });
}

// ── ORDER FORM: PROPERTY SELECTS FLOOR PLANS ──
function updatePropFloorPlans(propId) {
  var planSel = document.getElementById('cplan');
  planSel.innerHTML = '<option value="">-- Select Floor Plan --</option>';
  document.getElementById('fppreview').style.display = 'none';
  if (!propId) return;
  var fps = loadFpForProp(propId);
  fps.forEach(function(fp) {
    var opt = document.createElement('option');
    opt.value = fp.id;
    var label = fp.name;
    if (fp.beds === 0) label += ' (Studio)';
    else if (fp.beds) label += ' (' + fp.beds + 'bd/' + fp.baths + 'ba)';
    if (fp.sqft) label += ' — ' + fp.sqft + ' sq ft';
    if (fp.renovated) label += ' ★';
    opt.textContent = label;
    planSel.appendChild(opt);
  });
}
function onPlanChange(fpId) {
  var prev = document.getElementById('fppreview');
  if (!fpId) { prev.style.display = 'none'; return; }

  // Load fp from live store
  var propSel = document.getElementById('cpropsel');
  var propId  = propSel ? propSel.value : '';
  var fps     = propId ? loadFpForProp(propId) : [];
  var fp      = fps.find(function(f){ return f.id===fpId; });

  // Fallback to fpDetails for legacy plans
  var det = fpDetails[fpId] || {};
  var name   = (fp && fp.name)  || det.name  || fpId;
  var beds   = fp ? fp.beds  : det.beds;
  var baths  = fp ? fp.baths : det.baths;
  var sqft   = fp ? fp.sqft  : det.sqft;
  var rooms  = (fp && fp.rooms && fp.rooms.length) ? fp.rooms : (det.rooms || []);
  var scopes = (fp && fp.scopes) ? fp.scopes : [];
  var custom = (fp && fp.customScopes) ? fp.customScopes : [];

  // Build label
  var label = '';
  if (beds === 0) label = 'Studio';
  else if (beds) label = beds + ' Bed / ' + baths + ' Bath';
  var sqftStr = sqft ? sqft + ' sq ft' : '';
  var meta = [label, sqftStr].filter(Boolean).join(' — ');

  document.getElementById('fpcardname').textContent = name + ((fp && fp.renovated) ? ' ★ Renovated' : '');
  document.getElementById('fpcardsqft').textContent = meta;


  // Floor plan image
  var imgEl    = document.getElementById('fpcardimg');
  var imgBtnEl = document.getElementById('fpcardimg-btn');
  var imgSrc   = fp && fp.images && fp.images.floorPlan && fp.images.floorPlan.src;
  if (imgSrc) {
    imgEl.innerHTML = '<img src="'+imgSrc+'" style="width:100%;height:100%;object-fit:cover;border-radius:3px;">';
        var imgBtn = document.createElement('button');
    imgBtn.className = 'fit hi'; imgBtn.style.fontSize = '11px';
    imgBtn.innerHTML = '&#128506; Full View';
    imgBtn.onclick = function(){ openFpImgById(fpId); };
    imgBtnEl.innerHTML = ''; imgBtnEl.appendChild(imgBtn);
  } else {
    imgEl.innerHTML = '&#127760;';
    imgBtnEl.innerHTML = '';
  }

  // Scopes — combine global presets assigned to this plan + custom scopes
  var scopesEl   = document.getElementById('fpscopes-chips');
  var scopesSec  = document.getElementById('fpscopes-section');
  var allGlobal  = loadScopes();
  var chips = [];

  scopes.forEach(function(sid) {
    var sc = allGlobal.find(function(s){ return s.id===sid; });
    if (sc) chips.push({name: sc.name, svc: sc.svc});
  });
  custom.forEach(function(c) {
    var nm = typeof c === 'string' ? c : c.name;
    if (nm) chips.push({name: nm, svc: ''});
  });

  if (chips.length) {
    scopesEl.innerHTML = '';
    chips.forEach(function(c, ci) {
      var span = document.createElement('span');
      span.className = 'scope-chip-sel';
      span.setAttribute('data-scope', c.name);
      span.title = c.svc || '';
      span.innerHTML = c.name + (c.svc ? ' <span style="opacity:.55;font-weight:400;font-size:10px;">(' + c.svc + ')</span>' : '');
      span.onclick = function(){ span.classList.toggle('chosen'); };
      scopesEl.appendChild(span);
    });
    scopesSec.style.display = 'block';
  } else {
    scopesEl.innerHTML = '';
    scopesSec.style.display = 'none';
  }

  prev.style.display = 'block';
}
function openFpImgById(fpId) {
  if (fpId) openFpImg(fpId);
}

// ── NAVIGATION ──
function go(id) {
  document.querySelectorAll('.scr').forEach(function(s){ s.classList.remove('on'); });
  var el = document.getElementById(id);
  if (el) el.classList.add('on');
}
function cnav(pid, el) {
  if (pid==='cd') renderClientDash();
  if (pid==='ch') renderClientHistory();
  document.querySelectorAll('#cl .ni').forEach(function(n){ n.classList.remove('on'); });
  if (el) el.classList.add('on');
  document.querySelectorAll('#cl .panel').forEach(function(p){ p.classList.remove('on'); });
  var t = document.getElementById(pid);
  if (t) t.classList.add('on');
  var titles = {cd:'Dashboard',co:'Place Order Request',ch:'Order History',cf:'Floor Plans',cx:'Documents'};
  document.getElementById('ctitle').textContent = titles[pid] || pid;
}
function anav(pid, el) {
  if (pid==='adash') renderAdashRecent();
  if (pid==='aord')  renderAdminOrders();
  if (pid==='aprops') { renderPropList(); setTimeout(filterProps, 50); }
  if (pid==='aset') { renderScopeAdmin(); renderServiceTypes(); renderMarketSettings(); }
  document.querySelectorAll('#ad .ni').forEach(function(n){ n.classList.remove('on'); });
  if (el) el.classList.add('on');
  document.querySelectorAll('#ad .panel').forEach(function(p){ p.classList.remove('on'); });
  var t = document.getElementById(pid);
  if (t) t.classList.add('on');
  var titles = {adash:'Admin Dashboard',aord:'All Orders',aprops:'Properties',ausers:'Client Logins',ateam:'Portal Users',aset:'Portal Settings'};
  if (pid === 'ausers') renderUserTable();
  if (pid === 'ateam') { renderTeamTable(); applyRoleRestrictions(window._portalRole||'admin'); }
  // floor plans now live inside property cards
  document.getElementById('atitle').textContent = titles[pid] || pid;
}

// ── ORDERS DATA ──
// ── ORDER STORE ──
var ORDER_SEED = {
  'CC-001':{num:'NA0001',property:'Cherry Creek Apartments',hub:'Nashville',unit:'214',plan:'2 Bed / 2 Bath',sqft:'1,080 sq ft',occ:'Vacant',service:'Carpet Installation',scope:['Living Room','Bed 1','Bed 2','Hallway'],reqDate:'2025-02-20',confDate:'__TODAY__',status:'scheduled',submittedBy:'Jessica Lane',submittedDate:'February 15, 2025',email:'manager@cherrycreek.com',notes:'Standard turnover carpet. Match neutral tone.',timeWindow:'Morning (7 AM - 12 PM)',photos:false},
  'CC-002':{num:'NA0002',property:'Cherry Creek Apartments',hub:'Nashville',unit:'108',plan:'1 Bed / 1 Bath',sqft:'720 sq ft',occ:'Vacant',service:'Sheet Vinyl',scope:['Kitchen','Bathroom 1'],reqDate:'2025-02-18',confDate:'Pending',status:'requested',submittedBy:'Jessica Lane',submittedDate:'February 14, 2025',email:'manager@cherrycreek.com',notes:'Kitchen vinyl is lifting near dishwasher. Bathroom showing wear.',timeWindow:'No Preference',photos:true},
  'CC-003':{num:'NA0003',property:'Cherry Creek Apartments',hub:'Nashville',unit:'301',plan:'3 Bed / 2 Bath',sqft:'1,350 sq ft',occ:'Vacant',service:'Luxury Vinyl Plank (LVP)',scope:['Living Room','Bed 1','Bed 2','Bed 3','Hallway'],reqDate:'2025-02-10',confDate:'February 10, 2025',status:'completed',submittedBy:'Jessica Lane',submittedDate:'February 5, 2025',email:'manager@cherrycreek.com',notes:'Full turnover LVP all carpeted areas.',timeWindow:'Morning (7 AM - 12 PM)',photos:false},
  '2411':{num:'ME0001',property:'Riverside Apartments',hub:'Memphis',unit:'204',plan:'2 Bed / 2 Bath',sqft:'1,050 sq ft',occ:'Vacant',service:'Luxury Vinyl Plank (LVP)',scope:['Living Room','Bedroom 1','Bedroom 2'],reqDate:'2025-02-28',confDate:'__TODAY__',status:'scheduled',submittedBy:'Rachel Moore',submittedDate:'February 22, 2025',email:'rmoore@riverside.com',notes:'Please use darker walnut tone LVP.',timeWindow:'Morning (7 AM - 12 PM)',photos:true},
  '2414':{num:'ME0002',property:'Parkview Commons',hub:'Memphis',unit:'08B',plan:'2 Bed / 2 Bath',sqft:'980 sq ft',occ:'Vacant',service:'Carpet + Pet Seal Treatment',scope:['Living Room','Bedroom 1','Bedroom 2','Hallway'],reqDate:'2025-03-03',confDate:'Pending',status:'requested',submittedBy:'Sandra Hill',submittedDate:'February 22, 2025',email:'shill@parkview.com',notes:'Heavy pet damage. Strong odor in both bedrooms.',timeWindow:'Morning (7 AM - 12 PM)',photos:true},
  '2413':{num:'ME0003',property:'Riverside Apartments',hub:'Memphis',unit:'118',plan:'1 Bed / 1 Bath',sqft:'650 sq ft',occ:'Vacant',service:'Carpet Installation',scope:['Living Room','Bedroom'],reqDate:'2025-02-26',confDate:'Pending',status:'requested',submittedBy:'Rachel Moore',submittedDate:'February 20, 2025',email:'rmoore@riverside.com',notes:'',timeWindow:'No Preference',photos:false},
  '2410':{num:'NA0004',property:'Arbor Ridge Nashville',hub:'Nashville',unit:'15C',plan:'1 Bed / 1 Bath',sqft:'700 sq ft',occ:'Vacant',service:'Sheet Vinyl',scope:['Kitchen','Bathroom 1'],reqDate:'2025-02-24',confDate:'Pending',status:'requested',submittedBy:'Keisha Davis',submittedDate:'February 18, 2025',email:'kdavis@arborridge.com',notes:'',timeWindow:'No Preference',photos:false}
};

function saveOrders() {
  try {
    // Only save non-seed orders (WO- prefix keys) plus mutations to seed orders
    localStorage.setItem('pf_orders', JSON.stringify(orders));
  } catch(e) { console.warn('saveOrders failed', e); }
}

function loadOrders() {
  // Resolve __TODAY__ sentinel in seeds to actual ISO date
  var todayIso = (function(){
    var d=new Date();
    return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  })();
  var freshSeed = JSON.parse(JSON.stringify(ORDER_SEED));
  Object.keys(freshSeed).forEach(function(k){
    if (freshSeed[k].confDate === '__TODAY__') freshSeed[k].confDate = todayIso;
  });
  try {
    var stored = localStorage.getItem('pf_orders');
    if (stored) {
      var parsed = JSON.parse(stored);
      // Merge: stored takes priority for user-created orders;
      // but always re-apply fresh seed confDate so dates never go stale
      var merged = JSON.parse(JSON.stringify(freshSeed));
      Object.keys(parsed).forEach(function(k) {
        merged[k] = parsed[k];
        // Re-stamp seed order confDates so Today's Installs always works
        if (freshSeed[k] && freshSeed[k].confDate) {
          merged[k].confDate = freshSeed[k].confDate;
          merged[k].status   = freshSeed[k].status;
        }
        // Migrate long-form reqDate to ISO for date filter compatibility
        if (merged[k].reqDate && !/^\d{4}-\d{2}-\d{2}$/.test(merged[k].reqDate)) {
          var _lm = {January:'01',February:'02',March:'03',April:'04',May:'05',June:'06',
            July:'07',August:'08',September:'09',October:'10',November:'11',December:'12'};
          var _m = (merged[k].reqDate+'').match(/^([A-Za-z]+)\s+(\d{1,2}),?\s+(\d{4})$/);
          if (_m && _lm[_m[1]]) merged[k].reqDate = _m[3]+'-'+_lm[_m[1]]+'-'+String(_m[2]).padStart(2,'0');
        }
      });
      return merged;
    }
  } catch(e) { console.warn('loadOrders failed', e); }
  return freshSeed;
}

var orders = loadOrders();
var slab = {'vd':'Void',requested:'Requested',scheduled:'Scheduled',completed:'Completed'};

// ── WORK ORDER PRINT ──
var photosOn = true;
function oworder(id) {
  var o = orders[id]; if (!o) return;
  document.getElementById('wotitle').textContent = 'Work Order #' + o.num;
  var sb = '<span class="b '+o.status+'">'+(slab[o.status]||o.status)+'</span>';
  var hb = '<span class="b '+(o.hub==='Memphis'?'mp':'nv')+'">'+o.hub+' Hub</span>';
  var sc = o.scope.map(function(s){ return '<span class="wost">'+s+'</span>'; }).join('');
  var logo = document.querySelector('#sl img') ? document.querySelector('#sl img').src : '';
  var tl = [
    {d:'dn',t:'Order Submitted',s:o.submittedDate+' -- Confirmation sent to '+o.email},
    o.confDate!=='Pending' ? {d:'dn',t:'Date Confirmed',s:'Scheduling confirmation sent'} : {d:'ac',t:'Awaiting Date Confirmation',s:'Pending -- action required'},
    {d:(o.status==='completed'?'dn':'pd'),t:'Installation Scheduled',s:o.confDate!=='Pending'?o.confDate:'Pending'},
    {d:o.status==='completed'?'dn':'pd',t:'Installation Complete',s:o.status==='completed'?'Completed':'Pending'}
  ];
  var tlh = tl.map(function(t){
    var sym = t.d==='dn'?'✓':t.d==='ac'?'●':'○';
    return '<div class="tli"><div class="tld '+t.d+'">'+sym+'</div><div class="tlc"><div class="tlt">'+t.t+'</div><div class="tls">'+t.s+'</div></div></div>';
  }).join('');
  var ph = o.photos ? '<div class="wopg"><div class="wopb">Photo 1</div><div class="wopb">Photo 2</div><div class="wopb">Photo 3</div></div>' : '<div class="wopn">No photos uploaded with this order.</div>';
  var nt = o.notes ? '<div class="wonb"><p>'+o.notes+'</p></div>' : '<div class="wonb"><p style="color:var(--gray);font-style:italic;">No additional notes.</p></div>';
  var today = new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  document.getElementById('woprint').innerHTML =
    '<div class="ppbar"><span>Work Order Preview -- #'+o.num+'</span></div>'+
    '<div class="wod">'+
      '<div class="woh">'+
      '<div><img src="'+logo+'" style="height:48px;width:auto;margin-bottom:12px;">'+
      (function(){ var _m=getMarket(o.hub); return '<p>Protective Services Company, Inc. dba Protective Flooring<br>'+(_m&&_m.address?_m.address:'3846 Delp Street, Memphis, TN 38118')+'<br>'+(_m&&_m.phone?_m.phone:'(901) 794-4101')+' &mdash; info@protectiveflooring.com</p>'; }())+'>'+o.confDate+'</div></div>'+
        '</div>'+
        '<div class="wof" style="margin-bottom:14px;"><div class="wofl">Scope of Work</div><div style="margin-top:8px;"><div class="woscl">'+sc+'</div></div></div>'+
        '<div class="wof"><div class="wofl">Time Window</div><div class="wofv">'+o.timeWindow+'</div></div>'+
      '</div>'+
      '<div class="wosec"><div class="wosect">Notes and Special Instructions</div>'+nt+'</div>'+
      (o.status==='vd' ? '<div class="wosec" style="background:#fef2f2;border:1px solid #fecaca;border-radius:4px;"><div class="wosect" style="color:#b91c1c;">&#128683; VOID — Cancellation Record</div>'+
        '<div class="wog">'+
          '<div class="wof"><div class="wofl">Status</div><div class="wofv" style="color:#b91c1c;font-weight:700;">VOID / CANCELLED</div></div>'+
          '<div class="wof"><div class="wofl">Reason</div><div class="wofv">'+(o.voidReason||'')+'</div></div>'+
          '<div class="wof"><div class="wofl">Voided By</div><div class="wofv">'+(o.voidBy||'')+'</div></div>'+
          '<div class="wof"><div class="wofl">Voided Date</div><div class="wofv">'+(o.voidDate||'')+'</div></div>'+
          (o.voidNotes ? '<div class="wof"><div class="wofl">Notes</div><div class="wofv">'+o.voidNotes+'</div></div>' : '')+
        '</div></div>' : '')+
      '<div class="wosec wophsec"><div class="wosect">Customer Photos</div>'+ph+'</div>'+
      '<div class="wosec"><div class="wosect">Order Timeline</div><div class="tl">'+tlh+'</div></div>'+
      '<div class="wosec"><div class="wosect">Submitted By</div><div class="wog">'+
        '<div class="wof"><div class="wofl">Contact Name</div><div class="wofv">'+o.submittedBy+'</div></div>'+
        '<div class="wof"><div class="wofl">Email</div><div class="wofv">'+o.email+'</div></div>'+
      '</div></div>'+
      '<div class="wosec"><div class="wosr"><div class="wosb">Protective Flooring Representative Signature and Date</div><div class="wosb">Customer / Property Manager Signature and Date</div></div></div>'+
      (o.log && o.log.length ? '<div class="wosec wo-log-sec"><div class="wosect">&#128221; Change Log</div>'+
        o.log.map(function(entry,i){
          var chHtml = entry.changes.map(function(c){
            return '<div class="wo-log-change"><span class="wo-log-field">'+c.field+'</span>'+
              '<span class="wo-log-arrow">'+c.from+' &#8594; '+c.to+'</span></div>';
          }).join('');
          return '<div class="wo-log-entry">'+
            '<div class="wo-log-hd"><strong>Edit #'+(i+1)+'</strong><span>'+entry.ts+'</span></div>'+
            '<div class="wo-log-meta">By '+entry.by+' &mdash; Reason: '+entry.reason+'</div>'+
            chHtml+'</div>';
        }).join('')+
      '</div>' : '')+
    '</div>'+
    '<div class="wofoot"><span>Protective Services Company, Inc. dba Protective Flooring</span><span>#'+o.num+' -- '+today+'</span><span>"We Stand on Our Word"</span></div>';
  _currentWoId = id;
  var isAdminView = !!(window.currentTeamUser);
  // Stamp each button with the current WO id so onclick doesn't rely on the global
  ['editwobtn','logbtn','voidbtn'].forEach(function(btnId){
    var btn = document.getElementById(btnId);
    if (btn) btn.dataset.woid = id;
  });
  var voidBtn = document.getElementById('voidbtn');
  var editBtn = document.getElementById('editwobtn');
  var logBtn  = document.getElementById('logbtn');
  var confirmBtn  = document.getElementById('confirmbtn');
  var completeBtn = document.getElementById('completebtn');
  if (confirmBtn)  confirmBtn.style.display  = (isAdminView && o.status === 'requested') ? 'inline-flex' : 'none';
  if (confirmBtn)  confirmBtn.dataset.woid    = id;
  if (completeBtn) completeBtn.style.display  = (isAdminView && o.status === 'scheduled') ? 'inline-flex' : 'none';
  if (completeBtn) completeBtn.dataset.woid   = id;
  if (voidBtn) voidBtn.style.display = (isAdminView && o.status !== 'vd') ? 'inline-flex' : 'none';
  if (editBtn) editBtn.style.display  = (isAdminView && o.status !== 'vd') ? 'inline-flex' : 'none';
  if (logBtn)  logBtn.style.display   = (isAdminView && o.log && o.log.length) ? 'inline-flex' : 'none';
  openM('mwo');
}
function togPhotos() {
  photosOn = !photosOn;
  var s = document.querySelector('.wophsec');
  if (s) s.style.display = photosOn ? '' : 'none';
  document.getElementById('phbtn').textContent = photosOn ? 'Include Photos' : 'Photos Hidden';
}

// ── FLOOR PLAN IMAGE ──
function openFpImg(id) {
  document.getElementById('fpsub').textContent = id;
  var fp = fpDetails[id];
  document.getElementById('fptitle').textContent = fp ? fp.name : 'Floor Plan';
  // fpStore removed — find image from new per-property store
  var img = null;
  getActiveProps().forEach(function(pr){
    loadFpForProp(pr.id).forEach(function(fp){
      if(fp.id===id && fp.images && fp.images.floorPlan) img = fp.images.floorPlan.src;
    });
  });
  var d = document.getElementById('fpimg');
  var n = document.getElementById('fpnone');
  if (img) { d.src = img; d.style.display = 'block'; n.style.display = 'none'; }
  else { d.style.display = 'none'; n.style.display = 'block'; }
  openM('mfp');
}
function handleFpUp(ev) {
  var file = ev.target.files[0]; if (!file) return;
  var rd = new FileReader();
  rd.onload = function(e) {
    document.getElementById('fupzone').style.display = 'none';
    document.getElementById('fupprev').style.display = 'block';
    document.getElementById('fupname').textContent = file.name;
    document.getElementById('fupsize').textContent = (file.size/1024).toFixed(0)+' KB';
    var th = document.getElementById('fupthumb');
    if (file.type.indexOf('image') >= 0) { th.innerHTML = '<img src="'+e.target.result+'" style="width:100%;height:100%;object-fit:cover;">'; }
    document.getElementById('fupinput')._src = e.target.result;
    toast('Image ready. Click Save Floor Plan to confirm.');
  };
  rd.readAsDataURL(file);
}
function clearFpUp() {
  document.getElementById('fupzone').style.display = 'block';
  document.getElementById('fupprev').style.display = 'none';
  document.getElementById('fupinput').value = '';
  document.getElementById('fupinput')._src = null;
}

// ── PROPERTIES (ADMIN) — functions defined earlier in script ──
function togProp(row) { row.classList.toggle('op'); }
function openEditFp(id) { document.getElementById('fpetitle').textContent='Edit Floor Plan'; openM('mfpe'); }
function openAddFp() { document.getElementById('fpetitle').textContent='Add Floor Plan'; openM('mfpe'); }

// ── PRESETS ──
function loadPresets(key) { /* merged into onPlanChange */ }
function applyPreset(btn,p) {
  document.querySelectorAll('.pqb').forEach(function(b){b.classList.remove('ap');});
  btn.classList.add('ap');
  document.querySelectorAll('#scopegrid .so').forEach(function(opt) {
    var room=opt.textContent.trim(),ck=opt.querySelector('.ck'),sel=p.rooms.indexOf(room)>=0;
    opt.classList.toggle('on',sel);
    if(ck) ck.textContent=sel?'\u2713':'';
  });
  if(p.svc) {
    var sel=document.getElementById('csvc');
    if(sel) for(var i=0;i<sel.options.length;i++){if(sel.options[i].text===p.svc){sel.selectedIndex=i;break;}}
  }
  toast('Preset applied: '+p.name);
}
function addProw() {
  var rooms=['Living Room','Master Bedroom','Bedroom 2','Bedroom 3','Bedroom 4','Kitchen','Bathroom 1','Bathroom 2','Hallway','Dining Area','Laundry Room','Entry','Entryway','Stairs'];
  var tags=rooms.map(function(r){return '<span class="prt" onclick="this.classList.toggle(\'on\')">"+r+"</span>';}).join('');
  var row=document.createElement('div');row.className='prow';
  row.innerHTML='<div class="form-row" style="margin-bottom:10px;"><div class="fg" style="margin-bottom:0;"><label>Preset Name *</label><input type="text" placeholder="e.g. Vinyl Wet+Dining"></div><div class="fg" style="margin-bottom:0;"><label>Default Service</label><select><option value="">-- Any --</option><option>Carpet Installation</option><option>Luxury Vinyl Plank (LVP)</option><option>Sheet Vinyl</option><option>Tile Installation</option><option>Pet Seal Treatment</option><option>Subfloor Repair</option><option>Repair</option><option>Call Back</option></select></div></div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;">'+tags+'</div><div style="margin-top:12px;text-align:right;"><button class="bs dn" onclick="this.closest(\'.prow\').remove()">Remove</button></div>';
  document.getElementById('prowcont').appendChild(row);
  row.scrollIntoView({behavior:'smooth',block:'nearest'});
}

// ── MODALS ──
function openM(id){document.getElementById(id).classList.add('op');}
function closeM(id){document.getElementById(id).classList.remove('op');}
document.querySelectorAll('.mb').forEach(function(b){
  b.addEventListener('click',function(e){if(e.target===b)b.classList.remove('op');});
});
function openConfirm(id) {
  var o=orders[id];
  if(o) document.getElementById('confinfo').textContent='#'+o.num+' — '+o.property+', Unit '+o.unit+' — '+o.service;
  document.getElementById('mconf').dataset.confId = id;
  var dateEl = document.getElementById('conf_date_input');
  if (dateEl) {
    // Auto-populate with requested install date; user can change if needed
    var reqIso = o.reqDate ? (o.reqDate.match(/^\d{4}-\d{2}-\d{2}$/) ? o.reqDate : displayToIso(o.reqDate)) : '';
    dateEl.value = reqIso || '';
  }
  var notesEl = document.getElementById('conf_notes_input');
  if (notesEl) notesEl.value = '';
  document.getElementById('conf_err').style.display='none';
  openM('mconf');
}

function saveConf() {
  var id = document.getElementById('mconf').dataset.confId;
  var o  = orders[id]; if (!o) return;
  var dateEl  = document.getElementById('conf_date_input');
  var notesEl = document.getElementById('conf_notes_input');
  var errEl   = document.getElementById('conf_err');
  var rawDate = dateEl ? dateEl.value : '';
  if (!rawDate) { errEl.style.display='block'; errEl.textContent='Please select a confirmed date.'; return; }
  var d = new Date(rawDate + 'T12:00:00');
  var confDateStr = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  o.status   = 'scheduled';
  o.confDate = confDateStr;
  if (notesEl && notesEl.value.trim()) {
    o.notes = (o.notes && o.notes !== 'No additional notes.' ? o.notes + '\n' : '') + 'Scheduling note: ' + notesEl.value.trim();
  }
  if (!o.log) o.log = [];
  o.log.push({
    ts: cstNow(), by: (window.currentTeamUser && window.currentTeamUser.name) || 'Admin',
    reason: 'Scheduled', changes:[{field:'Status',from:'Requested',to:'Scheduled'},{field:'Confirmed Date',from:'Pending',to:confDateStr}]
  });
  saveOrders();
  closeM('mconf');
  oworder(id);
  refreshAllOrderViews();
  var dispDate = (function(iso){
    var mn=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var pt=iso.split('-'); return mn[parseInt(pt[1],10)-1]+' '+parseInt(pt[2],10)+', '+pt[0];
  })(confDateStr);
  toast('Order #'+o.num+' confirmed for '+dispDate+'.');
}

// ── FORM HELPERS ──
function selRadio(el,group) {
  el.closest('.rg').querySelectorAll('.ro').forEach(function(o){o.classList.remove('on');});
  el.classList.add('on');
  if(group==='occ') {
    var n=document.getElementById('occnotice');
    if(n) n.style.display=el.querySelector('.rl').textContent==='Occupied'?'block':'none';
  }
}
function togScope(el) {
  el.classList.toggle('on');
  var c=el.querySelector('.ck');
  if(c) c.textContent=el.classList.contains('on')?'\u2713':'';
}
// ── CLIENT LOGIN POSITIONS ──
var DEFAULT_POSITIONS = [
  {id:'pos1', name:'Property Manager'},
  {id:'pos2', name:'Assistant Property Manager'},
  {id:'pos3', name:'Regional Manager'},
  {id:'pos4', name:'Maintenance Supervisor'},
  {id:'pos5', name:'Maintenance'},
  {id:'pos6', name:'Leasing Agent'}
];
function loadPositions() {
  try {
    var s = localStorage.getItem('pf_positions');
    return s ? JSON.parse(s) : JSON.parse(JSON.stringify(DEFAULT_POSITIONS));
  } catch(e) { return JSON.parse(JSON.stringify(DEFAULT_POSITIONS)); }
}
function savePositions(arr) {
  try { localStorage.setItem('pf_positions', JSON.stringify(arr)); } catch(e) {}
}
function buildPosOptions(selected) {
  var html = '<option value="">Select position...</option>';
  loadPositions().forEach(function(pos) {
    html += '<option value="' + pos.name + '"' + (pos.name === selected ? ' selected' : '') + '>' + pos.name + '</option>';
  });
  return html;
}

function openMuser() {
  populateAllMarketsSelect('mu_hub', 'all');
  // Populate position dropdown
  document.getElementById('mu_role').innerHTML = buildPosOptions('');
  // Reset hub filter
  var hubSel = document.getElementById('mu_hub');
  if (hubSel) hubSel.value = 'all';
  // Build dynamic property list
  buildUserPropList('uproplist', []);
  filterUserProps('all');
  // Clear form fields
  ['mu_first','mu_last','mu_email','mu_pw','mu_pw2'].forEach(function(id){
    var el = document.getElementById(id); if (el) el.value = '';
  });
  var searchEl = document.getElementById('mu_prop_search');
  if (searchEl) searchEl.value = '';
  var errEl = document.getElementById('mu_err');
  if (errEl) errEl.style.display = 'none';
  openM('muser');
}

function addQuickPosition() {
  var inp = document.getElementById('mu_new_pos');
  var name = (inp ? inp.value : '').trim();
  if (!name) { toast('Enter a position name.'); return; }
  var positions = loadPositions();
  if (positions.find(function(pos){ return pos.name.toLowerCase() === name.toLowerCase(); })) {
    toast('That position already exists.');
    // Still select it
    document.getElementById('mu_role').innerHTML = buildPosOptions(name);
    document.getElementById('mu_role').value = name;
    if (inp) inp.value = '';
    return;
  }
  positions.push({id:'pos_'+Date.now().toString(36), name: name});
  savePositions(positions);
  // Rebuild dropdown and select the new one
  document.getElementById('mu_role').innerHTML = buildPosOptions(name);
  document.getElementById('mu_role').value = name;
  if (inp) inp.value = '';
  toast('"' + name + '" added as a position.');
}

function buildUserPropList(containerId, checkedProps) {
  var container = document.getElementById(containerId);
  if (!container) return;
  var props = getActiveProps();
  container.innerHTML = '';
  if (!props.length) {
    container.innerHTML = '<div style="padding:12px;color:var(--gray);font-size:13px;grid-column:1/-1;">No active properties found.</div>';
    return;
  }
  props.forEach(function(pr) {
    var isChecked = checkedProps && checkedProps.indexOf(pr.name) >= 0;
    var hub = (pr.hub || 'memphis').toLowerCase();
    var hubLabel = hub === 'nashville' ? 'Nashville' : 'Memphis';
    var lbl = document.createElement('label');
    lbl.className = 'uprop-item';
    lbl.setAttribute('data-hub', hub);
    lbl.setAttribute('data-name', pr.name.toLowerCase());
    lbl.innerHTML = '<input type="checkbox" name="uprop" value="' + pr.name + '"' + (isChecked ? ' checked' : '') + '>'
      + '<div><div style="font-size:13px;font-weight:600;color:var(--navy);">' + pr.name + '</div>'
      + '<div style="font-size:11px;color:var(--gray);">' + hubLabel + '</div></div>';
    lbl.querySelector('input').addEventListener('change', function(){ applyUserPropFilters(); });
    container.appendChild(lbl);
  });
  applyUserPropFilters();
}

function applyUserPropFilters() {
  var hub    = (document.getElementById('mu_hub') || {value:'all'}).value;
  var search = ((document.getElementById('mu_prop_search') || {value:''}).value || '').toLowerCase().trim();
  var shown = 0, total = 0;
  document.querySelectorAll('#uproplist .uprop-item').forEach(function(item) {
    total++;
    var itemHub  = (item.getAttribute('data-hub') || '').toLowerCase();
    var itemName = (item.getAttribute('data-name') || '').toLowerCase();
    var hubOk  = !hub || hub === 'all' || itemHub === hub;
    var nameOk = !search || itemName.indexOf(search) >= 0;
    var show = hubOk && nameOk;
    item.style.display = show ? 'flex' : 'none';
    if (show) shown++;
  });
  var checked = document.querySelectorAll('#uproplist input[type=checkbox]:checked').length;
  var countEl = document.getElementById('mu_prop_count');
  if (countEl) {
    countEl.textContent = checked + ' selected · ' + (shown < total ? shown + ' of ' + total + ' shown' : total + ' properties');
  }
}

function filterUserProps(hub) { applyUserPropFilters(); }
function filterUserPropSearch(val) { applyUserPropFilters(); }

function updatePropCount(containerId) {
  var container = document.getElementById(containerId);
  if (!container) return;
  var total   = container.querySelectorAll('.uprop-item').length;
  var visible = container.querySelectorAll('.uprop-item:not([style*="display: none"]):not([style*="display:none"])').length;
  var checked = container.querySelectorAll('input[type=checkbox]:checked').length;
  var countEl = document.getElementById(containerId === 'uproplist' ? 'mu_prop_count' : 'eu_prop_count');
  if (countEl) countEl.textContent = checked + ' selected' + (visible < total ? ' · ' + visible + ' shown' : ' · ' + total + ' properties');
}
document.querySelectorAll('.uprop-item').forEach(function(item) {
  var cb=item.querySelector('input[type=checkbox]');
  function update(){item.style.borderColor=cb.checked?'var(--navy)':'';item.style.background=cb.checked?'var(--navy-lt)':'var(--white)';}
  cb.addEventListener('change',update);
  item.addEventListener('mouseenter',function(){if(!cb.checked)item.style.borderColor='var(--gold)';});
  item.addEventListener('mouseleave',function(){if(!cb.checked)item.style.borderColor='';});
});

// ── SUBMIT ──

// ── Work Order Number Generator ──
// Format: ME0001 (Memphis) or NA0001 (Nashville)
function nextWoNum(hub) {
  var prefix = (hub && hub.toLowerCase().indexOf('nash') >= 0) ? 'NA' : 'ME';
  var max = 0;
  Object.keys(orders).forEach(function(id) {
    var num = (orders[id].num || '').toString();
    if (num.indexOf(prefix) === 0) {
      var n = parseInt(num.slice(2), 10);
      if (!isNaN(n) && n > max) max = n;
    }
  });
  return prefix + String(max + 1).padStart(4, '0');
}

function submitOrder() {
  // ── Collect values ──
  var propSel   = document.getElementById('cpropsel');
  var planSel   = document.getElementById('cplan');
  var unitEl    = document.getElementById('cunitinput');
  var svcEl     = document.getElementById('csvc');
  var dateEl    = document.getElementById('cinstdate');
  var notesEl   = document.getElementById('cnotes');

  var propVal   = propSel ? propSel.value : '';
  var planVal   = planSel ? planSel.value : '';
  var unitVal   = unitEl  ? unitEl.value.trim() : '';
  var svcVal    = svcEl   ? svcEl.value : '';
  var dateVal   = dateEl  ? dateEl.value : '';
  var notesVal  = notesEl ? notesEl.value.trim() : '';

  // ── Collect scopes: preset chips (chosen) + scopegrid checkmarks ──
  var selectedScopes = [];
  document.querySelectorAll('#fpscopes-chips .scope-chip-sel.chosen').forEach(function(el){
    selectedScopes.push(el.getAttribute('data-scope'));
  });
  document.querySelectorAll('#scopegrid .so.on').forEach(function(el){
    var txt = el.textContent.trim();
    if (txt && selectedScopes.indexOf(txt) === -1) selectedScopes.push(txt);
  });

  // ── Validation ──
  var errors = [];
  if (!propVal)  errors.push('Property is required.');
  if (!unitVal)  errors.push('Unit number is required.');
  if (!planVal)  errors.push('Floor Plan is required.');
  if (!dateVal)  errors.push('Requested install date is required.');
  // Service OR at least one scope is required
  if (!svcVal && selectedScopes.length === 0)
    errors.push('Select a Flooring Service and/or at least one Installation Scope.');

  if (errors.length) {
    toast(errors[0]);
    return;
  }

  // ── Build work order ──
  var occEl    = document.querySelector('#co .ro.on .rl');
  var occ      = occEl ? occEl.textContent : 'Vacant';
  var propName = propSel.options[propSel.selectedIndex].text;
  var planName = planSel.options[planSel.selectedIndex].text;
  var today    = new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  // Store reqDate as ISO YYYY-MM-DD for consistent date filtering
  var _rdParsed = dateVal ? new Date(dateVal + 'T12:00:00') : new Date();
  var reqDate = _rdParsed.getFullYear()+'-'+String(_rdParsed.getMonth()+1).padStart(2,'0')+'-'+String(_rdParsed.getDate()).padStart(2,'0');

  // Determine hub for this order to get correct prefix
  var _woHub = (function(){
    var _pr = null;
    getActiveProps().forEach(function(pr){ if(pr.name===propName) _pr=pr; });
    if (!_pr) return 'Memphis';
    var _m = getMarket(_pr.hub); return _m ? _m.label : (_pr.hub.charAt(0).toUpperCase()+_pr.hub.slice(1));
  })();
  var woNum = nextWoNum(_woHub);
  var woId  = woNum;

  orders[woId] = {
    num:           woNum,
    property:      propName,
    hub:           _woHub,
    unit:          unitVal,
    plan:          planName,
    sqft:          '',
    occ:           occ,
    service:       svcVal || (selectedScopes.length ? selectedScopes.join(', ') : 'See Work Order'),
    scope:         selectedScopes.length ? selectedScopes : (svcVal ? [svcVal] : []),
    reqDate:       reqDate,
    confDate:      'Pending',
    status:        'requested',
    submittedBy:   (currentUser && currentUser.name) || 'Portal User',
    submittedDate: today,
    email:         (currentUser && currentUser.email) || '',
    notes:         notesVal || 'No additional notes.',
    timeWindow:    'To be confirmed',
    photos:        false
  };

  toast('\u2713 Order submitted! Your request has been received.');

  // Reset form
  if (planSel) planSel.selectedIndex = 0;
  if (unitEl)  unitEl.value = '';
  if (svcEl)   svcEl.selectedIndex = 0;
  if (dateEl)  dateEl.value = '';
  if (notesEl) notesEl.value = '';
  document.querySelectorAll('#fpscopes-chips .scope-chip-sel.chosen').forEach(function(el){ el.classList.remove('chosen'); });
  document.querySelectorAll('#scopegrid .so.on').forEach(function(el){ el.classList.remove('on'); });
  var prev = document.getElementById('fppreview');
  if (prev) prev.style.display = 'none';

  saveOrders();
  refreshAllOrderViews();
  setTimeout(function(){ cnav('ch', document.querySelector('#cl .ni[onclick*=\"ch\"]')); }, 1400);
}

function saveFp() {
  var n=document.getElementById('fpname');
  if(n&&!n.value.trim()){toast('Please enter a floor plan name.');return;}
  var inp=document.getElementById('fupinput');
  // fpStore removed — images saved via slot upload system in mfpe modal
  closeM('mfpe');toast('Floor plan saved.');
}




// ── FLOOR PLAN ADMIN MANAGEMENT ──



function openAddFloorPlan() {
  var propKey = document.getElementById('afp_propsel').value;
  document.getElementById('mfpadd_title').textContent = 'Add Floor Plan';
  document.getElementById('fpa_prop').value = propKey;
  document.getElementById('fpa_id_orig').value = '';
  document.getElementById('fpa_name').value = '';
  document.getElementById('fpa_sqft').value = '';
  document.getElementById('fpa_beds').value = '1';
  document.getElementById('fpa_baths').value = '1';
  document.getElementById('fpa_rooms').value = '';
  document.getElementById('fpa_delbtn').style.display = 'none';
  document.getElementById('fpa_err').style.display = 'none';
  openM('mfpadd');
}

function openEditFloorPlan(idx) {
  var propKey = document.getElementById('afp_propsel').value;
  var fps = getFpData(propKey);
  var fp = fps[idx];
  if (!fp) return;
  document.getElementById('mfpadd_title').textContent = 'Edit Floor Plan';
  document.getElementById('fpa_prop').value = propKey;
  document.getElementById('fpa_id_orig').value = fp.id;
  document.getElementById('fpa_name').value = fp.name;
  document.getElementById('fpa_sqft').value = fp.sqft;
  document.getElementById('fpa_beds').value = String(fp.beds);
  document.getElementById('fpa_baths').value = String(fp.baths);
  document.getElementById('fpa_rooms').value = (fp.rooms || []).join('\n');
  document.getElementById('fpa_delbtn').style.display = 'inline-flex';
  document.getElementById('fpa_err').style.display = 'none';
  openM('mfpadd');
}

function saveFloorPlan() {
  var propKey = document.getElementById('fpa_prop').value;
  var origId  = document.getElementById('fpa_id_orig').value;
  var name    = document.getElementById('fpa_name').value.trim();
  var sqft    = document.getElementById('fpa_sqft').value.trim();
  var beds    = parseInt(document.getElementById('fpa_beds').value);
  var baths   = parseFloat(document.getElementById('fpa_baths').value);
  var roomsRaw = document.getElementById('fpa_rooms').value;
  var err     = document.getElementById('fpa_err');
  err.style.display = 'none';
  if (!name) { err.textContent = 'Plan name is required.'; err.style.display = 'block'; return; }
  if (!sqft) { err.textContent = 'Square footage is required.'; err.style.display = 'block'; return; }
  var rooms = roomsRaw.split('\n').map(function(r){return r.trim();}).filter(Boolean);
  var renovated = /renovat/i.test(name);
  // Generate ID from prop key + sanitized name
  var newId = propKey.toUpperCase().replace(/-/g,'_').substring(0,4) + '_' + name.toUpperCase().replace(/[^A-Z0-9]/g,'_').substring(0,12);
  var fps = getFpData(propKey);
  if (origId) {
    // Edit existing
    for (var i = 0; i < fps.length; i++) {
      if (fps[i].id === origId) {
        fps[i] = {id: origId, name: name, sqft: sqft, beds: beds, baths: baths, rooms: rooms, renovated: renovated};
        break;
      }
    }
  } else {
    // Check duplicate name
    for (var j = 0; j < fps.length; j++) {
      if (fps[j].name.toLowerCase() === name.toLowerCase()) {
        err.textContent = 'A floor plan with that name already exists.'; err.style.display = 'block'; return;
      }
    }
    fps.push({id: newId, name: name, sqft: sqft, beds: beds, baths: baths, rooms: rooms, renovated: renovated});
  }
  saveFpData(propKey, fps);
  closeM('mfpadd');
  renderAdminFpTable();
  toast('Floor plan saved: ' + name);
}

function deleteFloorPlan() {
  var propKey = document.getElementById('fpa_prop').value;
  var origId  = document.getElementById('fpa_id_orig').value;
  var name    = document.getElementById('fpa_name').value;
  if (!confirm('Delete floor plan "' + name + '"? This cannot be undone.')) return;
  var fps = getFpData(propKey).filter(function(fp){ return fp.id !== origId; });
  saveFpData(propKey, fps);
  closeM('mfpadd');
  renderAdminFpTable();
  toast('Floor plan deleted.');
}
// ── END FLOOR PLAN ADMIN MANAGEMENT ──

// ── PORTAL USER (TEAM) MANAGEMENT ──
function roleLabel(role) {
  if (role==='superadmin') return '<span class="rl-sa">&#128737; Super Admin</span>';
  if (role==='admin')      return '<span class="rl-ad">&#128274; Admin</span>';
  if (role==='management') return '<span class="rl-mg">&#127970; Management</span>';
  if (role==='sales')      return '<span class="rl-sl">&#128200; Sales</span>';
  if (role==='editor')     return '<span class="rl-ed">&#9998; Editor</span>';
  return '<span class="b in">'+(role||'--')+'</span>';
}
function renderTeamTable() {
  var team = getTeam();
  var tb = document.getElementById('teamTbody');
  if (!tb) return;
  var isSA = (window._portalRole==='superadmin');
  var isAdmin = (window._portalRole==='superadmin'||window._portalRole==='admin');
  tb.innerHTML = team.map(function(u) {
    var sbadge = u.status==='active' ? '<span class="b ac">Active</span>' : '<span class="b in">Inactive</span>';
    var initials = u.initials || (u.name||'?')[0];
    var nameCell = '<div style="display:flex;align-items:center;gap:10px;">'
      + '<div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--navy),#1a2d9a);color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;">' + initials + '</div>'
      + '<div><div style="font-weight:600;font-size:13px;">' + u.name + '</div></div></div>';
    var actions = '<div style="display:flex;gap:6px;">';
    if (isAdmin) actions += '<button class="bs ol" onclick="openEditTeamUser(\''+u.id+'\')">Edit</button>';
    if (isSA && u.role!=='superadmin') {
      actions += u.status==='active'
        ? '<button class="bs dn" onclick="toggleTeamStatus(\''+u.id+'\',\'inactive\')">Suspend</button>'
        : '<button class="bs gn" onclick="toggleTeamStatus(\''+u.id+'\',\'active\')">Activate</button>';
    }
    actions += '</div>';
    return '<tr>'
      + '<td>' + nameCell + '</td>'
      + '<td style="color:var(--gray);font-size:12px;">' + u.email + '</td>'
      + '<td>' + roleLabel(u.role) + '</td>'
      + '<td style="color:var(--gray);font-size:12px;">' + (u.hub || '—') + '</td>'
      + '<td style="color:var(--gray);font-size:12px;">' + (u.lastLogin||'Never') + '</td>'
      + '<td>' + sbadge + '</td>'
      + '<td style="color:var(--gray);font-size:12px;">' + (u.created||'--') + '</td>'
      + '<td>' + actions + '</td></tr>';
  }).join('');
}

function openAddTeamUser() {
  ['tm_first','tm_last','tm_email','tm_pw','tm_pw2'].forEach(function(id){ var el=document.getElementById(id); if(el) el.value=''; });
  document.getElementById('tm_role').value = 'admin';
  document.getElementById('tm_err').style.display = 'none';
  populateHubSelect('tm_hub', '', 'All Hubs');
  syncPermCheckboxes('tm');
  // Hide superadmin option if not superadmin
  var isSA = (window._portalRole==='superadmin');
  var saOpt = document.querySelector('#tm_role option[value="superadmin"]');
  if (saOpt) saOpt.style.display = isSA ? '' : 'none';
  openM('mteam');
}

// ── PERMISSION SYSTEM ──

// Role default permission sets
var ROLE_PERMS = {
  superadmin:  {view_orders:1,edit_orders:1,void_orders:1,confirm_orders:1,view_props:1,edit_props:1,edit_fps:1,leads:1,proposals:1,reports:1,clients:1,users:1,settings:1},
  admin:       {view_orders:1,edit_orders:1,void_orders:1,confirm_orders:1,view_props:1,edit_props:1,edit_fps:1,leads:1,proposals:1,reports:1,clients:1,users:1,settings:1},
  management:  {view_orders:1,edit_orders:1,void_orders:1,confirm_orders:1,view_props:1,edit_props:1,edit_fps:1,leads:1,proposals:1,reports:1,clients:0,users:0,settings:0},
  sales:       {view_orders:1,edit_orders:0,void_orders:0,confirm_orders:0,view_props:1,edit_props:0,edit_fps:0,leads:1,proposals:1,reports:0,clients:0,users:0,settings:0},
  editor:      {view_orders:1,edit_orders:1,void_orders:0,confirm_orders:1,view_props:1,edit_props:1,edit_fps:1,leads:0,proposals:0,reports:0,clients:0,users:0,settings:0}
};

var PERM_KEYS = ['view_orders','edit_orders','void_orders','confirm_orders','view_props','edit_props','edit_fps','leads','proposals','reports','clients','users','settings'];

// Sync checkboxes to role defaults (prefix = 'tm' or 'te')
function syncPermCheckboxes(prefix) {
  var role = (document.getElementById(prefix+'_role')||{}).value || 'editor';
  var defaults = ROLE_PERMS[role] || ROLE_PERMS.editor;
  PERM_KEYS.forEach(function(k) {
    var cb = document.getElementById(prefix+'_p_'+k);
    if (cb) cb.checked = !!defaults[k];
  });
  // Lock superadmin — all perms always on
  var isLocked = (role === 'superadmin');
  PERM_KEYS.forEach(function(k) {
    var row = document.getElementById(prefix+'_p_'+k);
    if (row) row.parentElement.classList.toggle('locked', isLocked);
  });
}

// Read checkboxes into permissions object
function readPermCheckboxes(prefix) {
  var perms = {};
  PERM_KEYS.forEach(function(k) {
    var cb = document.getElementById(prefix+'_p_'+k);
    perms[k] = cb ? (cb.checked ? 1 : 0) : 0;
  });
  return perms;
}

// Set checkboxes from saved permissions object
function setPermCheckboxes(prefix, perms) {
  PERM_KEYS.forEach(function(k) {
    var cb = document.getElementById(prefix+'_p_'+k);
    if (cb) cb.checked = !!(perms && perms[k]);
  });
}

function saveNewTeamUser() {
  var first = (document.getElementById('tm_first').value||'').trim();
  var last  = (document.getElementById('tm_last').value||'').trim();
  var email = (document.getElementById('tm_email').value||'').trim().toLowerCase();
  var pw    = document.getElementById('tm_pw').value;
  var pw2   = document.getElementById('tm_pw2').value;
  var role  = document.getElementById('tm_role').value;
  var hub   = (document.getElementById('tm_hub')||{value:''}).value;
  var err   = document.getElementById('tm_err');
  err.style.display='none';
  if (!first||!last)           { err.textContent='First and last name required.'; err.style.display='block'; return; }
  if (!email||!email.includes('@')) { err.textContent='Valid email required.'; err.style.display='block'; return; }
  if (pw.length<8)             { err.textContent='Password must be at least 8 characters.'; err.style.display='block'; return; }
  if (pw!==pw2)                { err.textContent='Passwords do not match.'; err.style.display='block'; return; }
  var team = getTeam();
  for (var i=0;i<team.length;i++) { if(team[i].email===email){err.textContent='Email already exists.';err.style.display='block';return;} }
  var today=new Date(), months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  team.push({
    id:'t'+Date.now(), email:email, password:pw,
    name:first+' '+last, initials:(first[0]+last[0]).toUpperCase(),
    role:role, hub:hub, status:'active', perms:readPermCheckboxes('tm'),
    created:months[today.getMonth()]+' '+today.getDate()+', '+today.getFullYear()
  });
  saveTeam(team);
  ADMIN_USERS = getTeam();
  closeM('mteam');
  renderTeamTable();
  toast('Portal user created: '+first+' '+last+'.');
}

function openEditTeamUser(uid) {
  var team=getTeam(), u=null;
  for(var i=0;i<team.length;i++){if(team[i].id===uid){u=team[i];break;}}
  if(!u)return;
  document.getElementById('te_id').value=u.id;
  var parts=u.name.split(' ');
  document.getElementById('te_first').value=parts[0]||'';
  document.getElementById('te_last').value=parts.slice(1).join(' ')||'';
  document.getElementById('te_email').value=u.email;
  document.getElementById('te_pw').value='';
  document.getElementById('te_pw2').value='';
  document.getElementById('te_role').value=u.role||'admin';
  populateHubSelect('te_hub', u.hub||'', 'All Hubs');
  document.getElementById('te_status').value=u.status||'active';
  document.getElementById('te_err').style.display='none';
  // Load saved perms or fall back to role defaults
  if (u.perms) { setPermCheckboxes('te', u.perms); }
  else { syncPermCheckboxes('te'); }
  // Lock if superadmin
  var isLocked = (u.role==='superadmin');
  PERM_KEYS.forEach(function(k) {
    var row = document.getElementById('te_p_'+k);
    if (row) row.parentElement.classList.toggle('locked', isLocked);
  });
  openM('mteamedit');
}

function saveEditTeamUser() {
  var uid   = document.getElementById('te_id').value;
  var first = (document.getElementById('te_first').value||'').trim();
  var last  = (document.getElementById('te_last').value||'').trim();
  var email = (document.getElementById('te_email').value||'').trim().toLowerCase();
  var pw    = document.getElementById('te_pw').value;
  var pw2   = document.getElementById('te_pw2').value;
  var err   = document.getElementById('te_err');
  err.style.display='none';
  if(!first||!last){err.textContent='Name required.';err.style.display='block';return;}
  if(!email||!email.includes('@')){err.textContent='Valid email required.';err.style.display='block';return;}
  if(pw&&pw.length<8){err.textContent='Password must be at least 8 characters.';err.style.display='block';return;}
  if(pw&&pw!==pw2){err.textContent='Passwords do not match.';err.style.display='block';return;}
  var team=getTeam();
  for(var i=0;i<team.length;i++){
    if(team[i].id===uid){
      team[i].name=first+' '+last;
      team[i].initials=(first[0]+last[0]).toUpperCase();
      team[i].email=email;
      team[i].role=document.getElementById('te_role').value;
      team[i].hub=(document.getElementById('te_hub')||{value:''}).value;
      team[i].status=document.getElementById('te_status').value;
      team[i].perms=readPermCheckboxes('te');
      if(pw) team[i].password=pw;
      break;
    }
  }
  saveTeam(team);
  ADMIN_USERS=getTeam();
  closeM('mteamedit');
  renderTeamTable();
  toast('User updated.');
}

function toggleTeamStatus(uid, newStatus) {
  var team=getTeam();
  for(var i=0;i<team.length;i++){if(team[i].id===uid){team[i].status=newStatus;break;}}
  saveTeam(team);
  ADMIN_USERS=getTeam();
  renderTeamTable();
  toast(newStatus==='active'?'Account reactivated.':'Account suspended.');
}

function deleteTeamUser() {
  var uid=document.getElementById('te_id').value;
  var name=document.getElementById('te_first').value+' '+document.getElementById('te_last').value;
  var team=getTeam();
  if(team.length<=1){toast('Cannot delete the last admin user.');return;}
  if(!confirm('Permanently delete '+name.trim()+'? This cannot be undone.'))return;
  team=team.filter(function(u){return u.id!==uid;});
  saveTeam(team);
  ADMIN_USERS=getTeam();
  closeM('mteamedit');
  renderTeamTable();
  toast('User deleted.');
}

function applyRoleRestrictions(role) {
  // ── NAV VISIBILITY ──
  // Portal Users: superadmin + admin only
  document.querySelectorAll('[onclick*="ateam"]').forEach(function(el) {
    el.style.display = (role==='superadmin'||role==='admin') ? '' : 'none';
  });
  // Portal Settings: superadmin + admin only
  document.querySelectorAll('[onclick*="aset"]').forEach(function(el) {
    el.style.display = (role==='superadmin'||role==='admin') ? '' : 'none';
  });
  // Client Logins panel: superadmin + admin only
  document.querySelectorAll('[onclick*="ausers"]').forEach(function(el) {
    el.style.display = (role==='superadmin'||role==='admin') ? '' : 'none';
  });
  // All Orders: superadmin + admin + management
  document.querySelectorAll('[onclick*="aord"]').forEach(function(el) {
    el.style.display = (role==='superadmin'||role==='admin'||role==='management') ? '' : 'none';
  });

  // ── WRITE CONTROLS ──
  // Properties: add/edit/delete buttons — superadmin, admin, management, editor
  var canEditProps = (role==='superadmin'||role==='admin'||role==='management'||role==='editor');
  document.querySelectorAll('#aprops .bs.gd').forEach(function(b){ b.style.display=canEditProps?'':'none'; });

  // Client logins: add/edit — superadmin + admin only
  var canEditClients = (role==='superadmin'||role==='admin');
  document.querySelectorAll('#ausers .bs.gd').forEach(function(b){ b.style.display=canEditClients?'':'none'; });

  // Portal Users: delete button — superadmin only; role dropdown — superadmin only
  var isSuperAdmin = (role==='superadmin');
  var delbtn = document.querySelector('#mteamedit .bl.dn');
  if (delbtn) delbtn.style.display = isSuperAdmin ? '' : 'none';
  // Only superadmin can assign superadmin role
  var tmRole = document.getElementById('tm_role');
  var teRole = document.getElementById('te_role');
  [tmRole, teRole].forEach(function(sel) {
    if (!sel) return;
    var saOpt = sel.querySelector('option[value="superadmin"]');
    if (saOpt) saOpt.style.display = isSuperAdmin ? '' : 'none';
  });

  // ── DASHBOARD ACCESS ──
  // Sales: dashboard shows but only their own leads/proposals (future)
  // Editor: can see dashboard orders but not financials
  // Hide nav items based on actual permissions
  if (!can('edit_props') && !can('view_props')) {
    document.querySelectorAll('[onclick*="aprops"]').forEach(function(el){ el.style.display='none'; });
  }
  if (!can('clients')) {
    document.querySelectorAll('[onclick*="ausers"]').forEach(function(el){ el.style.display='none'; });
  }
  if (!can('users')) {
    document.querySelectorAll('[onclick*="ateam"]').forEach(function(el){ el.style.display='none'; });
  }
  if (!can('settings')) {
    document.querySelectorAll('[onclick*="aset"]').forEach(function(el){ el.style.display='none'; });
  }

  // ── HEADER BADGE ──
  var badge = document.querySelector('.abadge');
  if (badge) {
    var labels = {superadmin:'&#128737; Super Admin',admin:'&#128274; Admin',management:'&#127970; Management',sales:'&#128200; Sales',editor:'&#9998; Editor'};
    badge.innerHTML = labels[role] || role;
  }

  // Store role globally for runtime checks
  window._portalRole = role;
}

// Runtime permission check — call anywhere to gate actions
function can(action) {
  // Check per-user override perms first (stored on currentTeamUser)
  var u = window.currentTeamUser;
  if (u && u.perms && typeof u.perms[action] !== 'undefined') {
    return !!u.perms[action];
  }
  // Fall back to role defaults
  var r = window._portalRole || 'editor';
  var defaults = ROLE_PERMS[r] || ROLE_PERMS.editor;
  return !!defaults[action];
}

// ── END PORTAL USER MANAGEMENT ──

// ── USER MANAGEMENT ──
function daysSince(isoStr) {
  if (!isoStr) return null;
  var then = new Date(isoStr);
  if (isNaN(then)) return null;
  var diff = Math.floor((Date.now() - then.getTime()) / 86400000);
  return diff;
}

function renderUserTable() {
  var tb = document.getElementById('ucl_tbody');
  if (!tb) tb = document.querySelector('#ausers tbody');
  if (!tb) return;

  // Populate hub filter
  populateHubKeySelect('ucl_hub', (document.getElementById('ucl_hub')||{value:''}).value, 'All Hubs');

  var q       = ((document.getElementById('ucl_search')||{value:''}).value||'').trim().toLowerCase();
  var hubF    = (document.getElementById('ucl_hub')||{value:''}).value;
  var statusF = (document.getElementById('ucl_status')||{value:''}).value;
  var sortF   = (document.getElementById('ucl_sort')||{value:'recent'}).value;

  var clients = getUsers().filter(function(u) {
    if (statusF && u.status !== statusF) return false;
    if (hubF && u.hub !== hubF) return false;
    if (q) {
      var hay = (u.name+' '+u.email+' '+(u.props||[]).join(' ')).toLowerCase();
      if (hay.indexOf(q) === -1) return false;
    }
    return true;
  });

  clients.sort(function(a, b) {
    if (sortF === 'name') return (a.name||'').localeCompare(b.name||'');
    if (sortF === 'never') {
      var an = !a.lastLoginISO, bn = !b.lastLoginISO;
      if (an && bn) return (a.name||'').localeCompare(b.name||'');
      if (an) return -1; if (bn) return 1;
    }
    // recent / oldest — sort by ISO timestamp
    var at = a.lastLoginISO ? new Date(a.lastLoginISO).getTime() : 0;
    var bt = b.lastLoginISO ? new Date(b.lastLoginISO).getTime() : 0;
    return sortF === 'oldest' ? at - bt : bt - at;
  });

  var countEl = document.getElementById('ucl_count');
  if (countEl) countEl.textContent = '(' + clients.length + ')';

  if (clients.length === 0) {
    tb.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--gray);">No matching client logins.</td></tr>';
    return;
  }

  tb.innerHTML = clients.map(function(u) {
    var hbadge = u.hub === 'memphis'
      ? '<span class="b mp">Memphis</span>'
      : u.hub === 'nashville'
        ? '<span class="b nv">Nashville</span>'
        : '<span class="b in">--</span>';
    var sbadge = u.status === 'active'
      ? '<span class="b ac">Active</span>'
      : '<span class="b in">Inactive</span>';
    var props = (u.props || []).join(', ');
    // Last login cell
    var days = daysSince(u.lastLoginISO);
    var loginCell;
    if (!u.lastLogin) {
      loginCell = '<span style="color:var(--gray);font-size:12px;" title="Gray — No login on record. Client has never accessed the portal.">Never</span>';
    } else {
      var daysLabel, daysColor, daysTitle;
      if (days === 0)       { daysLabel = 'today';          daysColor = '#15803d'; daysTitle = 'Green — Logged in today. Client is actively using the portal.'; }
      else if (days === 1)  { daysLabel = '1 day ago';      daysColor = '#15803d'; daysTitle = 'Green — Logged in yesterday. Client is recently active.'; }
      else if (days <= 7)   { daysLabel = days+' days ago'; daysColor = '#b45309'; daysTitle = 'Amber — Last login was '+days+' days ago. Client activity is slowing — consider a follow-up.'; }
      else if (days <= 30)  { daysLabel = days+' days ago'; daysColor = '#b45309'; daysTitle = 'Amber — Last login was '+days+' days ago. Client has not logged in recently.'; }
      else                  { daysLabel = days+' days ago'; daysColor = '#b91c1c'; daysTitle = 'Red — Last login was '+days+' days ago. Client is inactive — follow up recommended.'; }
      loginCell = '<div style="font-size:12px;color:var(--text);">' + u.lastLogin + '</div>'
        + '<div style="font-size:11px;color:'+daysColor+';margin-top:1px;cursor:default;" title="'+daysTitle+'">('+daysLabel+')</div>';
    }
    return '<tr>'
      + '<td><strong>' + u.name + '</strong></td>'
      + '<td style="font-size:12px;color:var(--gray);">' + u.email + '</td>'
      + '<td style="font-size:12px;">' + props + '</td>'
      + '<td>' + hbadge + '</td>'
      + '<td style="font-size:12px;">' + (u.role || 'Property Manager') + '</td>'
      + '<td>' + sbadge + '</td>'
      + '<td>' + loginCell + '</td>'
      + '<td><div style="display:flex;gap:6px;">'
      +   '<button class="bs ol" onclick="openEditUser(\'' + u.id + '\')">Edit</button>'
      +   (u.status === 'active'
            ? '<button class="bs dn" onclick="toggleUserStatus(\'' + u.id + '\',\'inactive\')">Suspend</button>'
            : '<button class="bs gn" onclick="toggleUserStatus(\'' + u.id + '\',\'active\')">Activate</button>')
      + '</div></td>'
      + '</tr>';
  }).join('');
}

function saveNewUser() {
  var first = (document.getElementById('mu_first').value || '').trim();
  var last  = (document.getElementById('mu_last').value || '').trim();
  var email = (document.getElementById('mu_email').value || '').trim().toLowerCase();
  var pw    = document.getElementById('mu_pw').value;
  var pw2   = document.getElementById('mu_pw2').value;
  var err   = document.getElementById('mu_err');

  err.style.display = 'none';
  if (!first || !last)          { err.textContent = 'First and last name are required.'; err.style.display='block'; return; }
  if (!email || !email.includes('@')) { err.textContent = 'A valid email address is required.'; err.style.display='block'; return; }
  if (pw.length < 8)            { err.textContent = 'Password must be at least 8 characters.'; err.style.display='block'; return; }
  if (pw !== pw2)               { err.textContent = 'Passwords do not match.'; err.style.display='block'; return; }

  // Check for duplicate email
  var clients = getUsers();
  for (var i = 0; i < clients.length; i++) {
    if (clients[i].email === email) { err.textContent = 'A login with this email already exists.'; err.style.display='block'; return; }
  }

  // Collect selected properties
  var props = [];
  document.querySelectorAll('#uproplist input[type=checkbox]:checked').forEach(function(cb) { props.push(cb.value); });
  if (props.length === 0) { err.textContent = 'Assign at least one property.'; err.style.display='block'; return; }

  // Detect hub from actual property records
  var allProps = getActiveProps();
  var hasNash = false, hasMem = false;
  props.forEach(function(pname) {
    var pr = allProps.find(function(x){ return x.name === pname; });
    if (pr && pr.hub === 'nashville') hasNash = true;
    else hasMem = true;
  });
  var hub = hasNash && hasMem ? 'both' : hasNash ? 'nashville' : 'memphis';

  // Role
  var roleEl = document.getElementById('mu_role');
  var role = roleEl ? roleEl.value : 'Property Manager';
  if (!role) { err.textContent = 'Please select a position/role.'; err.style.display='block'; return; }

  // Generate ID
  var newId = 'u' + Date.now();
  var today = new Date();
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var created = months[today.getMonth()] + ' ' + today.getDate() + ', ' + today.getFullYear();

  var initials = (first[0] + last[0]).toUpperCase();

  clients.push({
    id: newId, email: email, password: pw,
    name: first + ' ' + last, initials: initials,
    props: props, role: role, hub: hub,
    status: 'active', created: created
  });
  saveUsers(clients);
  users = getUsers();

  closeM('muser');
  renderUserTable();
  // Reset form
  ['mu_first','mu_last','mu_email','mu_pw','mu_pw2'].forEach(function(id){ document.getElementById(id).value=''; });
  document.querySelectorAll('#uproplist input[type=checkbox]').forEach(function(cb){ cb.checked=false; cb.closest('label').style.borderColor=''; cb.closest('label').style.background=''; });
  toast('Login created for ' + first + ' ' + last + '. Share their credentials securely.');
}

function openEditUser(uid) {
  var clients = getUsers();
  var u = null;
  for (var i = 0; i < clients.length; i++) { if (clients[i].id === uid) { u = clients[i]; break; } }
  if (!u) return;
  document.getElementById('eu_id').value    = u.id;
  var parts = u.name.split(' ');
  document.getElementById('eu_first').value = parts[0] || '';
  document.getElementById('eu_last').value  = parts.slice(1).join(' ') || '';
  document.getElementById('eu_email').value = u.email;
  document.getElementById('eu_pw').value    = '';
  document.getElementById('eu_pw2').value   = '';
  document.getElementById('eu_role').innerHTML = buildPosOptions(u.role || 'Property Manager');
  document.getElementById('eu_role').value = u.role || 'Property Manager';
  document.getElementById('eu_status').value = u.status || 'active';
  document.getElementById('eu_err').style.display = 'none';
  openM('medit');
}

function saveEditUser() {
  var uid   = document.getElementById('eu_id').value;
  var first = (document.getElementById('eu_first').value || '').trim();
  var last  = (document.getElementById('eu_last').value || '').trim();
  var email = (document.getElementById('eu_email').value || '').trim().toLowerCase();
  var pw    = document.getElementById('eu_pw').value;
  var pw2   = document.getElementById('eu_pw2').value;
  var err   = document.getElementById('eu_err');
  err.style.display = 'none';

  if (!first || !last) { err.textContent='First and last name required.'; err.style.display='block'; return; }
  if (!email || !email.includes('@')) { err.textContent='Valid email required.'; err.style.display='block'; return; }
  if (pw && pw.length < 8) { err.textContent='Password must be at least 8 characters.'; err.style.display='block'; return; }
  if (pw && pw !== pw2)    { err.textContent='Passwords do not match.'; err.style.display='block'; return; }

  var clients = getUsers();
  for (var i = 0; i < clients.length; i++) {
    if (clients[i].id === uid) {
      clients[i].name     = first + ' ' + last;
      clients[i].initials = (first[0] + last[0]).toUpperCase();
      clients[i].email    = email;
      clients[i].role     = document.getElementById('eu_role').value;
      clients[i].status   = document.getElementById('eu_status').value;
      if (pw) clients[i].password = pw;
      break;
    }
  }
  saveUsers(clients);
  users = getUsers();
  closeM('medit');
  renderUserTable();
  toast('User updated successfully.');
}

function toggleUserStatus(uid, newStatus) {
  var clients = getUsers();
  for (var i = 0; i < clients.length; i++) {
    if (clients[i].id === uid) { clients[i].status = newStatus; break; }
  }
  saveUsers(clients);
  users = getUsers();
  renderUserTable();
  toast(newStatus === 'active' ? 'Account reactivated.' : 'Account suspended.');
}

function deleteUser() {
  var uid = document.getElementById('eu_id').value;
  var name = document.getElementById('eu_first').value + ' ' + document.getElementById('eu_last').value;
  if (!confirm('Permanently delete ' + name.trim() + '? This cannot be undone.')) return;
  var clients = getUsers().filter(function(u){ return u.id !== uid; });
  saveUsers(clients);
  users = getUsers();
  closeM('medit');
  renderUserTable();
  toast('User deleted.');
}
// ── END USER MANAGEMENT ──

// ── TOAST ──
var tt;
function toast(msg) {
  var el=document.getElementById('toastEl');
  document.getElementById('toastmsg').textContent=msg;
  el.classList.add('on');
  clearTimeout(tt);
  tt=setTimeout(function(){el.classList.remove('on');},4500);
}


document.addEventListener('DOMContentLoaded', function() {
  populateAllHubDropdowns();
  if (!localStorage.getItem('pf_orders')) { saveOrders(); }
  SVC_LIST = loadServices().map(function(s){ return s.name; });
  applyNotifSettings();
});


// ── ALL ORDERS EXPORT ──

// Close export menu when clicking outside
document.addEventListener('click', function(e){
  var wrap = document.getElementById('expWrap');
  if (wrap && !wrap.contains(e.target)) {
    var menu = document.getElementById('expMenu');
    if (menu) menu.classList.remove('open');
  }
});

function toggleExpMenu(e) {
  e.stopPropagation();
  document.getElementById('expMenu').classList.toggle('open');
}

// Collect currently visible (filtered) order data from the DOM table
function getFilteredAordRows() {
  var headers = ['Work Order','Property','Hub','Unit','Service','Date','Status'];
  var rows = [];
  var tbody = document.getElementById('aord_tbody');
  if (!tbody) return {headers: headers, rows: rows};
  Array.prototype.forEach.call(tbody.querySelectorAll('tr'), function(tr) {
    var cells = tr.querySelectorAll('td');
    if (cells.length < 7) return;
    rows.push([
      cells[0].textContent.trim(),
      cells[1].textContent.trim(),
      cells[2].textContent.trim(),
      cells[3].textContent.trim(),
      cells[4].textContent.trim(),
      cells[5].textContent.trim(),
      cells[6].textContent.trim()
    ]);
  });
  return {headers: headers, rows: rows};
}

function triggerDownload(content, filename, mime) {
  var blob = new Blob([content], {type: mime});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  setTimeout(function(){ URL.revokeObjectURL(url); }, 1000);
  document.getElementById('expMenu').classList.remove('open');
}

function exportFilename(ext) {
  var d = new Date();
  var ds = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  return 'PF-Orders-'+ds+'.'+ext;
}

function exportAordCsv() {
  var data = getFilteredAordRows();
  var lines = [data.headers.map(function(h){ return '"'+h+'"'; }).join(',')];
  data.rows.forEach(function(row){
    lines.push(row.map(function(cell){ return '"'+cell.replace(/"/g,'""')+'"'; }).join(','));
  });
  triggerDownload(lines.join('\r\n'), exportFilename('csv'), 'text/csv;charset=utf-8;');
}

function exportAordTsv() {
  var data = getFilteredAordRows();
  var lines = [data.headers.join('\t')];
  data.rows.forEach(function(row){ lines.push(row.join('\t')); });
  triggerDownload(lines.join('\r\n'), exportFilename('tsv'), 'text/tab-separated-values;charset=utf-8;');
}

function exportAordJson() {
  var data = getFilteredAordRows();
  var out = data.rows.map(function(row){
    var obj = {};
    data.headers.forEach(function(h,i){ obj[h] = row[i] || ''; });
    return obj;
  });
  triggerDownload(JSON.stringify(out, null, 2), exportFilename('json'), 'application/json');
}

function exportAordXlsx() {
  if (typeof XLSX === 'undefined') {
    toast('Excel export unavailable — please check your connection and try again.');
    return;
  }
  var data = getFilteredAordRows();
  var wsData = [data.headers].concat(data.rows);
  var ws = XLSX.utils.aoa_to_sheet(wsData);
  // Column widths
  ws['!cols'] = [12,26,12,8,28,14,14].map(function(w){ return {wch:w}; });
  var wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Orders');
  XLSX.writeFile(wb, exportFilename('xlsx'));
  document.getElementById('expMenu').classList.remove('open');
}

function exportAordPrint() {
  var data = getFilteredAordRows();
  var d = new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  // Build status filter label
  var statusEl = document.getElementById('aord_status');
  var propEl   = document.getElementById('aord_prop');
  var hubEl    = document.getElementById('aord_hub');
  var statusLbl = statusEl && statusEl.value ? statusEl.options[statusEl.selectedIndex].text : 'All Statuses';
  var propLbl   = propEl   && propEl.value   ? propEl.options[propEl.selectedIndex].text     : 'All Properties';
  var hubLbl    = hubEl    && hubEl.value     ? hubEl.options[hubEl.selectedIndex].text       : 'All Hubs';
  var rowsHtml = data.rows.map(function(row, i){
    return '<tr style="background:'+(i%2===0?'#fff':'#f8f7f4')+'">'
      + row.map(function(cell){ return '<td style="padding:7px 10px;border-bottom:1px solid #e2dfd8;font-size:11px;">' + cell + '</td>'; }).join('')
      + '</tr>';
  }).join('');
  var html = '<!DOCTYPE html><html><head><title>Protective Flooring — All Orders</title>'
    + '<style>body{font-family:Arial,sans-serif;margin:32px;color:#1c1c2e;}'
    + 'h1{font-size:18px;margin:0 0 4px;}p{font-size:11px;color:#64748b;margin:0 0 16px;}'
    + 'table{width:100%;border-collapse:collapse;}th{background:#020A5B;color:#fff;padding:8px 10px;font-size:11px;text-align:left;}'
    + '.filters{display:flex;gap:16px;margin-bottom:14px;font-size:11px;color:#64748b;padding:8px 12px;background:#f8f7f4;border:1px solid #ddd9d0;border-radius:3px;}'
    + '.filters strong{color:#1c1c2e;}'
    + '</style></head><body>'
    + '<h1>&#9632; Protective Flooring — Work Orders</h1>'
    + '<p>Exported ' + d + ' &nbsp;·&nbsp; ' + data.rows.length + ' orders</p>'
    + '<div class="filters"><span>Status: <strong>'+statusLbl+'</strong></span><span>Property: <strong>'+propLbl+'</strong></span><span>Hub: <strong>'+hubLbl+'</strong></span></div>'
    + '<table><thead><tr>'
    + data.headers.map(function(h){ return '<th>'+h+'</th>'; }).join('')
    + '</tr></thead><tbody>'+rowsHtml+'</tbody></table>'
    + '</body></html>';
  var win = window.open('','_blank','width=900,height=700');
  win.document.write(html);
  win.document.close();
  win.focus();
  setTimeout(function(){ win.print(); }, 400);
  document.getElementById('expMenu').classList.remove('open');
}
</script>
</body>
</html>